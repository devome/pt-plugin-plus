Number.prototype.toRound=function(t){return(isNaN(t)||null==t||t<0)&&(t=0),window.accounting?parseFloat(accounting.toFixed(this,t)):parseFloat(parseFloat(Math.round(this*Math.pow(10,t))/Math.pow(10,t)).toFixed(t))},Number.prototype.toPercent=function(t,e){return Math.abs(this)>0?(null==e&&(e=2),(100-parseFloat((parseFloat(t)-parseFloat(this))/parseFloat(t)*100+.005)).toRound(e)+"%"):"0"};const _imageCache=[];window.album=function(t){return{options:{images:[],url:"",fileIds:"",active:"",resizeRate:5,listHeight:160,keepThumbBar:!1,maxSize:100,minSize:5,allowContextmenu:!1,allowDownload:!0,showPropColumn:!1,showTopBar:!0,showLabelBar:!0,clickImageToClose:!0,buttons:[],tags:[],defaultTag:"全部",activeTag:null,onButtonClick(){},theme:"",onClose(){}},activeItem:null,window:null,systemButtons:{left:null,right:null},allowClose:!0,shower:null,listBar:null,thumbImagesBar:null,activeImage:null,loadingBar:null,images:[],imageItems:{},listBarOffset:0,listBarWidth:0,loadedImageWidth:0,tags:{},topBarTimer:null,overTopBar:!1,theme:"",IE:!1,init(){if(console.log("this's album.js"),this.options=$.extend(this.options,t),this.options.parent?this.allowClose=!1:this.options.parent=$(document.body),this.options.theme&&(this.theme=`-${this.options.theme}`),this.parent=this.options.parent,this.window=$("<div class='album' tabindex='-1'/>").appendTo(this.parent).focus(),this.background=$(`<div class='background${this.theme}'/>`).appendTo(this.window),this.shower=$("<div class='shower'/>").appendTo(this.window),this.controlBar=$("<div class='controlbar'/>").appendTo(this.window),this.listBar=$(`<div class='listbar${this.theme}'/>`).css({height:this.options.listHeight}).appendTo(this.controlBar),this.thumbImagesBar=$("<div class='thumbimages'/>").appendTo(this.listBar),this.labelBar=$("<div class='labelbar'/>").appendTo(this.controlBar),this.label=$("<a class='label' target='_blank'/>").appendTo(this.labelBar),this.countBar=$("<span class='status-count'/>").appendTo(this.labelBar),this.zoomBar=$("<span class='zoomBar'/>").html("100%").appendTo(this.labelBar),this.systemButtons.zoomIn=$("<i class='button-zoom-in' title='放大'/>").appendTo(this.labelBar),this.systemButtons.zoomOut=$("<i class='button-zoom-out' title='缩小'/>").appendTo(this.labelBar),this.options.showLabelBar||(this.labelBar.hide(),this.listBar.css({bottom:0})),this.loadingBar=$("<div class='loading'/>").hide().appendTo(this.window),$("<img/>").attr({src:"loading.gif"}).appendTo(this.loadingBar),this.systemButtons.left=$("<div class='button-left' title='← 上一张'/>").appendTo(this.window).hide(),this.systemButtons.right=$("<div class='button-right' title='下一张 →'/>").appendTo(this.window).hide(),this.tagsBar=$("<div class='album-tags'/>").hide().appendTo(this.window),this.createTag(this.options.defaultTag,!0),this.listBarOffset=this.parent.width()/2,this.listBarWidth=this.listBar.width(),this.initSystemButtons(),this.initCustomButtons(),this.initEvents(),this.options.tags.length>0)for(let t=0;t<this.options.tags.length;t++)this.createTag(this.options.tags[t]);return this.options.images.length>0?this.initImageList(this.options.images,this.options.active):this.options.url&&this.load(this.options.url),this.options.activeTag&&this.tags[this.options.activeTag]&&this.tags[this.options.activeTag].dom.click(),this},initSystemButtons(){0!=this.options.showTopBar&&(this.topBar=$("<div class='topbar'/>").appendTo(this.window).hide(),this.systemButtons.close=$("<a class='item close' title='关闭(ESC)'/>").appendTo(this.topBar))},initCustomButtons(){if(0==this.options.buttons.length)return;this.customButtonBar=$("<div class='custom-botton-bar'/>").appendTo(this.window);const t=this;engine.create("toolbar",{parent:this.customButtonBar,items:this.options.buttons,buttonType:1,onitemclick(e){t.options.onButtonClick(e,t.activeItem)}}),this.customButtonBar.removeClass("toolbar-container"),this.customButtonBar.find("table").css("display","inline-block"),this.customButtonBar.css({top:this.listBar.offset().top-30})},remove(){this.allowClose&&(clearTimeout(this.topBarTimer),this.window.empty().remove(),this.options.onClose&&this.options.onClose())},behind(t){this.isBehind=!0,t||(t=0),this.zIndex=this.window.css("zIndex"),this.window.css("zIndex",t)},bringToFront(){this.isBehind&&(this.isBehind=!1,this.window.css("zIndex",this.zIndex))},initEvents(t=this){return this.shower.on("mousewheel DOMMouseScroll",(e=>{("mousewheel"==e.type?e.originalEvent.wheelDelta:e.originalEvent.detail)<0?t.resize(-t.options.resizeRate):t.resize(t.options.resizeRate),e.preventDefault(),e.stopPropagation()})),this.window.on("keydown",(e=>{switch(e.keyCode){case 37:case 33:t.gotoImage("prev"),e.preventDefault(),e.stopPropagation();break;case 39:case 34:t.gotoImage("next"),e.preventDefault(),e.stopPropagation();break;case 38:t.showThumbsBar(),e.preventDefault(),e.stopPropagation();break;case 40:t.hideThumbsBar(),e.preventDefault(),e.stopPropagation();break;case 27:t.remove(),e.preventDefault(),e.stopPropagation();break;case 13:t.activeItem&&t.activeItem.link&&t.label.click(),e.stopPropagation()}})).on("mousemove",(()=>{t.showTopBar()})),this.options.keepThumbBar?this.controlBar.on("mouseenter",(()=>{t.showThumbsBar()})).on("mousewheel DOMMouseScroll",(e=>{("mousewheel"==e.type?e.originalEvent.wheelDelta:e.originalEvent.detail)<0?t.gotoImage("next"):t.gotoImage("prev"),e.preventDefault(),e.stopPropagation()})):(this.controlBar.on("mouseleave",(()=>{t.hideThumbsBarTimer&&clearTimeout(t.hideThumbsBarTimer),t.hideThumbsBarTimer=setTimeout((()=>{t.hideThumbsBar()}),500)})).on("mouseenter",(()=>{t.hideThumbsBarTimer&&clearTimeout(t.hideThumbsBarTimer),t.showThumbsBar()})).on("mousewheel DOMMouseScroll",(e=>{("mousewheel"==e.type?e.originalEvent.wheelDelta:e.originalEvent.detail)<0?t.gotoImage("next"):t.gotoImage("prev"),e.preventDefault(),e.stopPropagation()})),t.hideThumbsBarTimer=setTimeout((()=>{t.hideThumbsBar()}),1e3)),this.systemButtons.left.click((()=>{t.gotoImage("prev")})).on("mouseleave",(function(){$(this).animate({opacity:.5})})).on("mouseenter",(function(){$(this).animate({opacity:1})})),this.systemButtons.right.click((()=>{t.gotoImage("next")})).on("mouseleave",(function(){$(this).animate({opacity:.5})})).on("mouseenter",(function(){$(this).animate({opacity:1})})),this.tagsBar.on("mouseleave",(function(){$(this).animate({opacity:.5})})).on("mouseenter",(function(){$(this).animate({opacity:1})})).animate({opacity:.5}),this.systemButtons.zoomIn.click((()=>{t.resize(t.options.resizeRate)})),this.systemButtons.zoomOut.click((()=>{t.resize(-t.options.resizeRate)})),this.options.showTopBar&&(this.systemButtons.close.click((()=>{t.remove()})),this.topBar.on("mouseenter mousemove",(function(){t.overTopBar=!0,$(this).addClass("over")})).on("mouseleave",(function(){t.overTopBar=!1,$(this).removeClass("over")}))),this},showTopBar(t){0!=this.options.showTopBar&&(t=t||this,clearTimeout(this.topBarTimer),this.topBarTimer=null,this.topBar.fadeIn(),this.topBarTimer=setTimeout((()=>{t.overTopBar||t.topBar.fadeOut()}),2e3))},hideThumbsBar(){const t=this;this.listBar.stop().animate({height:30,opacity:.2},(()=>{t.customButtonBar&&t.customButtonBar.css({top:t.listBar.offset().top-30})}))},showThumbsBar(){const t=this;this.listBar.stop().animate({height:this.options.listHeight,opacity:.8},(()=>{t.customButtonBar&&t.customButtonBar.css({top:t.listBar.offset().top-30})}))},load(){const t=this;let e={url:"",type:"POST",data:null,active:""};return 2==arguments.length?(e.url=arguments[0],e.data=arguments[1]):1==arguments.length&&("string"==typeof arguments[0]?e.url=arguments[0]:e=$.extend(e,arguments[0])),$.ajax({url:e.url,type:e.type,data:e.data,success(i){const s=i.result;if(s)return 0!=s.length&&void t.initImageList(s,e.active);alert("错误")}}),this},addItem(t,e){const i=this;let s={rate:100,index:this.images.length,albumObject:this,tags:"",fileId:""};"string"==typeof t?s.url=t:(delete t.index,t.isloaded=!1,s=$.extend(s,t)),s.key||(s.key=s.url),s.thumb||(s.thumb=s.url),e||(this.tags[this.options.defaultTag].items.push(s),this.tags[this.options.defaultTag].dom.html(`${this.options.defaultTag} (${this.tags[this.options.defaultTag].items.length})`),s.tags&&(this.tagsBar.show(),this.addTag(s))),this.loadImage(s.thumb,(t=>{i.loadedImageWidth+=t.width+10,i.loadedImageWidth>=i.listBarWidth&&(i.listBarWidth+=t.width+10,i.listBar.width(i.listBarWidth))})),s.image=$("<img class='album-item'/>").attr({src:s.thumb,key:s.key,title:s.title,tags:Array.isArray(s.tags)?s.tags.join(","):s.tags}).css({"max-height":this.options.listHeight-10}).click((function(){i.setActive(this.getAttribute("key"))})).appendTo(this.thumbImagesBar),this.images.push(s),this.imageItems[s.key]=s},addTag(t){let e=[];if("string"==typeof t.tags)e.push(t.tags);else{if(!Array.isArray(t.tags))return;e=t.tags}for(const i of e){let e=this.tags[i];e||(e=this.createTag(i)),e.items.push(t),e.dom.html(`${i} (${e.items.length})`)}},createTag(t,e){const i=this,s={name:t,items:[],dom:$("<a class='album-tag'/>").attr({href:"javascript:void(0);",tag:t}).html(t).click((function(){i.lastActiveTag&&i.lastActiveTag.removeClass("album-active");const t=this.getAttribute("tag");$(this).addClass("album-active"),i.initImageList(i.tags[t].items,null,!0),i.lastActiveTag=$(this)})).appendTo(this.tagsBar)};return e&&(s.dom.addClass("album-active"),this.lastActiveTag=s.dom),this.tags[t]=s,s},initImageList(t,e,i){if(this.thumbImagesBar.empty(),t=t||this.images,this.images=[],this.imageItems={},this.activeItem=null,0!=t.length){for(let e=0;e<t.length;e++)this.addItem(t[e],i);return e?this.setActive(e,!0):this.setActive(this.images[0].key,!0),1==t.length&&this.listBar.hide(),this}},clear(){this.thumbImagesBar.empty(),this.images=[],this.imageItems={},this.activeItem=null,this.activeImage.hide()},setActive(t,e){this.bringToFront();const i=this.imageItems[t];if(!i)return;const s=this;if(this.activeItem){if(this.activeItem.key==t)return;this.activeItem.rate=100,this.activeItem.image.removeClass("active")}this.activeImage||(this.activeImage=$("<img class='activeImage'/>").css({width:100,position:"absolute"}).appendTo(this.shower),this.options.clickImageToClose&&this.activeImage.click((()=>{s.remove()})),this.options.allowContextmenu||this.activeImage.on("contextmenu",(t=>{t.preventDefault(),t.stopPropagation()}))),i.image.addClass("active"),this.label.html(i.title),i.link?this.label.attr("href",i.link):this.label.removeAttr("href"),this.countBar.html(`${i.index+1}/${this.images.length}`),this.activeItem=i;const a=this.listBarOffset-i.image.position().left-i.image.width()/2;if(this.thumbImagesBar.css({left:a}),i.isloaded||i.url==i.thumb)if(i.url==i.thumb){const t=new Image;t.onload=function(){s.loadingBar.fadeOut(),s.activeItem.isloaded=!0,s.activeItem.width=this.width,s.activeItem.height=this.height,s.setActiveImage(e)},t.src=i.url}else this.setActiveImage(e);else this.loadingBar.show(),this.activeImage.hide(),this.loadImage(i.url,(t=>{s.loadingBar.fadeOut(),s.activeItem.isloaded=!0,s.activeItem.width=t.width,s.activeItem.height=t.height,s.setActiveImage(e)}))},_setActiveImage(t){const e=this.activeItem;this.activeImage.hide().attr({src:e.url,fileId:e.fileId});const i={width:this.window.width(),height:this.window.height()};this.options.keepThumbBar&&(i.height-=this.options.listHeight);const s=parseInt(i.width.toPercent(e.width)),a=parseInt(i.height.toPercent(e.height));let o=Math.min(s,a);o>this.options.maxSize&&(o=this.options.maxSize),this.activeItem.rate=o,this.setSize(),this.systemButtons.left.show(),this.systemButtons.right.show(),this.images.length>1?0==e.index?this.systemButtons.left.hide():e.index==this.images.length-1&&this.systemButtons.right.hide():(this.systemButtons.left.hide(),this.systemButtons.right.hide())},setActiveImage(t,e=this){this.setActiveImageTimer&&clearTimeout(this.setActiveImageTimer),this.setActiveImageTimer=setTimeout((()=>{e._setActiveImage(t)}),260)},resize(t){const e=this.options.minSize,i=this.options.maxSize;this.activeItem.rate||(this.activeItem.rate=100),this.activeItem.rate+=t,this.activeItem.rate<e?this.activeItem.rate=e:this.activeItem.rate>i&&(this.activeItem.rate=i),this.timer&&clearTimeout(this.timer);const s=this;this.timer=setTimeout((()=>{s.setSize()}),50)},setSize(){const t=this.activeItem.width*(this.activeItem.rate/100),e=(this.activeItem.height,this.activeItem.rate,this.listBarOffset-t/2);this.activeImage.animate({width:t,top:0,left:e,marginLeft:0,marginTop:0},50).show(),this.zoomBar.html(`${this.activeItem.rate}%`)},gotoImage(t,e){if("number"==typeof t)return void((s=this.image[t])&&this.setActive(s.key));let i=this.activeItem.index;switch(t){case"next":i++;break;case"prev":i--}var s;i<0?i=this.images.length-1:i>=this.images.length&&(i=0),(s=this.images[i])&&this.setActive(s.key)},loadImage(t,e,i){const s=_imageCache[t];if(s&&!i&&s.width>0)return e&&e(s),s;var a=new Image;return a.src=t,e&&(a.onload=function(){e(this)}),_imageCache[t]=a,a}}.init()};