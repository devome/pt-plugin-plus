!function(t,e){e.NexusPHPCommon=class{constructor(){this.siteContentMenus={},this.clientContentMenus=[],this.defaultPath=PTService.getSiteDefaultPath(),this.downloadClientType=PTService.downloadClientType,this.defaultClientOptions=PTService.getClientOptions(),this.currentURL=location.href}t(t,e){return PTService.i18n.t(t,e)}initFreeSpaceButton(){this.defaultPath&&PTService.call(PTService.action.getFreeSpace,{path:this.defaultPath,clientId:PTService.site.defaultClientId}).then((t=>{console.log("命令执行完成",t),t&&t.arguments&&PTService.addButton({title:this.t("buttons.freeSpaceTip",{path:this.defaultPath,interpolation:{escapeValue:!1}}),icon:"filter_drama",label:PTService.filters.formatSize(t.arguments["size-bytes"])})})).catch((()=>{}))}initDetailButtons(){this.addSendTorrentToDefaultClientButton(),this.addSendTorrentToClientButton(),this.addCopyTextToClipboardButton(),this.initFreeSpaceButton(),this.initCollectionButton(),this.initSayThanksButton(),document.domain.match("keepfrds.com")&&t(".pt-plugin-body").css("z-index","39")}initListButtons(t=!1){this.defaultClientOptions&&PTService.addButton({title:this.t("buttons.downloadAllTip",{name:this.defaultClientOptions.name}),icon:"get_app",label:this.t("buttons.downloadAll"),click:(e,i)=>{!t||PTService.site.passkey?this.startDownloadURLs(e,i):i("请先设置站点密钥（Passkey）。")}}),PTService.addButton({title:this.t("buttons.downloadAllToTip"),icon:"save_alt",type:PTService.buttonType.popup,label:this.t("buttons.downloadAllTo"),click:(e,i,o)=>{!t||PTService.site.passkey?this.showAllContentMenus(o.originalEvent,e,i):i(this.t("needPasskey"))},onDrop:(t,e,i,o)=>{console.log(t);let n=this.getDroperURL(t.url);console.log(n),this.showContentMenusForUrl({url:n,title:t.title,link:t.url},e.originalEvent,i,o)}}),PTService.addButton({title:this.t("buttons.copyAllToClipboardTip"),icon:"file_copy",label:this.t("buttons.copyAllToClipboard"),click:(e,i)=>{!t||PTService.site.passkey?this.getDownloadURLs().then((t=>{if(!t.length||"string"==typeof t)throw i(t),new Error("ignore");return PTService.call(PTService.action.copyTextToClipboard,t.join("\n"))})).then((t=>{console.log("命令执行完成",t),e()})).catch((()=>{i()})):i(this.t("needPasskey"))},onDrop:(e,i,o,n)=>{if(t&&!PTService.site.passkey)return void n(this.t("needPasskey"));let l=this.getDroperURL(e.url);l&&PTService.call(PTService.action.copyTextToClipboard,l).then((t=>{console.log("命令执行完成",t),o()})).catch((()=>{n()}))}}),this.checkPermissions(["downloads"]).then((()=>{this.addSaveAllTorrentFilesButton(t)})).catch((()=>{PTService.addButton({title:this.t("buttons.needAuthorizationTip"),icon:"verified_user",key:"requestPermissions",label:this.t("buttons.needAuthorization"),click:(t,e)=>{PTService.call(PTService.action.openOptions,"set-permissions"),t()}})}))}addSaveAllTorrentFilesButton(t){PTService.addButton({title:this.t("buttons.saveAllTorrentTip"),icon:"save",label:this.t("buttons.saveAllTorrent"),click:(e,i)=>{!t||PTService.site.passkey?this.getDownloadURLs().then((t=>{if(!t.length||"string"==typeof t)throw i(t),new Error("ignore");return t.map((t=>({url:t,method:PTService.site.downloadMethod})))})).then((t=>(console.log(t),PTService.call(PTService.action.addBrowserDownloads,t)))).then((t=>{console.log("命令执行完成",t),e()})).catch((t=>{console.log(t),i(t)})):i(this.t("needPasskey"))}})}checkPermissions(t){return PTService.call(PTService.action.checkPermissions,t)}sendTorrentToDefaultClient(t,e=!0){return new Promise(((i,o)=>{"string"==typeof t&&(t={url:t,title:""});let n=PTService.pathHandler.getSavePath(this.defaultPath,PTService.site);if(!1===n)return void o(this.t("userCanceled"));let l=null;e&&(l=PTService.showNotice({type:"info",timeout:2,indeterminate:!0,msg:this.t("sendingTorrent")})),PTService.call(PTService.action.sendTorrentToDefaultClient,{url:t.url,title:t.title,savePath:n,autoStart:this.defaultClientOptions.autoStart,tagIMDb:this.defaultClientOptions.tagIMDb,link:t.link,imdbId:t.imdbId}).then((t=>{console.log("命令执行完成",t),e&&PTService.showNotice(t),i(t)})).catch((t=>{o(t)})).finally((()=>{this.hideNotice(l)}))}))}hideNotice(t){t&&(t.id&&t.close?t.close():t.hide&&t.hide())}sendTorrentToClient(t,e=!0){return new Promise(((i,o)=>{if("string"==typeof t&&(t={url:t,title:""}),!t.clientId)return void o(this.t("invalidDownloadServer"));if(t.savePath=PTService.pathHandler.getSavePath(t.savePath,PTService.site),!1===t.savePath)return void o(this.t("userCanceled"));let n=null;e&&(n=PTService.showNotice({type:"info",timeout:2,indeterminate:!0,msg:this.t("sendingTorrent")})),PTService.call(PTService.action.sendTorrentToClient,t).then((t=>{console.log("命令执行完成",t),e&&PTService.showNotice(t),i(t)})).catch((t=>{o(t)})).finally((()=>{this.hideNotice(n)}))}))}downloadFromDroper(t,e){if("string"==typeof t&&(t={url:t,title:"",link:t}),t.url=this.getDroperURL(t.url),!t.url)return PTService.showNotice({msg:this.t("invalidURL")}),void e();this.sendTorrentToDefaultClient(t).then((t=>{e(t)})).catch((t=>{e(t)}))}isNexusPHP(){return"NexusPHP"==PTService.site.schema}getDroperURL(t){let e=PTService.site.url;return"/"!=e.substr(-1)&&(e+="/"),t&&"//"===t.substr(0,2)?t=`${location.protocol}${t}`:t&&"http"!==t.substr(0,4)&&("/"==t.substr(0,1)&&(t=t.substr(1)),t=`${e}${t}`),t}call(t,e){return new Promise(((i,o)=>{t===PTService.action.downloadFromDroper&&this.downloadFromDroper(e,(()=>{i()}))}))}addSendTorrentToClientButton(){PTService.addButton({title:this.t("buttons.downloadToTip"),icon:"save_alt",type:PTService.buttonType.popup,label:this.t("buttons.downloadTo"),click:(t,e,i)=>{if(!this.getDownloadURL)return void e(this.t("getDownloadURLisUndefined"));let o=this.getDownloadURL();if(!o)return void e(this.t("getDownloadURLFailed"));let n="";n=this.getTitle?this.getTitle():document.title,this.showContentMenusForUrl({url:o,title:n,link:this.currentURL,imdbId:this.getIMDbId?this.getIMDbId():null},i.originalEvent,t,e)}})}addSendTorrentToDefaultClientButton(){this.defaultClientOptions&&PTService.addButton({title:this.t("buttons.downloadToDefaultTip",{name:this.defaultClientOptions.name})+(this.defaultPath?"\n"+this.defaultPath:""),icon:"get_app",label:this.t("buttons.downloadToDefault"),click:(t,e)=>{if(!this.getDownloadURL)return void e(this.t("getDownloadURLisUndefined"));let i=this.getDownloadURL();if(!i)return void e(this.t("getDownloadURLFailed"));let o="";o=this.getTitle?this.getTitle():document.title,this.sendTorrentToDefaultClient({url:i,title:o,link:this.currentURL,imdbId:this.getIMDbId?this.getIMDbId():null}).then((()=>{t()})).catch((t=>{e(t)}))}})}addCopyTextToClipboardButton(){PTService.addButton({title:this.t("buttons.copyToClipboardTip"),icon:"file_copy",label:this.t("buttons.copyToClipboard"),click:(t,e)=>{if(!this.getDownloadURL)return void e(this.t("getDownloadURLisUndefined"));console.log(PTService.site,this.defaultPath);let i=this.getDownloadURL();i?PTService.call(PTService.action.copyTextToClipboard,i).then((e=>{console.log("命令执行完成",e),t()})).catch((t=>{e(t)})):e(this.t("getDownloadURLFailed"))}})}initCollectionButton(){PTService.call(PTService.action.getTorrentCollention,location.href).then((t=>{this.addRemoveCollectionButton(t)})).catch((()=>{this.addToCollectionButton()}))}addToCollectionButton(){PTService.removeButton("removeFromCollection"),PTService.addButton({title:this.t("buttons.addToCollection"),icon:"favorite_border",label:this.t("buttons.addToCollection"),key:"addToCollection",click:(e,i)=>{let o="";o=this.getTitle?this.getTitle():PTService.getFieldValue("title"),o||(o=t("title:first").text());let n=PTService.getFieldValue("imdbId");if(!n){const e=t("a[href*='www.imdb.com/title/']:first");if(e.length>0){let t=e.attr("href").match(/(tt\d+)/);t&&t.length>=2&&(n=t[1])}}let l=PTService.getFieldValue("doubanId");if(!l){const e=t("a[href*='movie.douban.com/subject/']:first");if(e.length>0){let t=e.attr("href").match(/subject\/(\d+)/);t&&t.length>=2&&(l=t[1])}}const s={title:o,url:this.getDownloadURL(),link:location.href,host:location.host,size:PTService.getFieldValue("size"),subTitle:PTService.getFieldValue("subTitle"),movieInfo:{imdbId:n,doubanId:l}};PTService.call(PTService.action.addTorrentToCollection,s).then((t=>{e(),setTimeout((()=>{this.addRemoveCollectionButton(s)}),1e3)})).catch((()=>{i()}))}})}addRemoveCollectionButton(t){PTService.removeButton("addToCollection"),PTService.addButton({title:this.t("buttons.removeFromCollection"),icon:"favorite",label:this.t("buttons.removeFromCollection"),key:"removeFromCollection",click:(e,i)=>{PTService.call(PTService.action.deleteTorrentFromCollention,t).then((t=>{e(),setTimeout((()=>{this.addToCollectionButton()}),1e3)})).catch((()=>{i()}))}})}getContentMenusForUrl(t){let e=PTService.filters.parseURL(t);if(!e.host)return[];let i=[],o=[],n=PTService.getSiteFromHost(e.host);if(!n)return[];let l=n.host;if(this.siteContentMenus[l])return this.siteContentMenus[l];function s(t,e){t.forEach((t=>{i.push({client:e,path:t,host:l})}))}return PTService.options.clients.forEach((t=>{if(o.push({client:t,path:"",host:l}),t.paths){for(const e in t.paths){let i=t.paths[l];e===l&&s(i,t)}let e=t.paths[PTService.allSiteKey];e&&(i.length>0&&i.push({}),s(e,t))}})),i.length>0&&o.splice(0,0,{}),i=i.concat(o),this.siteContentMenus[l]=i,i}showContentMenusForUrl(e,i,o,n){let l=this.getContentMenusForUrl(e.url),s=[];l.forEach((t=>{t&&t.client&&t.client.name&&(!1!==t.client.enabled?t.client&&t.client.name?s.push({title:this.t("buttons.menuDownloadTo",{server:`${t.client.name} -> ${t.client.address}`})+(t.path?` -> ${PTService.pathHandler.replacePathKey(t.path,PTService.site)}`:""),fn:()=>{e.url&&this.sendTorrentToClient({clientId:t.client.id,url:e.url,title:e.title,savePath:t.path,autoStart:t.client.autoStart,tagIMDb:t.client.tagIMDb,link:e.link,imdbId:e.imdbId}).then((t=>{o()})).catch((t=>{n(t)}))}}):s.push({}):console.log(`skip disable client: ${t.client.name}`))})),console.log(l,s),basicContext.show(s,i),t(".basicContext").css({left:"-=20px",top:"+=10px"})}checkSize(t){if(!PTService.options.needConfirmWhenExceedSize)return!0;let e=this.getTotalSize(t),i=0;switch(PTService.options.exceedSizeUnit){case PTService.sizeUnit.MiB:i=1048576*PTService.options.exceedSize;break;case PTService.sizeUnit.GiB:i=1073741824*PTService.options.exceedSize;break;case"T":case PTService.sizeUnit.TiB:i=1099511627776*PTService.options.exceedSize}return!(e>=i)||PTService.filters.formatSize(e)}getTotalSize(e){let i=0;return t.each(e,((e,o)=>{i+=this.getSize(t(o).text())})),i}getSize(t){if("number"==typeof t)return t;let e=t.match(/^(\d*\.?\d+)(.*[^TGMK])?([TGMK](B|iB){0,1})$/i);if(e){let t=parseFloat(e[1]),i=e[3];switch(!0){case/Ti?B?/i.test(i):return t*Math.pow(2,40);case/Gi?B?/i.test(i):return t*Math.pow(2,30);case/Mi?B?/i.test(i):return t*Math.pow(2,20);case/Ki?B?/i.test(i):return t*Math.pow(2,10);default:return t}}return 0}confirmSize(t){let e=this.checkSize(t);if(!0!==e){let t=this.t("exceedSizeConfirm",{size:e,exceedSize:PTService.options.exceedSize,exceedSizeUnit:PTService.options.exceedSizeUnit});if(!confirm(t))return!1}return!0}startDownloadURLs(t,e,i){!this.confirmWhenExceedSize||this.confirmWhenExceedSize()?this.getDownloadURLs?this.getDownloadURLs().then((o=>{if(!o.length||"string"==typeof o)throw e(o),new Error("ignore");PTService.options.enableBackgroundDownload?this.downloadURLsInBackground(o,(e=>{t({msg:e})}),i):this.downloadURLs(o,o.length,(e=>{t({msg:e})}),i)})).catch(console.error):e(this.t("getDownloadURLsisUndefined")):e(this.t("exceedSizeCanceled"))}downloadURLsInBackground(t,e,i){const o=[],n=i?PTService.pathHandler.getSavePath(i.savePath||i.path,PTService.site):"";t.forEach((t=>{i?o.push({clientId:i.client.id,url:t,savePath:n,autoStart:i.client.autoStart,tagIMDb:i.client.tagIMDb}):o.push({url:t})})),PTService.call(PTService.action.sendTorrentsInBackground,o).then((t=>{e(t)})).catch((t=>{e(t)}))}downloadURLs(e,i,o,n){let l=i-e.length,s=e.shift();if(!s)return t(this.statusBar).remove(),this.statusBar=null,void o(this.t("downloadURLsFinished",{count:i}));this.showStatusMessage(this.t("downloadURLsTip",{text:s.replace(PTService.site.passkey,"***")+"("+(i-l)+"/"+i+")"})),n?this.sendTorrentToClient({clientId:n.client.id,url:s,title:"",savePath:n.path,autoStart:n.client.autoStart,tagIMDb:n.client.tagIMDb,imdbId:n.imdbId},!1).finally((()=>{PTService.options.batchDownloadInterval>0?setTimeout((()=>{this.downloadURLs(e,i,o,n)}),1e3*PTService.options.batchDownloadInterval):this.downloadURLs(e,i,o,n)})).catch((t=>{console.log(t)})):this.sendTorrentToDefaultClient(s,!1).then((t=>{this.downloadURLs(e,i,o)})).catch((t=>{this.downloadURLs(e,i,o)}))}showStatusMessage(t,e=600){this.statusBar?this.statusBar.find(".noticejs-content").html(t):this.statusBar=PTService.showNotice({text:t,type:"info",width:e,progressBar:!1})}clone(t){return JSON.parse(JSON.stringify(t))}showAllContentMenus(e,i,o){let n=[],l=[],s=this;function r(t){let e=s.t("buttons.menuDownloadTo",{server:`${t.client.name} -> ${t.client.address}`});t.path&&(e+=` -> ${PTService.pathHandler.replacePathKey(t.path,PTService.site)}`),l.push({title:e,fn:()=>{let e=PPF.clone(t);console.log(t);let n=PTService.pathHandler.getSavePath(e.path,PTService.site);!1!==n?(e.path=n,s.startDownloadURLs(i,o,e)):o(s.t("userCanceled"))}})}0==this.clientContentMenus.length?(PTService.options.clients.forEach((t=>{n.push({client:t,path:""})})),n.forEach((t=>{if(t&&t.client&&t.client.name)if(!1!==t.client.enabled)if(t.client&&t.client.name){if(r(t),t.client.paths){let e=t.client.paths[PTService.allSiteKey];e&&e.forEach((e=>{let i=this.clone(t);i.path=e,r(i)}))}}else l.push({});else console.log(`skip disable client: ${t.client.name}`)})),this.clientContentMenus=l):l=this.clientContentMenus,basicContext.show(l,e),t(".basicContext").css({left:"-=20px",top:"+=10px"})}getFullURL(t){return t?("//"===t.substr(0,2)?t=`${location.protocol}${t}`:"/"===t.substr(0,1)?t=`${location.origin}${t}`:"http"!==t.substr(0,4)&&(t=`${location.origin}/${t}`),t):""}initSayThanksButton(){let t=PTService.getFieldValue("sayThanksButton");console.log("sayThanksButton"),t&&t.length&&PTService.addButton({title:this.t("buttons.sayThanksTip"),icon:"thumb_up",label:this.t("buttons.sayThanks"),key:"sayThanks",click:(e,i)=>{t.click(),e(),setTimeout((()=>{PTService.removeButton("sayThanks")}),1e3)}})}async sleep(t){return new Promise((e=>setTimeout((()=>e()),t)))}}}(jQuery,window);