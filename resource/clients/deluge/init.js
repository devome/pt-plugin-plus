!function(t){window.deluge=class{init(t){if(this.options=t,this.requestCount=-1,-1==this.options.address.indexOf("/json")){let t=PTServiceFilters.parseURL(this.options.address),e=[t.protocol,"://",t.host];t.port&&e.push(`:${t.port}`),e.push(t.path),"/"!=t.path.substr(-1)&&e.push("/"),e.push("json"),this.options.address=e.join("")}console.log("Deluge.init",this.options.address)}call(t,e){return console.log("Deluge.call",t,e),new Promise(((o,s)=>{switch(t){case"addTorrentFromURL":this.addTorrentFromUrl(e,(t=>{o(t)}),e.upLoadLimit);break;case"testClientConnectivity":this.getSessionId().then((t=>{o(""!=t)})).catch((t=>{s(t)}))}}))}getSessionId(e){return new Promise(((o,s)=>{var n={id:++this.requestCount,method:"auth.login",params:[this.options.loginPwd]};t.ajax({type:"POST",url:this.options.address,dataType:"json",contentType:"application/json",data:JSON.stringify(n),timeout:PTBackgroundService.options.connectClientTimeout}).done(((t,s)=>{this.isInitialized=!0,e&&e(t),o(this.token)})).fail(((t,e)=>{let o={status:e||"error",code:t.status,msg:"timeout"===e?i18n.t("downloadClient.timeout"):i18n.t("downloadClient.unknownError")};switch(t.status){case 0:o.msg=i18n.t("downloadClient.serverIsUnavailable");break;case 401:o.msg=i18n.t("downloadClient.serverConnectionFailed");break;case 404:o.msg=i18n.t("downloadClient.notFound")}s(o)}))}))}exec(e,o,s){var n={id:++this.requestCount};t.extend(n,e);var i={type:"POST",url:this.options.address,data:JSON.stringify(n),contentType:"application/json",timeout:PTBackgroundService.options.connectClientTimeout,success:(t,n)=>{t&&t.error&&1==t.error.code?this.getSessionId().then((()=>{this.exec(e,o,s)})).catch((t=>{o&&o(t)})):o&&o(t,s)},error:(t,n,i)=>{console.log(t),this.getSessionId().then((()=>{this.exec(e,o,s)})).catch((t=>{o&&o(t)}))}};t.ajax(i)}addTorrentFromUrl(t,e,o=0){let s=t.url,n={download_location:t.savePath,max_upload_speed:o&&o>0?parseInt(o):void 0};s.startsWith("magnet:")?this.addTorrent({method:"core.add_torrent_url",params:[s,n]},e):PTBackgroundService.requestMessage({action:"getTorrentDataFromURL",data:s}).then((t=>{var o=new FileReader;o.onload=t=>{var o=t.target.result,s=o.indexOf("base64,");if(-1!=s){var i=o.substring(s+7);this.addTorrent({method:"core.add_torrent_file",params:["",i,n]},e)}},o.readAsDataURL(t)})).catch((t=>{e&&e(t)}))}addTorrent(t,e){this.exec(t,(t=>{if(e){var o=t;!t.error&&t.result&&(o.status="success",o.msg=i18n.t("downloadClient.addURLSuccess",{name:this.options.name})),e(o)}console.log(t)}))}}}(jQuery,window);