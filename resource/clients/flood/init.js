!function(t){window.flood=class{init(t){this.options=t;let e=PTServiceFilters.parseURL(this.options.address),s=[e.protocol,"://",e.host];e.port&&s.push(`:${e.port}`),s.push(e.path),"/"!==e.path.substr(-1)&&s.push("/"),this.options.address=s.join(""),console.log("Flood.init",this.options.address)}call(t,e){return console.log("Flood.call",t,e),new Promise(((s,o)=>{switch(t){case"addTorrentFromURL":this.addTorrentFromUrl(e,(t=>{"success"===t.status?s(t):o(t)}));break;case"testClientConnectivity":this.testClientConnectivity().then((t=>{s(!0)})).catch(((t,e)=>{o({status:"error",code:t,msg:e})}))}}))}authenticate(e){let s=this.options;t.ajax({type:"POST",url:s.address+"api/auth/authenticate",contentType:"application/json",data:JSON.stringify({username:s.loginName,password:s.loginPwd}),success:function(t,s){console.log(t),t.success&&(console.log(t.token),e&&"function"==typeof e&&e(t))}})}testClientConnectivity(e){let s=this;return new Promise(((o,n)=>{this.authenticate((function(i){t.ajax({type:"GET",url:s.options.address+"api/client/connection-test",timeout:PTBackgroundService.options.connectClientTimeout}).done(((t,n,i)=>{t.isConnected&&(s.isInitialized=!0,e&&e(t),o())})).fail(((t,e,s)=>{n(t.status,e)}))}))}))}addTorrentFromUrl(t,e){let s=t.url,o={destination:t.savePath||"",isBasePath:!1,start:!t.autoStart,tag:[]};if(s.startsWith("magnet:"))return o.urls=[s],void this.addTorrentUrl(o,e);PTBackgroundService.requestMessage({action:"getTorrentDataFromURL",data:s}).then((t=>{(new FileReader).onload=t=>{var s=t.target.result,n=s.indexOf("base64,");if(-1!=n){var i=s.substring(n+7);o.files=[i],this.addTorrentFile(o,e)}}})).catch((t=>{e&&e(t)}))}addTorrentUrl(t,e){this.addTorrent("api/torrents/add-urls",t,e)}addTorrentFile(t,e){this.addTorrent("api/torrents/add-files",t,e)}addTorrent(e,s,o){let n=this.options;this.authenticate((function(){t.ajax({type:"POST",url:n.address+e,timeout:PTBackgroundService.options.connectClientTimeout,data:s,contentType:!1,processData:!1,success:(t,e)=>{if(o){var s=Object.assign({status:"success",msg:i18n.t("downloadClient.addURLSuccess",{name:n.name})},t);o(s)}}})}))}}}(jQuery,window);