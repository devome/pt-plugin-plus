!function(t,e){e.utorrent=class{init(t){if(this.options=t,this.headers=[],this.token="",t.loginName&&t.loginPwd&&(this.headers.Authorization="Basic "+(new Base64).encode(t.loginName+":"+t.loginPwd)),-1==this.options.address.indexOf("gui")){let t=PTServiceFilters.parseURL(this.options.address),e=[t.protocol,"://",t.host];t.port&&e.push(`:${t.port}`),e.push(t.path),"/"!=t.path.substr(-1)&&e.push("/"),e.push("gui/"),this.options.address=e.join("")}console.log("uTorrent.init",this.options.address)}call(t,e){return console.log("uTorrent.call",t,e),new Promise(((s,o)=>{switch(t){case"addTorrentFromURL":this.addTorrentFromUrl(e,(t=>{s(t)}));break;case"testClientConnectivity":this.getSessionId().then((t=>{s(""!=t)})).catch((t=>{o(t)}))}}))}getSessionId(e){return new Promise(((s,o)=>{t.ajax({type:"GET",url:this.options.address+"token.html?t=",headers:this.headers,timeout:PTBackgroundService.options.connectClientTimeout}).done((o=>{console.log(o),this.token=t(o).html(),this.isInitialized=!0,e&&e(this.token),s(this.token)})).fail(((t,e)=>{let s={status:e||"error",code:t.status,msg:"timeout"===e?i18n.t("downloadClient.timeout"):i18n.t("downloadClient.unknownError")};switch(t.status){case 0:s.msg=i18n.t("downloadClient.serverIsUnavailable");break;case 401:s.msg=i18n.t("downloadClient.permissionDenied");break;case 404:s.msg=i18n.t("downloadClient.notFound")}o(s)}))}))}exec(e,s,o){if(this.token){var n={},i=t.extend({method:"GET",processData:void 0,contentType:void 0,queryString:""},e.settings);e.settings&&delete e.settings,e.formData?n=e.formData:t.extend(n,e);var a={type:i.method,url:this.options.address+"?token="+this.token+i.queryString,dataType:"json",processData:i.processData,contentType:i.contentType,data:n,timeout:PTBackgroundService.options.connectClientTimeout,success:(t,e)=>{s&&s(t,o)},error:(t,n,i)=>{console.log(t),this.getSessionId().then((()=>{this.exec(e,s,o)})).catch((t=>{s&&s(t)}))},headers:this.headers};t.ajax(a)}else this.getSessionId().then((()=>{this.exec(e,s,o)})).catch((t=>{s&&s(t)}))}addTorrentFromUrl(t,e){let s=t.url;s.startsWith("magnet:")?this.addTorrent({action:"add-url",s:s,download_dir:0,path:t.savePath?t.savePath:""},e):PTBackgroundService.requestMessage({action:"getTorrentDataFromURL",data:s}).then((s=>{let o=new FormData;o.append("torrent_file",s,"file.torrent"),this.addTorrent({settings:{method:"POST",processData:!1,contentType:!1,queryString:"&action=add-file&download_dir=0&path="+(t.savePath?t.savePath:"")},formData:o},e)})).catch((t=>{e&&e(t)}))}addTorrent(t,e){this.exec(t,(t=>{if(e){var s=t;t.build&&(s.status="success",s.msg=s.msg=i18n.t("downloadClient.addURLSuccess",{name:this.options.name})),e(s)}console.log(t)}))}}}(jQuery,window);