!function(t){window.qbittorrent=class{init(t){this.options=t,this.headers={},this.sessionId="","/"==this.options.address.substr(-1)&&(this.options.address=this.options.address.substr(0,this.options.address.length-1)),console.log("qBittorrent.init",this.options.address)}call(t,e){return console.log("qBittorrent.call",t,e),new Promise(((s,o)=>{switch(t){case"addTorrentFromURL":this.addTorrentFromUrl(e,(t=>{"success"===t.status?s(t):o(t)}));break;case"testClientConnectivity":this.getSessionId().then((t=>{s(!0)})).catch(((t,e)=>{o({status:"error",code:t,msg:e})}))}}))}getSessionId(e){return new Promise(((s,o)=>{var n={username:this.options.loginName,password:this.options.loginPwd},a={type:"POST",url:this.options.address+"/api/v2/auth/login",data:n,timeout:PTBackgroundService.options.connectClientTimeout};t.ajax(a).done(((t,o,n)=>{this.isInitialized=!0,e&&e(t),s(),console.log(this.sessionId)})).fail(((t,e,s)=>{o(t.status,e)}))}))}exec(e,s,o){var n={type:"POST",processData:!1,contentType:!1,method:"POST",url:this.options.address+e.method,data:e.params,timeout:PTBackgroundService.options.connectClientTimeout,success:(t,e)=>{s&&s(t,o)},error:(t,n,a)=>{console.log("exec failed",t.status,n,a);let i={status:"error",code:t.status,msg:""};switch(t.status){case 415:i.msg=i18n.t("downloadClient.unsupportedMediaType");break;case 502:i.msg=i18n.t("downloadClient.serverIsUnavailable")}console.log(t),i.msg?s(i):this.getSessionId().then((()=>{this.exec(e,s,o)})).catch(((t,e)=>{console.log(`getSessionId failed: ${t}, ${e}`),i.code=t,i.msg=403===t?i18n.t("downloadClient.permissionDenied"):t>=500&&t<600?i18n.t("downloadClient.serverIsUnavailable"):e||i18n.t("downloadClient.unknownError"),s(i)}))}};t.ajax(n)}addTorrentFromUrl(t,e){let s,o,n=new FormData,{savePath:a,category:i,clientOptions:r,siteConfig:d}=t,l=[t.imdbId];if(a?(n.append("savepath",t.savePath),s=!1):a="_",r&&r.enableCategory&&(o=r.qbCategories,o&&o.length>0)){let t=o.find((t=>t.path===a));t?(i=t.name,s=!0):s=!1}if(r&&d){if(r.hostnameAsTag){let t=new URL(d.activeURL).hostname.split(".");t.pop(),l.push(t.pop())}r.siteNameAsTag&&l.push(d.name)}l=l.filter((t=>!!t)).map((t=>t.toLowerCase())).join(","),void 0!==s&&n.append("autoTMM",s),null!=i&&n.append("category",i),null!=t.autoStart&&n.append("paused",!t.autoStart),l&&n.append("tags",l),t.upLoadLimit&&t.upLoadLimit>0&&n.append("upLimit",1024*t.upLoadLimit);let c=t.url;c.startsWith("magnet:")?(n.append("urls",c),this.addTorrent(n,e)):PTBackgroundService.requestMessage({action:"getTorrentDataFromURL",data:c}).then((t=>{n.append("torrents",t,"file.torrent"),this.addTorrent(n,e)})).catch((t=>{e&&e(t)}))}addTorrent(t,e){this.exec({method:"/api/v2/torrents/add",params:t},(t=>{let s;switch(console.log(`/api/v2/torrents/add: ${t}`),typeof t){case"object":s=Object.assign({status:"",msg:""},t),!t.error&&t.result&&(s={status:"success",msg:i18n.t("downloadClient.addURLSuccess",{name:e})});break;case"string":let{name:e}=this.options;"Ok."===t?s={status:"success",msg:i18n.t("downloadClient.addURLSuccess",{name:e})}:"Fails."===t?s={status:"error",msg:i18n.t("downloadClient.duplicate",{name:e})}:(console.log(`unknown result: ${t}`),s={status:"error",msg:`${i18n.t("downloadClient.unknownError")} -> ${t}`});break;default:console.log(`unknown result: ${t}`),s={status:"error",msg:`${i18n.t("downloadClient.unknownError")} -> ${t}`}}e&&e(s)}))}}}(jQuery,window);