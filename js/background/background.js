!function(e){function t(t){for(var i,n,a=t[0],c=t[1],h=t[2],u=0,d=[];u<a.length;u++)n=a[u],Object.prototype.hasOwnProperty.call(r,n)&&r[n]&&d.push(r[n][0]),r[n]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(e[i]=c[i]);for(l&&l(t);d.length;)d.shift()();return o.push.apply(o,h||[]),s()}function s(){for(var e,t=0;t<o.length;t++){for(var s=o[t],i=!0,a=1;a<s.length;a++){var c=s[a];0!==r[c]&&(i=!1)}i&&(o.splice(t--,1),e=n(n.s=s[0]))}return e}var i={},r={0:0},o=[];function n(t){if(i[t])return i[t].exports;var s=i[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=i,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="";var a=window.webpackJsonp=window.webpackJsonp||[],c=a.push.bind(a);a.push=t,a=a.slice();for(var h=0;h<a.length;h++)t(a[h]);var l=c;o.push([374,1]),s()}({0:function(e,t,s){"use strict";var i,r,o,n,a,c,h,l,u,d,p,g,_,m,f,v,y,b,E,P,D,w,S,T,M,C,O,I,k,U;s.d(t,"t",(function(){return i})),s.d(t,"p",(function(){return r})),s.d(t,"o",(function(){return o})),s.d(t,"h",(function(){return n})),s.d(t,"n",(function(){return c})),s.d(t,"b",(function(){return h})),s.d(t,"u",(function(){return l})),s.d(t,"f",(function(){return u})),s.d(t,"g",(function(){return d})),s.d(t,"l",(function(){return p})),s.d(t,"k",(function(){return g})),s.d(t,"v",(function(){return f})),s.d(t,"w",(function(){return v})),s.d(t,"e",(function(){return y})),s.d(t,"j",(function(){return b})),s.d(t,"d",(function(){return E})),s.d(t,"c",(function(){return D})),s.d(t,"m",(function(){return w})),s.d(t,"x",(function(){return S})),s.d(t,"q",(function(){return O})),s.d(t,"r",(function(){return I})),s.d(t,"i",(function(){return k})),s.d(t,"s",(function(){return U})),s.d(t,"a",(function(){return R})),function(e){e.ZiB="ZiB",e.EiB="EiB",e.PiB="PiB",e.TiB="TiB",e.GiB="GiB",e.MiB="MiB",e.KiB="KiB"}(i||(i={})),function(e){e.JSON="json",e.TEXT="urlencode"}(r||(r={})),function(e){e.JSON="json",e.XML="xml",e.HTML="html",e.TEXT="text"}(o||(o={})),function(e){e.transmission="transmission",e.utorrent="utorrent",e.deluge="deluge",e.synologyDownloadStation="synologyDownloadStation",e.rutorrent="rutorrent",e.qbittorrent="qbittorrent"}(n||(n={})),function(e){e.normal="normal",e.label="label",e.spliter="spliter",e.popup="popup"}(a||(a={})),function(e){e.POST="POST",e.GET="GET"}(c||(c={})),function(e){e.readConfig="readConfig",e.saveConfig="saveConfig",e.reloadConfig="reloadConfig",e.sendTorrentToDefaultClient="sendTorrentToDefaultClient",e.sendTorrentToClient="sendTorrentToClient",e.searchTorrent="searchTorrent",e.copyTextToClipboard="copyTextToClipboard",e.addTorrentFromURL="addTorrentFromURL",e.getFreeSpace="getFreeSpace",e.downloadFromDroper="downloadFromDroper",e.openOptions="openOptions",e.updateOptionsTabId="updateOptionsTabId",e.getSearchResult="getSearchResult",e.getDownloadHistory="getDownloadHistory",e.removeDownloadHistory="removeDownloadHistory",e.clearDownloadHistory="clearDownloadHistory",e.testClientConnectivity="testClientConnectivity",e.getSystemLogs="getSystemLogs",e.removeSystemLogs="removeSystemLogs",e.clearSystemLogs="clearSystemLogs",e.readUIOptions="readUIOptions",e.saveUIOptions="saveUIOptions",e.showMessage="showMessage",e.writeLog="writeLog",e.serviceStoped="serviceStoped",e.addContentPage="addContentPage",e.abortSearch="abortSearch",e.backupToGoogle="backupToGoogle",e.restoreFromGoogle="restoreFromGoogle",e.clearFromGoogle="clearFromGoogle",e.getTorrentDataFromURL="getTorrentDataFromURL",e.getUserInfo="getUserInfo",e.abortGetUserInfo="abortGetUserInfo",e.refreshUserData="refreshUserData",e.getClearedOptions="getClearedOptions",e.resetRunTimeOptions="resetRunTimeOptions",e.getBase64FromImageUrl="getBase64FromImageUrl",e.getUserHistoryData="getUserHistoryData",e.getMovieInfos="getMovieInfos",e.getMovieRatings="getMovieRatings",e.getIMDbIdFromDouban="getIMDbIdFromDouban",e.queryMovieInfoFromDouban="queryMovieInfoFromDouban",e.addBrowserDownloads="addBrowserDownloads",e.checkPermissions="checkPermissions",e.requestPermissions="requestPermissions",e.changeLanguage="changeLanguage",e.getCurrentLanguageResource="getCurrentLanguageResource",e.addLanguage="addLanguage",e.replaceLanguage="replaceLanguage",e.hideMessage="hideMessage",e.resetUserDatas="resetUserDatas",e.backupToServer="backupToServer",e.restoreFromServer="restoreFromServer",e.getBackupListFromServer="getBackupListFromServer",e.deleteFileFromBackupServer="deleteFileFromBackupServer",e.sendTorrentsInBackground="sendTorrentsInBackground",e.createBackupFile="createBackupFile",e.checkBackupData="checkBackupData",e.addTorrentToCollection="addTorrentToCollection",e.getTorrentCollections="getTorrentCollections",e.deleteTorrentFromCollention="deleteTorrentFromCollention",e.clearTorrentCollention="clearTorrentCollention",e.getTorrentCollention="getTorrentCollention",e.getSiteSelectorConfig="getSiteSelectorConfig",e.resetTorrentCollections="resetTorrentCollections",e.getTorrentCollectionGroups="getTorrentCollectionGroups",e.addTorrentCollectionGroup="addTorrentCollectionGroup",e.addTorrentCollectionToGroup="addTorrentCollectionToGroup",e.updateTorrentCollectionGroup="updateTorrentCollectionGroup",e.removeTorrentCollectionFromGroup="removeTorrentCollectionFromGroup",e.removeTorrentCollectionGroup="removeTorrentCollectionGroup",e.updateTorrentCollention="updateTorrentCollention",e.getAllTorrentCollectionLinks="getAllTorrentCollectionLinks",e.restoreCookies="restoreCookies",e.resetFavicons="resetFavicons",e.resetFavicon="resetFavicon",e.getBackupRawData="getBackupRawData",e.testBackupServerConnectivity="testBackupServerConnectivity",e.createSearchResultSnapshot="createSearchResultSnapshot",e.loadSearchResultSnapshot="loadSearchResultSnapshot",e.getSearchResultSnapshot="getSearchResultSnapshot",e.removeSearchResultSnapshot="removeSearchResultSnapshot",e.clearSearchResultSnapshot="clearSearchResultSnapshot",e.resetSearchResultSnapshot="resetSearchResultSnapshot",e.createKeepUploadTask="createKeepUploadTask",e.loadKeepUploadTask="loadKeepUploadTask",e.getKeepUploadTask="getKeepUploadTask",e.removeKeepUploadTask="removeKeepUploadTask",e.clearKeepUploadTask="clearKeepUploadTask",e.resetKeepUploadTask="resetKeepUploadTask",e.updateKeepUploadTask="updateKeepUploadTask",e.resetDownloadHistory="resetDownloadHistory",e.pushDebugMsg="pushDebugMsg",e.updateDebuggerTabId="updateDebuggerTabId",e.getTopSearches="getTopSearches"}(h||(h={})),function(e){e.text="TEXT",e.json="JSON"}(l||(l={})),function(e){e.default="PT-Plugin-Plus-Config",e.downloadHistory="PT-Plugin-Plus-downloadHistory",e.systemLogs="PT-Plugin-Plus-systemLogs",e.uiOptions="PT-Plugin-Plus-uiOptions",e.cache="PT-Plugin-Plus-Cache-Contents",e.userDatas="PT-Plugin-Plus-User-Datas",e.collection="PT-Plugin-Plus-Collection",e.searchResultSnapshot="PT-Plugin-Plus-SearchResultSnapshot",e.keepUploadTask="PT-Plugin-Plus-KeepUploadTask"}(u||(u={})),function(e){e.success="success",e.error="error",e.info="info",e.warning="warning",e.unknown="unknown"}(d||(d={})),function(e){e.background="background",e.content="content",e.options="options",e.popup="popup",e.debugger="debugger"}(p||(p={})),function(e){e.init="init",e.requestMessage="requestMessage"}(g||(g={})),function(e){e.systemLogs="systemLogs",e.searchTorrent="searchTorrent"}(_||(_={})),function(e){e.home="home",e.downloadPaths="downloadPaths",e.searchTorrent="searchTorrent"}(m||(m={})),function(e){e.latest="latest",e.today="today",e.all="all"}(f||(f={})),function(e){e.needLogin="needLogin",e.notSupported="notSupported",e.unknown="unknown",e.success="success"}(v||(v={})),function(e){e.allSite="__allSite__",e.all="__all__",e.noGroup="__noGroup__"}(y||(y={})),function(e){e.development="development",e.normal="normal",e.crx="crx"}(b||(b={})),function(e){e.id="id",e.name="name"}(E||(E={})),function(e){e[e.downloading=1]="downloading",e[e.sending=2]="sending",e[e.completed=255]="completed",e[e.inactive=3]="inactive"}(P||(P={})),function(e){e.OWSS="OWSS",e.WebDAV="WebDAV"}(D||(D={})),function(e){e.left="left",e.right="right"}(w||(w={})),function(e){e.faq="https://github.com/pt-plugins/PT-Plugin-Plus/wiki/frequently-asked-questions"}(S||(S={})),function(e){e.all="all",e.options="options",e.userDatas="userDatas",e.collection="collection",e.cookies="cookies",e.searchResultSnapshot="searchResultSnapshot",e.keepUploadTask="keepUploadTask",e.downloadHistory="downloadHistory"}(T||(T={})),function(e){e.Chrome="Chrome",e.Firefox="Firefox"}(M||(M={})),function(e){e.success="success",e.error="error",e.loading="loading"}(C||(C={})),function(e){e.time="time",e.name="name",e.size="size"}(O||(O={})),function(e){e.desc="desc",e.asc="asc"}(I||(I={})),function(e){e.AES="AES"}(k||(k={})),function(e){e.needSecretKey="needSecretKey",e.errorSecretKey="errorSecretKey"}(U||(U={}));const R={Free:"blue","2xFree":"green","2xUp":"lime","2x50%":"light-green","25%":"purple","30%":"indigo","35%":"indigo darken-3","50%":"orange","70%":"blue-grey","75%":"lime darken-3",VIP:"orange darken-2","\u26d4\ufe0f":"deep-orange darken-1"}},1:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i=s(19),r=s.n(i),o=s(163),n=s(22),a=s.n(n),c=s(164);const h=new class{constructor(){this.isExtensionMode=!1,this.browserName="",this.manifest={manifest_version:2,name:"",version:""};try{this.isExtensionMode=!!(chrome.runtime&&chrome.extension&&chrome.runtime.getManifest),this.manifest=chrome.runtime.getManifest()}catch(e){console.log("HelpFunctions: is not extension mode.",e)}this.browserName=(new c.UAParser).getBrowser().name||""}getToDay(e){let t=new Date;e&&(t=new Date(e));let s=t.getFullYear(),i=t.getMonth()+1,r=i<10?"0"+i:i,o=t.getDate();return`${s}-${r}-${o<10?"0"+o:o}`}updateBadge(e){if(this.isExtensionMode)try{0==e?(chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.enable()):(chrome.browserAction.setBadgeText({text:e.toString()}),chrome.browserAction.setBadgeBackgroundColor({color:"#aabbcc"}),chrome.browserAction.disable())}catch(e){console.log(e)}}getVersion(){return this.isExtensionMode?"v"+(this.manifest.version_name||this.manifest.version):"localVersion"}getRandomString(e=32,t=!1){let s=t?"abcdefhijkmnprstwxyz2345678ABCDEFGHJKMNPQRSTWXYZ":"abcdefghijkmnopqrstuvwxyz0123456789ABCDEFGHIJKMNOPQRSTUVWXYZ",i=s.length,r=[];for(let t=0;t<e;t++)r.push(s.charAt(Math.floor(Math.random()*i)));return r.join("")}getNewId(){return r()((new Date).getTime().toString()+this.getRandomString()).toString()}showNotifications(e,t=3e3){e=Object.assign({type:"basic",iconUrl:chrome.runtime.getURL("/assets/icon-128.png"),title:"PT \u52a9\u624b Plus",priority:0,message:""},e);let s=Math.floor(99999*Math.random())+"";chrome.notifications.create(s,e,(function(e){s=e})),setTimeout(()=>{chrome.notifications.clear(s,()=>{})},t)}removeDuplicateQueryString(e){let t,s=[],i="",r=/([^&=]+)=([^&]*)/g,o="",n=e.indexOf("?");if(-1!==n){for(o=e.substr(0,n+1),i=e.substr(n+1);t=r.exec(i);){const e=t[1]+"="+t[2];s.includes(e)||s.push(e)}return o+s.join("&")}return e}removeQueryStringFromValue(e,t){let s,i=[],r="",o=/([^&=]+)=([^&]*)/g,n="",a=e.indexOf("?");if(-1!==a){for(n=e.substr(0,a+1),r=e.substr(a+1);s=o.exec(r);){const e=s[1]+"="+s[2];s[2]!==t&&i.push(e)}return n+i.join("&")}return e}removeQueryStringFields(e,t){let s,i=[],r="",o=/([^&=]+)=([^&]*)/g,n="",a=e.indexOf("?");if(-1!==a){for(n=e.substr(0,a+1),r=e.substr(a+1);s=o.exec(r);){const e=s[1]+"="+s[2];t.includes(s[1])||i.push(e)}return n+i.join("&")}return e}clone(e){return JSON.parse(JSON.stringify(e))}debug(...e){console.log((new Date).toLocaleString(),...e)}showContextMenu(e,t){try{o.show(e,t),$(".basicContext").css({left:"-=20px",top:"+=10px"})}catch(e){}}getCleaningURL(e){return this.removeQueryStringFields(e,["hit","cmtpage","page"])}checkPermissions(e){return new Promise((t,s)=>{chrome&&chrome.permissions?chrome.permissions.contains({permissions:e},e=>{!0===e?t(!0):s({success:!1})}):s({success:!1})})}requestPermissions(e){return new Promise((t,s)=>{chrome&&chrome.permissions?chrome.permissions.request({permissions:e},e=>{!0===e?t(!0):s({success:!1})}):s({success:!1})})}usePermissions(e,t=!1,s=""){return new Promise((i,r)=>{this.checkPermissions(e).then(e=>{i(e)}).catch(()=>{let o=!0;t&&(o=confirm(s)),o?this.requestPermissions(e).then(e=>{i(e)}).catch(e=>{r(e)}):r({success:!1})})})}getSiteFromHost(e,t){let s=[];t.sites&&s.push(...t.sites),t.system&&t.system.publicSites&&s.push(...t.system.publicSites);let i=s.find(t=>{var s;let i=[t.url].concat(t.cdn,null===(s=t.formerHosts)||void 0===s?void 0:s.map(e=>"//"+e));return t.host==e||i.join("").indexOf("//"+e)>-1});return i?this.clone(i):null}getNewBackupFileName(){return"PT-Plugin-Plus-Backup-"+a()().format("YYYY-MM-DD_HH-mm-ss")+".zip"}replaceKeys(e,t,s=""){if(!e||"string"!=typeof e)return e;let i=e;for(const e in t)if(t.hasOwnProperty(e)){const r=t[e];let o="$"+e+"$";s&&(o=`$${s}.${e}$`),i=i.replace(o,r)}return i}checkOptionalPermission(e){return!!(this.isExtensionMode&&this.manifest&&this.manifest.optional_permissions)&&this.manifest.optional_permissions.includes(e)}transformTime(e,t){if(!t||!e)return e;let s=e;/^(\d){10}$/.test(s+"")&&(s=1e3*parseInt(s+""));let i=a()(s).format("YYYY-MM-DDTHH:mm:ss");return s=new Date(`${i}${t}`).getTime(),s}}},11:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var i=s(0);class r{constructor(){this.isExtensionMode=!1,window.chrome&&chrome.extension&&(this.isExtensionMode=!0)}set(e,t,s=i.u.json){return new Promise((r,o)=>{if(this.isExtensionMode){let s={};s[e]=t,chrome.storage.local.set(s,()=>{r()})}else"string"!=typeof t&&s==i.u.json&&(t=JSON.stringify(t)),window.localStorage.setItem(e,t),r()})}get(e,t,s=i.u.json){if(this.isExtensionMode)chrome.storage.local.get(e,s=>{s&&s[e]?t(s[e]):t(null)});else{let r=window.localStorage.getItem(e);r&&s==i.u.json&&(r=JSON.parse(r)),t&&t(r)}}}},166:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return ClientController}));var _api__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_interface_common__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0);class ClientController{constructor(){this.options={sites:[],clients:[]},this.clients={}}init(e){this.options=e,this.cleanUpClients()}cleanUpClients(){this.clients={}}getClient(clientOptions){return new Promise((resolve,reject)=>{if("string"==typeof clientOptions){let e=clientOptions;clientOptions=this.options.clients.find(t=>t.id===e);let t=this.clients[e];if(t)return void resolve({client:t,options:clientOptions})}if(void 0===window[clientOptions.type])_api__WEBPACK_IMPORTED_MODULE_0__.b.execScript({type:"file",content:`clients/${clientOptions.type}/init.js`}).then(()=>{let client;eval(`client = new ${clientOptions.type}()`),client.init({loginName:clientOptions.loginName,loginPwd:clientOptions.loginPwd,address:clientOptions.address,name:clientOptions.name}),this.clients[clientOptions.id]=client,resolve({client:client,options:clientOptions})}).catch(e=>{console.log(e),reject({initFailed:!0,msg:e})});else{let client;eval(`client = new ${clientOptions.type}()`),client.init({loginName:clientOptions.loginName,loginPwd:clientOptions.loginPwd,address:clientOptions.address,name:clientOptions.name}),this.clients[clientOptions.id]=client,resolve({client:client,options:clientOptions})}})}testClientConnectivity(e){return new Promise((t,s)=>{let i={type:_interface_common__WEBPACK_IMPORTED_MODULE_1__.g.unknown,success:!1};this.getClient(e).then(r=>{r.client.call(_interface_common__WEBPACK_IMPORTED_MODULE_1__.b.testClientConnectivity,e).then(e=>{i.success=e,e&&(i.type=_interface_common__WEBPACK_IMPORTED_MODULE_1__.g.success),t(i)}).catch(e=>{i.data=e,i.type=_interface_common__WEBPACK_IMPORTED_MODULE_1__.g.error,s(i)})}).catch(e=>{i.data=e,i.type=_interface_common__WEBPACK_IMPORTED_MODULE_1__.g.error,s(i)})})}}},167:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return Searcher}));var _interface_common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_service_api__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(3),_site__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(168),extend__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(57),extend__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(extend__WEBPACK_IMPORTED_MODULE_3__),_infoParser__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(30),_service_public__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(1),_pageParser__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(171),ESearchResultParseStatus;!function(e){e.success="success",e.needLogin="needLogin",e.noTorrents="noTorrents",e.torrentTableIsEmpty="torrentTableIsEmpty",e.parseError="parseError"}(ESearchResultParseStatus||(ESearchResultParseStatus={})),Object.assign(window,{ESearchResultParseStatus:ESearchResultParseStatus});class Searcher{constructor(e){this.service=e,this.searchConfigs={},this.parseScriptCache={},this.options={sites:[],clients:[]},this.searchRequestQueue={}}searchTorrent(site,key="",payload){return this.service.debug("searchTorrent: start",key,payload),new Promise((resolve,reject)=>{let result={success:!1},siteService=new _site__WEBPACK_IMPORTED_MODULE_2__.a(_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(site),_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(this.options)),searchConfig={},schema=this.getSiteSchema(site),host=site.host,siteSearchPage="",searchEntryConfig=extend__WEBPACK_IMPORTED_MODULE_3___default()(!0,{torrentTagSelectors:[]},schema&&schema.searchEntryConfig?schema.searchEntryConfig:{},siteService.options.searchEntryConfig),searchEntryConfigQueryString="";if(siteService.options.searchEntry?(searchConfig.rootPath=`sites/${host}/`,searchConfig.entry=siteService.options.searchEntry):schema&&schema.searchEntry&&(searchConfig.rootPath=`schemas/${schema.name}/`,searchConfig.entry=schema.searchEntry),schema&&schema.torrentTagSelectors&&(searchConfig.torrentTagSelectors=schema.torrentTagSelectors),siteService.options.torrentTagSelectors&&(siteService.options.mergeSchemaTagSelectors?searchConfig.torrentTagSelectors=siteService.options.torrentTagSelectors.concat(searchConfig.torrentTagSelectors):searchConfig.torrentTagSelectors=siteService.options.torrentTagSelectors),!searchConfig.entry)return result.msg=this.service.i18n.t("service.searcher.siteSearchConfigEntryIsEmpty",{site:site}),result.type=_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.error,reject(result),void this.service.debug("searchTorrent: tip");let imdb=key.match(/(tt\d+)/),autoMatched=!1;imdb&&imdb.length>=2&&(key=imdb[1]),key=key.replace(/\./g," "),searchEntryConfig&&searchEntryConfig.page&&(siteSearchPage=searchEntryConfig.page,searchEntryConfigQueryString=searchEntryConfig.queryString+"",searchEntryConfig.area&&searchEntryConfig.area.some(area=>{if(area.keyAutoMatch&&new RegExp(area.keyAutoMatch,"").test(key)){if(area.page&&(siteSearchPage=area.page),autoMatched=!0,area.queryString&&(searchEntryConfigQueryString=area.queryString),area.appendQueryString&&(searchEntryConfigQueryString+=area.appendQueryString),area.replaceKey&&(key=key.replace(new RegExp(area.replaceKey[0],"g"),area.replaceKey[1])),area.parseScript)try{key=eval(area.parseScript)}catch(e){}return!0}return!1})),this.searchConfigs[host]=searchConfig;let results=[],entryCount=0,doneCount=0;const KEY="$key$";searchEntryConfig.keepOriginKey||(key=encodeURIComponent(key)),searchConfig.entry.forEach(e=>{let t=e.entry||siteSearchPage;autoMatched&&-1!==t.indexOf(KEY)&&-1!==searchEntryConfigQueryString.indexOf(KEY)&&(t=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.removeQueryStringFromValue(t,KEY));let s=e.queryString;if(searchEntryConfigQueryString&&(s?s&&-1===s.indexOf(KEY)&&(s=searchEntryConfigQueryString+"&"+s):s=searchEntryConfigQueryString),e.appendQueryString&&(s+=e.appendQueryString),searchEntryConfig&&(e.parseScriptFile=searchEntryConfig.parseScriptFile||e.parseScriptFile,e.resultType=searchEntryConfig.resultType||e.resultType,e.requestDataType=searchEntryConfig.requestDataType||e.requestDataType,e.resultSelector=searchEntryConfig.resultSelector||e.resultSelector,e.headers=searchEntryConfig.headers||e.headers,e.asyncParse=searchEntryConfig.asyncParse||e.asyncParse,e.requestData=searchEntryConfig.requestData),t&&e.parseScriptFile&&!1!==e.enabled){let i=this.options.search&&this.options.search.rows?this.options.search.rows:10;site.cdn&&site.cdn.length>0&&(site.url=site.cdn[0]),"/"!=(site.url+"").substr(-1)&&(site.url+="/"),"/"==(t+"").substr(0,1)&&(t=(t+"").substr(1));let r=site.url+t;s&&(-1!==t.indexOf("?")?r+="&"+s:r+="?"+s),r=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.removeDuplicateQueryString(r);let o=key+(e.appendToSearchKeyString?" "+e.appendToSearchKeyString:"");if(r=this.replaceKeys(r,{key:o,rows:i,passkey:site.passkey?site.passkey:""}),e.requestData)try{for(const t in e.requestData)if(e.requestData.hasOwnProperty(t)){const s=e.requestData[t];if("string"!=typeof s)continue;e.requestData[t]=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.replaceKeys(s,{key:o,passkey:site.passkey?site.passkey:""}),site.user&&(e.requestData[t]=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.replaceKeys(e.requestData[t],site.user,"user"))}}catch(e){this.service.writeErrorLog(e),this.service.debug(e)}if(e.headers)for(const t in e.headers)if(e.headers.hasOwnProperty(t)){const s=e.headers[t];e.headers[t]=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.replaceKeys(s,{key:o,passkey:site.passkey?site.passkey:""}),site.user&&(e.headers[t]=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.replaceKeys(e.headers[t],site.user,"user"))}site.user&&(r=this.replaceKeys(r,site.user,"user")),entryCount++;let n=e.parseScriptFile;"/"!==n.substr(0,1)&&(n=`${searchConfig.rootPath}${n}`),e.parseScript=this.parseScriptCache[n],e.parseScript?this.getSearchResult(r,site,Object.assign(_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(searchEntryConfig),_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(e)),searchConfig.torrentTagSelectors).then(e=>{e&&e.length&&results.push(...e),doneCount++,(doneCount===entryCount||results.length>=i)&&resolve(results.slice(0,i))}).catch(e=>{doneCount++,doneCount===entryCount&&(results.length>0?resolve(results.slice(0,i)):reject(e))}):(this.service.debug("searchTorrent: getScriptContent",n),_service_api__WEBPACK_IMPORTED_MODULE_1__.b.getScriptContent(n).done(t=>{this.service.debug("searchTorrent: getScriptContent done",n),this.parseScriptCache[n]=t,e.parseScript=t,this.getSearchResult(r,site,Object.assign(_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(searchEntryConfig),_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(e)),searchConfig.torrentTagSelectors).then(e=>{this.service.debug("searchTorrent: getSearchResult done",r),e&&e.length&&results.push(...e),doneCount++,(doneCount===entryCount||results.length>=i)&&resolve(results.slice(0,i))}).catch(e=>{this.service.debug("searchTorrent: getSearchResult catch",r,e),doneCount++,doneCount===entryCount&&(results.length>0?resolve(results.slice(0,i)):reject(e))})}).fail(e=>{this.service.debug("searchTorrent: getScriptContent fail",e)}))}}),0==entryCount&&(result.msg=this.service.i18n.t("service.searcher.siteSearchEntryIsEmpty",{site:site}),result.type=_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.error,reject(result)),this.service.debug("searchTorrent: quene done")})}getSearchResult(e,t,s,i){return new Promise((r,o)=>{if(s.beforeSearch){new _pageParser__WEBPACK_IMPORTED_MODULE_6__.a(s.beforeSearch,t,this.service.options.connectClientTimeout).getInfos().then(n=>{this.addSearchRequestQueue(e,t,s,i,n).then(e=>{r(e)}).catch(e=>{o(e)})}).catch(n=>{this.service.writeErrorLog(n),this.addSearchRequestQueue(e,t,s,i).then(e=>{r(e)}).catch(e=>{o(e)})})}else this.addSearchRequestQueue(e,t,s,i).then(e=>{r(e)}).catch(e=>{o(e)})})}addSearchRequestQueue(url,site,entry,torrentTagSelectors,beforeSearchData){let _entry=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(entry);if(_entry.parseScript&&delete _entry.parseScript,beforeSearchData&&(this.service.debug("beforeSearchData",beforeSearchData),url=this.replaceKeys(url,beforeSearchData,"beforeSearchData"),entry.requestData))try{for(const e in entry.requestData)if(entry.requestData.hasOwnProperty(e)){const t=entry.requestData[e];entry.requestData[e]=_service_public__WEBPACK_IMPORTED_MODULE_5__.a.replaceKeys(t,beforeSearchData,"beforeSearchData")}}catch(e){this.service.writeErrorLog(e),this.service.debug(e)}this.service.debug("getSearchResult.start",{url:url,site:site.host,entry:_entry});let logId="",contentType="text/plain",data=entry.requestData;switch(entry.requestDataType){case _interface_common__WEBPACK_IMPORTED_MODULE_0__.p.JSON:contentType="application/json",data&&(data=JSON.stringify(data));case _interface_common__WEBPACK_IMPORTED_MODULE_0__.p.TEXT:}return new Promise((resolve,reject)=>{this.searchRequestQueue[url]=$.ajax({url:url,cache:!0,dataType:"text",contentType:contentType,timeout:this.options.connectClientTimeout||3e4,headers:entry.headers,method:entry.requestMethod||_interface_common__WEBPACK_IMPORTED_MODULE_0__.n.GET,data:data}).done(result=>{if(this.service.debug("getSearchResult.done",url),delete this.searchRequestQueue[url],result&&"string"==typeof result&&result.length>100||"object"==typeof result){let page,doc;try{switch(entry.resultType){case _interface_common__WEBPACK_IMPORTED_MODULE_0__.o.JSON:page=JSON.parse(result);break;default:doc=(new DOMParser).parseFromString(result,"text/html"),page=$(doc).find("body")}}catch(e){return logId=this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"service.searcher.getSearchResult.siteSearchResultParseFailed",msg:e}),void reject({success:!1,msg:this.service.i18n.t("service.searcher.siteSearchResultParseFailed",{site:site}),data:{logId:logId},type:_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.error})}let options={results:[],responseText:result,site:site,resultSelector:entry.resultSelector,page:page,entry:entry,torrentTagSelectors:torrentTagSelectors,errorMsg:"",isLogged:!1,status:ESearchResultParseStatus.success,searcher:this,url:url};try{if(entry.parseScript){if(entry.asyncParse)return options=Object.assign({reject:reject,resolve:resolve},options),void eval(entry.parseScript);eval(entry.parseScript)}options.errorMsg||options.status!=ESearchResultParseStatus.success?reject({success:!1,msg:this.getErrorMessage(site,options.status,options.errorMsg),data:{site:site,isLogged:options.isLogged}}):resolve(_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(options.results))}catch(e){console.error(e),logId=this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"service.searcher.getSearchResult.siteEvalScriptFailed",msg:e}),reject({success:!1,msg:this.service.i18n.t("service.searcher.siteEvalScriptFailed",{site:site}),data:{logId:logId}})}}else logId=this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"service.searcher.getSearchResult.siteSearchResultError",msg:result}),reject({success:!1,msg:this.service.i18n.t("service.searcher.siteSearchResultError",{site:site}),data:{logId:logId},type:_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.error})}).fail((e,t,s)=>{delete this.searchRequestQueue[url],this.service.debug({title:"getSearchResult.fail",url:url,entry:entry,textStatus:t,errorThrown:s}),logId=this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"service.searcher.getSearchResult.fail",msg:s,data:{url:url,entry:entry,code:e.status,textStatus:t,errorThrown:s,responseText:e.responseText}}),reject({data:{logId:logId,textStatus:t},msg:this.service.i18n.t("service.searcher.siteNetworkFailed",{site:site,msg:`${e.status} ${s}, ${t}`}),success:!1,type:_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.error})})})}getErrorMessage(e,t=ESearchResultParseStatus.success,s=""){return t!=ESearchResultParseStatus.success?this.service.i18n.t("contentPage.search."+t,{siteName:e.name,msg:s}):s}abortSearch(e,t=""){return new Promise((s,i)=>{let r=e.host+"",o=this.searchConfigs[r];o.entry&&(this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"searcher.abortSearch",msg:this.service.i18n.t("service.searcher.siteAbortSearch",{site:e}),data:{site:e.host,key:t}}),o.entry.forEach(r=>{if(r.entry&&r.parseScriptFile&&!1!==r.enabled){e.cdn&&e.cdn.length>0&&(e.url=e.cdn[0]);let o=this.options.search&&this.options.search.rows?this.options.search.rows:10,n=e.url+r.entry;n=this.replaceKeys(n,{key:t,rows:o,passkey:e.passkey?e.passkey:""});let a=this.searchRequestQueue[n];if(a)try{a.abort(),s()}catch(s){this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"searcher.abortSearch.error",msg:this.service.i18n.t("service.searcher.siteAbortSearchError",{site:e}),data:{site:e.host,key:t,error:s}}),i(s)}else s()}else s()}))})}getSiteSchema(e){let t={};return"string"==typeof e.schema&&(t=this.options.system&&this.options.system.schemas&&this.options.system.schemas.find(t=>t.name==e.schema),void 0===t)?t:_service_public__WEBPACK_IMPORTED_MODULE_5__.a.clone(t)}replaceKeys(e,t,s=""){let i=e;for(const e in t)if(t.hasOwnProperty(e)){const r=t[e];let o="$"+e+"$";s&&(o=`$${s}.${e}$`),i=i.replace(o,r)}return i}getFieldValue(e,t,s=""){let i;if(!e.searchEntryConfig||!e.searchEntryConfig.fieldSelector)return null;if(i=e.searchEntryConfig.fieldSelector[s],!i)return null;return new _infoParser__WEBPACK_IMPORTED_MODULE_4__.a(this.service).getFieldData(t,i,e.searchEntryConfig.fieldSelector)}getCategoryById(e,t,s){let i={};return e.categories&&e.categories.forEach(e=>{if(e.category&&("*"==e.entry||t.indexOf(e.entry))){let t=e.category.find(e=>e.id==s);t&&(i=t)}}),i}cfDecodeEmail(e){let t,s,i="",r=parseInt(e.substr(0,2),16);for(t=2;e.length-t;t+=2)s=parseInt(e.substr(t,2),16)^r,i+=String.fromCharCode(s);return i}getRowTags(e,t){let s=[];if(e&&e.host){let i=this.searchConfigs[e.host].torrentTagSelectors;i&&i.length>0&&i.forEach(e=>{if(e.selector){let i=t.find(e.selector);if(i.length){let t=e.color||_interface_common__WEBPACK_IMPORTED_MODULE_0__.a[e.name]||"",r={name:e.name,color:t};e.title&&i.attr(e.title)&&(r.title=i.attr(e.title)),s.push(r)}}})}return s}}},168:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s(57),r=s.n(i);class o{constructor(e,t){this.options=e,this.systemOptions=t,this.isLogin=!1,this._schema={},this.mergeOptions()}get schema(){if(this._schema.name)return this._schema;let e={};return"string"==typeof this.options.schema&&(e=this.systemOptions.system&&this.systemOptions.system.schemas&&this.systemOptions.system.schemas.find(e=>e.name==this.options.schema)),this._schema=e,e}mergeOptions(){let e=this.systemOptions.system&&this.systemOptions.system.sites&&this.systemOptions.system.sites.find(e=>e.host==this.options.host);if(e){let t=[];if(this.options.searchEntry)for(let e=this.options.searchEntry.length-1;e>=0;e--){const s=this.options.searchEntry[e];s.isCustom&&(t.push(s),this.options.searchEntry.splice(e,1))}this.options=r()(!0,{},e,this.options),this.options.searchEntry&&t.length>0&&this.options.searchEntry.push(...t)}console.log(this.options)}}},171:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return PageParser}));var _interface_common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_service_public__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_service_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(3),_infoParser__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(30),blueimp_md5__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(19),blueimp_md5__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(blueimp_md5__WEBPACK_IMPORTED_MODULE_4__);class PageParser{constructor(e,t,s=3e4,i){this.options=e,this.site=t,this.timeout=s,this.commonDatas=i,this.infoParserCache={},this.cacheKey="",this.url="";let r=t.url+"";t.cdn&&t.cdn.length>0&&(r=t.cdn[0]),"/"!=(r+"").substr(-1)&&(r+="/");let o=this.options.page;if("/"==(o+"").substr(0,1)&&(o=(o+"").substr(1)),this.url=(r+o).replace("://","****").replace(/\/\//g,"/").replace("****","://"),this.requestData=this.options.requestData,this.requestData&&this.commonDatas)try{for(const e in this.requestData)if(this.requestData.hasOwnProperty(e)){const t=this.requestData[e];for(const s in this.commonDatas)this.commonDatas.hasOwnProperty(s)&&(this.requestData[e]=_service_public__WEBPACK_IMPORTED_MODULE_1__.a.replaceKeys(t,this.commonDatas[s],s))}}catch(e){console.log(e)}this.cacheKey=blueimp_md5__WEBPACK_IMPORTED_MODULE_4___default()(this.url+JSON.stringify(this.requestData||{}))}getCache(){let e=window.localStorage.getItem(this.cacheKey);if(e){let t=JSON.parse(e);if(t.data&&t.time){let e=(new Date).getTime();return t.time<e?(window.localStorage.removeItem(this.cacheKey),null):t.data}}return null}setCache(){if(this.options.dataCacheTime&&this.options.dataCacheTime>0){let e={data:this.resultData,time:(new Date).getTime()+1e3*this.options.dataCacheTime};window.localStorage.setItem(this.cacheKey,JSON.stringify(e))}}getInfos(){return new Promise((e,t)=>{let s=this.getCache();if(s)return void e(s);if(this.options.parser&&this.site&&this.runParser(e,t))return;$.ajax({url:this.url,method:this.options.requestMethod||_interface_common__WEBPACK_IMPORTED_MODULE_0__.n.GET,dataType:"text",headers:this.options.headers,data:this.requestData,timeout:this.timeout}).done(s=>{let i;try{if(this.options.dataType!==_interface_common__WEBPACK_IMPORTED_MODULE_0__.o.JSON){let e=(new DOMParser).parseFromString(s,"text/html"),t=this.options.topElement||"body";i=$(e).find(t)}else i=JSON.parse(s)}catch(e){return void t(e)}if(i&&this.options)try{let t=(new _infoParser__WEBPACK_IMPORTED_MODULE_3__.a).getResult(i,this.options);this.resultData=t,this.setCache(),e(t)}catch(e){t(e)}}).fail(e=>{t(e)})})}runParser(resolve,reject){if(!this.site||!this.options.parser)return!1;let siteConfigPath="publicSite"==this.site.schema?"publicSites":"sites";this.site.path?siteConfigPath+="/"+this.site.path:siteConfigPath+="/"+this.site.host;let path=this.options.parser;"/"!==path.substr(0,1)&&"http"!==path.substr(0,4)&&(path=`${siteConfigPath}/${path}`);let _options={site:this.site,rule:this.options,commonDatas:this.commonDatas,resolve:resolve,reject:reject},_self=this,script=this.infoParserCache[path];return script?eval(script):_service_api__WEBPACK_IMPORTED_MODULE_2__.b.getScriptContent(path).done(script=>{this.infoParserCache[path]=script,eval(script)}),!0}}},172:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return User}));var _interface_common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_infoParser__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(30),_service_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(3),_service_public__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1);class User{constructor(e){this.service=e,this.requestQueue={},this.requestQueueCount=0,this.infoParserCache={},this.InfoParser=_infoParser__WEBPACK_IMPORTED_MODULE_1__.a}refreshUserData(e=!1){return new Promise((t,s)=>{let i=[];this.service.options.sites.forEach(t=>{if(!t.allowGetUserInfo||t.offline)return!1;if(e){if(t.user){let e=[_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.needLogin,_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.unknown].includes(t.user.lastUpdateStatus);(t.user.lastUpdateStatus&&e||!t.user.lastUpdateStatus)&&i.push(this.getUserInfo(t,!0))}}else i.push(this.getUserInfo(t,!0))}),Promise.all(i).then(e=>{t(e)})})}updateStatus(e,t){t.lastUpdateTime=(new Date).getTime(),this.service.userData.update(e,t)}getSiteURL(e){return e.cdn&&e.cdn.length>0?e.cdn[0]:e.url}getUserInfo(e,t=!1){return this.service.options.autoRefreshUserDataLastTime=(new Date).getTime(),this.service.saveConfig(),new Promise((s,i)=>{let r=t?s:i;if(!e)return void r(null);let o=this.service.userData.get(e.host)||{},n=this.service.getSiteSelector(e,"userBaseInfo");if(!n)return o.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.notSupported,this.updateStatus(e,o),void r(_service_api__WEBPACK_IMPORTED_MODULE_2__.b.createErrorMessage({status:_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.notSupported,msg:this.service.i18n.t("service.user.notSupported")}));let a=`${this.getSiteURL(e)}${n.page}`,c=e.host;this.checkQueue(c,a)?s(o):this.getInfos(c,a,n,e).then(t=>{if(console.log("userBaseInfo",c,t),o=Object.assign({},t),n&&n.fields&&n.fields.isLogged?o.isLogged&&(o.name||o.id)?o.isLogged=!0:o.isLogged=!1:(o.name||o.id)&&(o.isLogged=!0),!o.isLogged)return o.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.needLogin,void r(_service_api__WEBPACK_IMPORTED_MODULE_2__.b.createErrorMessage({msg:this.service.i18n.t("service.user.notLogged"),status:_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.needLogin}));if(n=this.service.getSiteSelector(e,"userExtendInfo"),!n)return this.updateStatus(e,o),void s(o);if(o.name||o.id){let t=`${this.getSiteURL(e)}${n.page.replace("$user.id$",o.id).replace("$user.name$",o.name).replace("$user.bonusPage$",o.bonusPage).replace("$user.unsatisfiedsPage$",o.unsatisfiedsPage)}`;if(this.checkQueue(c,t))return void s(o);this.getInfos(c,t,n,e,o).then(t=>{o=Object.assign(o,t),o.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.success,this.updateStatus(e,o),this.getMoreInfos(e,o).then(()=>{s(o)})}).catch(e=>{o.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.unknown,r(_service_api__WEBPACK_IMPORTED_MODULE_2__.b.createErrorMessage(e))})}else o.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.unknown,r(_service_api__WEBPACK_IMPORTED_MODULE_2__.b.createErrorMessage({status:_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.unknown,msg:this.service.i18n.t("service.user.getUserInfoFailed")}))}).catch(e=>{o.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.unknown,console.log("getInfos Error :",e),r(_service_api__WEBPACK_IMPORTED_MODULE_2__.b.createErrorMessage(e))})})}getMoreInfos(site,userInfo){return new Promise((resolve,reject)=>{let requests=[],selectors=["userSeedingTorrents","bonusExtendInfo","hnrExtendInfo","levelExtendInfo","userUploadedTorrents"];selectors.forEach(name=>{let host=site.host,rule=this.service.getSiteSelector(site,name);if(rule&&rule.page){let url=`${this.getSiteURL(site)}${rule.page.replace("$user.id$",userInfo.id).replace("$user.name$",userInfo.name).replace("$user.bonusPage$",userInfo.bonusPage).replace("$user.unsatisfiedsPage$",userInfo.unsatisfiedsPage)}`;if(this.checkQueue(host,url))return;if(rule.prerequisites){const user=userInfo;try{let result=eval(rule.prerequisites);if(!0!==result)return}catch(e){return void console.log(e)}}requests.push(this.getInfos(host,url,rule,site,userInfo))}}),requests.length?Promise.all(requests).then(e=>{e.forEach(e=>{userInfo=Object.assign(userInfo,e),console.log(userInfo),userInfo.lastUpdateStatus=_interface_common__WEBPACK_IMPORTED_MODULE_0__.w.success,this.updateStatus(site,userInfo)}),resolve(userInfo)}).catch(e=>{resolve(userInfo)}):resolve(userInfo)})}getInfos(e,t,s,i,r){return new Promise((o,n)=>{t=t.replace("://","****").replace(/\/\//g,"/").replace("****","://");let a=s.requestData;if(a&&r)try{for(const e in a)if(a.hasOwnProperty(e)){const t=a[e];a[e]=_service_public__WEBPACK_IMPORTED_MODULE_3__.a.replaceKeys(t,r,"user")}}catch(e){console.log(e)}let c=s.headers;if(c&&r)try{for(const e in c)if(c.hasOwnProperty(e)){const t=c[e];c[e]=_service_public__WEBPACK_IMPORTED_MODULE_3__.a.replaceKeys(t,r,"user")}}catch(e){console.log(e)}if(s.parser&&i)return void this.runParser(s,i,r,o,n);_service_public__WEBPACK_IMPORTED_MODULE_3__.a.updateBadge(++this.requestQueueCount);let h=$.ajax({url:t,method:s.requestMethod||_interface_common__WEBPACK_IMPORTED_MODULE_0__.n.GET,dataType:"text",data:a,headers:s.headers,timeout:this.service.options.connectClientTimeout||3e4}).done(i=>{let r;this.removeQueue(e,t),_service_public__WEBPACK_IMPORTED_MODULE_3__.a.updateBadge(--this.requestQueueCount);try{if(s.dataType!==_interface_common__WEBPACK_IMPORTED_MODULE_0__.o.JSON){let e=(new DOMParser).parseFromString(i,"text/html"),t=s.topElement||"body";r=$(e).find(t)}else r=JSON.parse(i)}catch(s){return this.service.debug("getInfos.error",e,t,s),void n(s)}if(r&&s)try{let e=(new _infoParser__WEBPACK_IMPORTED_MODULE_1__.a).getResult(r,s);o(e)}catch(e){this.service.debug(e),n(e)}}).fail((s,r,o)=>{this.removeQueue(e,t),_service_public__WEBPACK_IMPORTED_MODULE_3__.a.updateBadge(--this.requestQueueCount);let a=this.service.i18n.t("service.searcher.siteNetworkFailed",{site:i,msg:`${s.status} ${o}, ${r}`});this.service.debug(a,e,t,s.responseText),n(a)});this.addQueue(e,t,h)})}runParser(rule,site,userInfo,resolve,reject){let siteConfigPath="publicSite"==site.schema?"publicSites":"sites";site.path?siteConfigPath+="/"+site.path:siteConfigPath+="/"+site.host;let path=rule.parser;"/"!==path.substr(0,1)&&"http"!==path.substr(0,4)&&(path=`${siteConfigPath}/${path}`);let _options={site:site,rule:rule,userInfo:userInfo,resolve:resolve,reject:reject},_self=this,script=this.infoParserCache[path];script?eval(script):_service_api__WEBPACK_IMPORTED_MODULE_2__.b.getScriptContent(path).done(script=>{this.infoParserCache[path]=script,eval(script)})}addQueue(e,t,s){let i=this.requestQueue[e]||{};i[t]=s,this.requestQueue[e]=i}checkQueue(e,t){return!!(this.requestQueue[e]||{})[t]}removeQueue(e,t){let s=this.requestQueue[e]||{};s[t]&&delete s[t],this.requestQueue[e]=s}abortGetUserInfo(e){return new Promise((t,s)=>{let i=e.host,r=this.requestQueue[i],o=[];if(r){for(const t in r)if(r.hasOwnProperty(t)){const s=r[t];try{s.abort()}catch(t){this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"user.abortGetUserInfo.error",msg:this.service.i18n.t("service.user.abortGetUserInfoFailed"),data:{site:e.host,error:t}}),o.push(t)}}delete this.requestQueue[i]}o.length>0?s(o):t(!0)})}getCookie(e,t){return new Promise((s,i)=>{_service_public__WEBPACK_IMPORTED_MODULE_3__.a.checkPermissions(["cookies"]).then(()=>{this.service.config.getCookiesFromSite(e).then(e=>{for(const i of e.cookies)i.name===t&&s(i.value);s("")}).catch(e=>{i(e)})}).catch(e=>{i(e)})})}}},174:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return ContextMenus}));var _interface_common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),url_parse__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(24),url_parse__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(url_parse__WEBPACK_IMPORTED_MODULE_1__),_service_api__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(3),_service_pathHandler__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(175);class ContextMenus{constructor(e){this.service=e,this.options={sites:[],clients:[]},this.rootId="PT-Plugin-Plugin-Content-Menu",this.currentTabId=0,this.siteMenus=[],this.pathHandler=new _service_pathHandler__WEBPACK_IMPORTED_MODULE_3__.a,chrome&&chrome.tabs&&this.initBrowserEvent()}initBrowserEvent(){chrome.tabs.onActivated.addListener(e=>{chrome.tabs.get(e.tabId,e=>{if(this.clearSiteMenus(),e.url){let t=new url_parse__WEBPACK_IMPORTED_MODULE_1___default.a(e.url).host;this.createSiteMenus(t)}})}),chrome.tabs.onUpdated.addListener((e,t,s)=>{if(this.clearSiteMenus(),s.url){let e=new url_parse__WEBPACK_IMPORTED_MODULE_1___default.a(s.url).host;this.createSiteMenus(e)}}),chrome.browserAction.onClicked.addListener(()=>{this.service.controller.openOptions()})}init(e){this.options=e,this.clear(),this.createSearchMenus(),this.createClientMenus(),this.createPluginIconPopupMenus()}createPluginIconPopupMenus(){this.add({title:this.service.i18n.t("service.contextMenus.history"),contexts:["browser_action"],onclick:()=>{chrome.tabs.create({url:"index.html#/history"})}}),this.add({title:this.service.i18n.t("service.contextMenus.systemLog"),contexts:["browser_action"],onclick:()=>{chrome.tabs.create({url:"index.html#/system-logs"})}}),this.add({type:"separator",contexts:["browser_action"]}),this.add({title:this.service.i18n.t("service.contextMenus.issues"),contexts:["browser_action"],onclick:()=>{chrome.tabs.create({url:"https://github.com/pt-plugins/PT-Plugin-Plus/issues/new"})}})}clear(){chrome&&chrome.contextMenus&&chrome.contextMenus.removeAll()}clearSiteMenus(){this.siteMenus.forEach(e=>{this.remove(e)}),this.siteMenus=[]}getSiteDocumentUrlPatterns(e){let t=e.url+"";"/"!=t.substr(-1)&&(t+="/");let s=[`*://${e.host}/*`,""+t];if(e.cdn&&e.cdn.length>0)for(let t=0;t<e.cdn.length;t++){const i=e.cdn[t];s.push(`${i}${"/"!=i.substr(-1)?"/*":"*"}`,i)}return s}createPathMenus(e,t,s,i){e.forEach((e,r)=>{let o=`${s.id}**${t.host}**${e}**${r}`;this.add({id:o,title:this.pathHandler.replacePathKey(e,t),parentId:i,contexts:["link"],documentUrlPatterns:this.getSiteDocumentUrlPatterns(t),targetUrlPatterns:this.getSiteUrlPatterns(t),onclick:(e,t)=>{let s=e.menuItemId.split("**"),i={clientId:s[0],url:e.linkUrl,savePath:s[2]};this.sendTorrentToClient(t.id,i)}})})}createSiteMenus(e){let t=this.options.sites.find(t=>{let s=[t.url].concat(t.cdn);return t.host===e||s.join("|").indexOf(e)>-1});if(t){if(this.options.allowSelectionTextSearch){let s=t.host;this.siteMenus.push(s),this.add({id:s,title:this.service.i18n.t("service.contextMenus.searchSelectionTextOnThisSite"),contexts:["selection"],documentUrlPatterns:this.getSiteDocumentUrlPatterns(t),onclick:(t,s)=>{this.service.controller.searchTorrent(t.selectionText,e)}})}this.options.clients.forEach(e=>{if(e.paths){let s=e.id+"-path",i=0;this.add({id:s,title:this.service.i18n.t("service.contextMenus.downloadClientPath",{clientName:e.name}),contexts:["link"],documentUrlPatterns:this.getSiteDocumentUrlPatterns(t),targetUrlPatterns:this.getSiteUrlPatterns(t)});for(const r in e.paths){let o=e.paths[r];r===t.host&&(i++,this.createPathMenus(o,t,e,s))}let r=e.paths[_interface_common__WEBPACK_IMPORTED_MODULE_0__.e.allSite];r&&(i++,this.createPathMenus(r,t,e,s)),i>0?this.siteMenus.push(s):this.remove(s)}})}}getSiteUrlPatterns(e){let t=[];if(e.patterns&&e.patterns.torrentLinks)t=e.patterns.torrentLinks;else{let s=this.getSiteSchema(e);s&&s.patterns&&s.patterns.torrentLinks?t=s.patterns.torrentLinks:t.push("*://*/*")}return t}getSiteSchema(e){let t={};return"string"==typeof e.schema&&(t=this.options.system&&this.options.system.schemas&&this.options.system.schemas.find(t=>t.name==e.schema)),t}sendTorrentToClient(e=0,t){console.log("sendTorrentToClient",t);let s,i=this.getSiteFromURL(t.url);if(i&&t.savePath){let e=this.pathHandler.getSavePath(t.savePath,i);if(!1===e)return void _service_api__WEBPACK_IMPORTED_MODULE_2__.b.showNotifications({message:this.service.i18n.t("service.contextMenus.userCanceled")});t.savePath=e}try{chrome.tabs.sendMessage(e,{action:_interface_common__WEBPACK_IMPORTED_MODULE_0__.b.showMessage,data:{type:_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.info,msg:this.service.i18n.t("service.contextMenus.sendingLink"),timeout:2,indeterminate:!0}},e=>{if(chrome.runtime.lastError){(chrome.runtime.lastError.message||"").match(/Could not establish connection/)?_service_api__WEBPACK_IMPORTED_MODULE_2__.b.showNotifications({message:this.service.i18n.t("service.contextMenus.pluginStatusIsUnknown")}):_service_api__WEBPACK_IMPORTED_MODULE_2__.b.showNotifications({message:chrome.runtime.lastError.message})}else s=e})}catch(e){return void _service_api__WEBPACK_IMPORTED_MODULE_2__.b.showNotifications({message:e})}this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"contextMenus.sendTorrentToClient.begin",msg:this.service.i18n.t("service.contextMenus.sendingLink"),data:t});let r=this.options.clients.find(e=>e.id===t.clientId);if(!r)return chrome.tabs.sendMessage(e,{action:_interface_common__WEBPACK_IMPORTED_MODULE_0__.b.showMessage,data:{type:_interface_common__WEBPACK_IMPORTED_MODULE_0__.g.error,msg:this.service.i18n.t("service.contextMenus.downloadClientGetFailed")}}),this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"contextMenus.sendTorrentToClient.getClientError",msg:this.service.i18n.t("service.contextMenus.downloadClientGetFailed"),data:t}),void this.hideNotice(e,s);t.autoStart=r.autoStart,console.log(t);let o=this.getParsedURL(t.url);if("string"!=typeof o)return chrome.tabs.sendMessage(e,{action:_interface_common__WEBPACK_IMPORTED_MODULE_0__.b.showMessage,data:o}),void this.hideNotice(e,s);t.url=o,this.service.controller.sendTorrentToClient(t).then(t=>{this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"contextMenus.sendTorrentToClient.done",msg:this.service.i18n.t("service.contextMenus.sendTorrentToClientDone"),data:t}),chrome.tabs.sendMessage(e,{action:_interface_common__WEBPACK_IMPORTED_MODULE_0__.b.showMessage,data:t})}).catch(t=>{this.service.logger.add({module:_interface_common__WEBPACK_IMPORTED_MODULE_0__.l.background,event:"contextMenus.sendTorrentToClient.error",msg:this.service.i18n.t("service.contextMenus.sendTorrentToClientError"),data:t}),chrome.tabs.sendMessage(e,{action:_interface_common__WEBPACK_IMPORTED_MODULE_0__.b.showMessage,data:""==t.status?this.service.i18n.t("service.contextMenus.sendTorrentToClientError"):t})}).finally(()=>{this.hideNotice(e,s)})}hideNotice(e=0,t){t&&(t.id?chrome.tabs.sendMessage(e,{action:_interface_common__WEBPACK_IMPORTED_MODULE_0__.b.hideMessage,data:t.id}):t.hide&&t.hide())}createSearchMenus(){this.options.allowSelectionTextSearch&&(this.add({title:this.service.i18n.t("service.contextMenus.searchSelectionText"),contexts:["selection"],onclick:(e,t)=>{this.service.controller.searchTorrent(e.selectionText)}}),this.pushMoreSearchMenus());this.add({id:"searchWithIMDb",title:this.service.i18n.t("service.contextMenus.searchByIMDb"),contexts:["link"],targetUrlPatterns:["*://www.imdb.com/title/tt*"]}),this.add({parentId:"searchWithIMDb",title:this.service.i18n.t("service.contextMenus.searchByDefault"),contexts:["link"],targetUrlPatterns:["*://www.imdb.com/title/tt*"],onclick:(e,t)=>{if(e.linkUrl){let t=e.linkUrl.match(/(tt\d+)/);t&&t.length>=2&&this.service.controller.searchTorrent(t[1])}}}),this.pushMoreSearchMenus("searchWithIMDb",["link"],["*://www.imdb.com/title/tt*"],/(tt\d+)/);this.add({id:"searchWithDouban",title:this.service.i18n.t("service.contextMenus.searchByDouban"),contexts:["link"],targetUrlPatterns:["*://movie.douban.com/subject/*"]}),this.add({parentId:"searchWithDouban",title:this.service.i18n.t("service.contextMenus.searchByDefault"),contexts:["link"],targetUrlPatterns:["*://movie.douban.com/subject/*"],onclick:(e,t)=>{if(e.linkUrl){let t=e.linkUrl.match(/subject\/(\d+)/);t&&t.length>=2&&this.service.controller.searchTorrent("douban"+t[1])}}}),this.pushMoreSearchMenus("searchWithDouban",["link"],["*://movie.douban.com/subject/*"],/subject\/(\d+)/,"douban")}pushMoreSearchMenus(e,t=["selection"],s,i=/(tt\d+)/,r=""){const o=this.options.sites;if(o&&o.length>0){let n=e+"searchInSite";this.add({id:n,title:this.service.i18n.t("service.contextMenus.searchInSite"),contexts:t,parentId:e,targetUrlPatterns:s}),o.forEach(e=>{let o=`${n}**${e.host}`;this.add({id:o,title:`${e.name} - ${e.host}`,parentId:n,contexts:t,targetUrlPatterns:s,onclick:(e,s)=>{let o=e.menuItemId.split("**");if(this.service.debug(this.service.i18n.t("service.contextMenus.searchInSite"),e),t.includes("link")&&e.linkUrl){let t=e.linkUrl.match(i);t&&t.length>=2&&this.service.controller.searchTorrent(r+t[1],o[1])}else this.service.controller.searchTorrent(e.selectionText,o[1])}})})}const n=this.options.searchSolutions;if(n&&n.length>0){let o=e+"searchInSolution";this.add({id:o,title:this.service.i18n.t("service.contextMenus.searchInSolution"),contexts:t,parentId:e,targetUrlPatterns:s}),n.forEach(e=>{let n=`${o}**${e.id}`;this.add({id:n,title:""+e.name,parentId:o,contexts:t,targetUrlPatterns:s,onclick:(e,s)=>{this.service.debug(this.service.i18n.t("service.contextMenus.searchInSolution"),e);let o=e.menuItemId.split("**");if(t.includes("link")&&e.linkUrl){let t=e.linkUrl.match(i);t&&t.length>=2&&this.service.controller.searchTorrent(r+t[1],o[1])}else this.service.controller.searchTorrent(e.selectionText,o[1])}})})}this.add({title:this.service.i18n.t("service.contextMenus.searchInAllSite"),parentId:e,contexts:t,targetUrlPatterns:s,onclick:(e,s)=>{if(e.linkUrl){let s=e.linkUrl.match(i);t.includes("link")&&s&&s.length>=2&&this.service.controller.searchTorrent(r+s[1],"all")}else this.service.controller.searchTorrent(e.selectionText,"all")}})}createClientMenus(){let e=this.options.clients.filter(e=>!1!==e.enabled);if(console.log("createClientMenus",this.options.clients),console.log("createClientMenus",e),this.options.defaultClientId){let e=this.options.clients.find(e=>e.id===this.options.defaultClientId);e&&this.add({id:e.id,title:this.service.i18n.t("service.contextMenus.sendTorrentToDefaultClient",{client:e}),contexts:["link"],onclick:(e,t)=>{this.sendTorrentToClient(t.id,{clientId:e.menuItemId,url:e.linkUrl})}})}e.length>1&&(this.add({id:this.rootId,title:this.service.i18n.t("service.contextMenus.sendTorrentToClient"),contexts:["link"]}),e.forEach(e=>{e.id!==this.options.defaultClientId&&this.add({id:e.id,title:`${e.name} -> ${e.address}`,parentId:this.rootId,contexts:["link"],onclick:(e,t)=>{this.sendTorrentToClient(t.id,{clientId:e.menuItemId,url:e.linkUrl})}})}))}add(e,t){e.id||(e.id=this.getRandomString()),chrome&&chrome.contextMenus&&chrome.contextMenus.create(e,t)}remove(e,t){try{chrome.contextMenus.remove(e,t),chrome.runtime.lastError&&console.log(chrome.runtime.lastError)}catch(e){console.log(e)}}getRandomString(e=16,t=!0){let s=t?"abcdefhijkmnprstwxyz2345678ABCDEFGHJKMNPQRSTWXYZ":"abcdefghijkmnopqrstuvwxyz0123456789ABCDEFGHIJKMNOPQRSTUVWXYZ",i=s.length,r=[];for(let t=0;t<e;t++)r.push(s.charAt(Math.floor(Math.random()*i)));return r.join("")}getParsedURL(source){let url=new url_parse__WEBPACK_IMPORTED_MODULE_1___default.a(source),site=this.getSiteFromURL(source);if(!site)return source;let options={url:url,site:site,result:source,error:{}},parser=this.getSiteParser(site.host,"downloadURL");if(parser)try{eval(parser)}catch(e){console.error(e)}return options.error&&options.error.msg?options.error:options.result}getSiteParser(e,t){let s=this.options.system&&this.options.system.sites&&this.options.system.sites.find(t=>t.host===e);if(!s)return"";let i=s.parser&&s.parser[t];if(!i){let e=this.options.system&&this.options.system.schemas&&this.options.system.schemas.find(e=>e.name===s.schema);e&&e.parser&&(i=e.parser[t])}return i}getSiteFromURL(e){let t=new url_parse__WEBPACK_IMPORTED_MODULE_1___default.a(e);if(!t.host)return null;let s=this.options.sites.find(e=>{let s=[e.url].concat(e.cdn);return e.host==t.host||s.join("").indexOf(t.host)>-1});return s||null}}},175:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(){}replacePathKey(e,t){if(!e)return e;const s=new Date;return this.replaceKeys(e,{"site.name":t.name,"site.host":t.host,YYYY:s.getFullYear(),MM:("0"+(s.getMonth()+1).toString()).substr(-2),DD:("0"+s.getDate().toString()).substr(-2)})}getSavePath(e,t){if(!e)return;let s=e;if(s&&s.indexOf("<...>")>=0){let e=window.prompt(`\u5f53\u524d\u4e3a\u81ea\u5b9a\u4e49\u8def\u5f84\uff1a${s} \n\u8bf7\u8f93\u5165\u8def\u5f84\u4e2d <...> \u90e8\u5206\u7684\u5185\u5bb9: `);if(null===e)return!1;s=s.replace("<...>",e)}return this.replacePathKey(s,t)}replaceKeys(e,t){let s=e;for(const e in t)if(t.hasOwnProperty(e)){const i=t[e];s=s.replace("$"+e+"$",i)}return s}}},176:function(e,t){String.prototype.getQueryString=function(e,t){null==t&&(t="&");var s,i=new RegExp("(^|"+t+"|\\?)"+e+"=([^"+t+"#]*)("+t+"|#|$)");return(s=this.match(i))?decodeURI(s[2]):null},String.prototype.sizeToNumber=function(){let e=this.match(/^(\d*\.?\d+)(.*[^ZEPTGMK])?([ZEPTGMK](B|iB))$/i);if(e){let t=parseFloat(e[1]),s=e[3];switch(!0){case/Zi?B/i.test(s):return t*Math.pow(2,70);case/Ei?B/i.test(s):return t*Math.pow(2,60);case/Pi?B/i.test(s):return t*Math.pow(2,50);case/Ti?B/i.test(s):return t*Math.pow(2,40);case/Gi?B/i.test(s):return t*Math.pow(2,30);case/Mi?B/i.test(s):return t*Math.pow(2,20);case/Ki?B/i.test(s):return t*Math.pow(2,10);default:return t}}return 0},String.prototype.timeToDays=function(){const e=this.replace("weeks","W").replace("days","D").replace("months","M").replace("years","Y").replace(" ","").match(/\d+[\u5929\u65e5\u5468\u6708\u5e74DWMY]/g);let t=0;return null==e?0:(e.forEach(e=>{const s=e.match(/(\d+)([\u5929\u65e5\u5468\u6708\u5e74DWMY])/);if(null==s)return 0;const i=parseInt(s[1]),r=s[2];switch(!0){case"D"===r:case"\u5929"===r:case"\u65e5"===r:t+=i;break;case"W"===r:case"\u5468"===r:t+=7*i;break;case"M"===r:case"\u6708"===r:t+=30*i;break;case"Y"===r:case"\u5e74"===r:t+=365*i}}),t)}},20:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i={formatNumber(e,t="###,###,###,###.00"){if(void 0===e)return"";const s=(e,t,s)=>{if(""===e||void 0===e)return""===t||void 0===t?"":t;let i="",r="",o="",n=0;s||(e=e.split("").reverse().join(""),t=t.split("").reverse().join(""));let a=0;for(let s=0;s<t.length;s++,a++)if(r=e.charAt(a),void 0!==r)switch(i=t.charAt(s),i){case"#":o+=r,n=s;break;case"0":o=r||r===i?o+r:o+0,n=s;break;case".":case",":o+=r===i?r:(a--,i);break;default:o+=i,a--}return a!==e.length&&"0"!==t.charAt(t.length-1)&&n!==t.length&&"0"!==t.charAt(n)&&(o=o.substr(0,n+1)+e.substr(a)+o.substr(n+1)),o=(s?o:o.split("").reverse().join("")).replace(/(^,)|(,$)|(,,+)/g,""),","===o.substr(0,1)&&(o=o.substr(1)),"-,"===o.substr(0,2)&&(o="-"+o.substr(2)),o},i=e.toString();if(0===i.length)return"";let r=parseFloat(i);if(isNaN(r))return i;if(!t)return i;const o=t.split("."),n=i.split(".");return o.length>1?s(n[0],o[0])+"."+s(n[1],o[1],1):s(n[0],o[0])},formatSize(e,t=!1,s=""){let i,r=parseFloat(e);if(isNaN(r))return"";if(r<0)return"N/A";if(0===r)return t?"":"speed"===s?"0.00 KiB/s":"0.00";let o="KiB",n="###,###,###,###.00 ",a="###,###,###,###.000 ";return r<1e3*Math.pow(2,10)?(i=r/Math.pow(2,10),o="KiB"):r<1e3*Math.pow(2,20)?(i=r/Math.pow(2,20),o="MiB"):r<1e3*Math.pow(2,30)?(i=r/Math.pow(2,30),o="GiB"):r<1e3*Math.pow(2,40)?(i=r/Math.pow(2,40),o="TiB",n=a):r<1e3*Math.pow(2,50)?(i=r/Math.pow(2,50),o="PiB",n=a):r<1e3*Math.pow(2,60)?(i=r/Math.pow(2,60),o="EiB",n=a):(i=r/Math.pow(2,70),o="ZiB",n=a),"speed"===s&&(o+="/s"),this.formatNumber(i,n)+o},formatSizetoPrecision(e,t=!1,s=""){let i,r=parseFloat(e);if(isNaN(r))return"";if(r<0)return"N/A";if(0===r)return t?"":"speed"===s?"0.00 KiB/s":"0.00";let o="KiB";return r<1e3*Math.pow(2,10)?(i=r/Math.pow(2,10),o="KiB"):r<1e3*Math.pow(2,20)?(i=r/Math.pow(2,20),o="MiB"):r<1e3*Math.pow(2,30)?(i=r/Math.pow(2,30),o="GiB"):r<1e3*Math.pow(2,40)?(i=r/Math.pow(2,40),o="TiB"):r<1e3*Math.pow(2,50)?(i=r/Math.pow(2,50),o="PiB"):r<1e3*Math.pow(2,60)?(i=r/Math.pow(2,60),o="EiB"):(i=r/Math.pow(2,70),o="ZiB"),"speed"===s&&(o+="/s"),i.toPrecision(4)+" "+o},formatSizeWithNegative(e,t=!1,s=""){let i=e=parseFloat(e);e<0&&(i=-i);let r=this.formatSize(i,t,s);return e<0&&(r="- "+r),r},formatSpeed(e,t=!1){return this.formatSize(e,t,"speed")},parseURL(e){var t=document.createElement("a");return t.href=e,{source:e,protocol:t.protocol.replace(":",""),host:t.hostname,port:t.port,query:t.search,params:function(){for(var e,s={},i=t.search.replace(/^\?/,"").split("&"),r=i.length,o=0;o<r;o++)i[o]&&(s[(e=i[o].split("="))[0]]=e[1]);return s}(),hash:t.hash.replace("#",""),path:t.pathname.replace(/^([^/])/,"/$1"),segments:t.pathname.replace(/^\//,"").split("/"),origin:`${t.protocol}//${t.hostname}`+(t.port?":"+t.port:"")}},formatIMDbId:e=>(Number(e)&&(e.length<7&&(e=e.padStart(7,"0")),e="tt"+e),e),timeAgoToNumber(e){let t=e.trim().match(/^([\d.]+).+?((year|month|week|day|hour|min|minute)s?)( +ago)?(.+)?$/i);if(!t)return 0;let s=new Date,i=t[3],r=Math.round(parseFloat(t[1])),o=new Date;switch(i.toLowerCase()){case"year":o=new Date(s.setFullYear(s.getFullYear()-r));break;case"month":o=new Date(s.setMonth(s.getMonth()-r));break;case"day":o=new Date(s.setDate(s.getDate()-r));break;case"week":o=new Date(s.setDate(s.getDate()-7*r));break;case"hour":o=new Date(s.setHours(s.getHours()-r));break;case"min":case"minute":o=new Date(s.setMinutes(s.getMinutes()-r))}return o.getTime()},formatInteger(e){return this.formatNumber(e,"###,###,###,###")}}},207:function(e,t){},209:function(e,t){},218:function(e,t){},220:function(e,t){},246:function(e,t){},247:function(e,t){},252:function(e,t){},254:function(e,t){},261:function(e,t){},280:function(e,t){},29:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(0),r=s(56),o=s.n(r);class n{constructor(e){this.lastTime=0,this.startTime=0,this.status=0,this.statusText="",this.url="",this.requestMethod=i.n.GET,this.postData=null,this.fileName="",this.loaded=0,this.total=0,this.percent=0,this.speed=0,this.showSpeed="",this.onProgress=function(){},this.onCompleted=function(){},this.onError=function(){},this.onStart=function(){},this.getDataOnly=!1,this.timeout=0,this.xhr=new XMLHttpRequest,this.fileName=e.fileName||"",this.url=e.url,this.getDataOnly=e.getDataOnly||!1,this.timeout=e.timeout||0,this.requestMethod=e.method||i.n.GET}start(){this.lastTime=+new Date,this.startTime=this.lastTime,this.statusText="\u6570\u636e\u51c6\u5907\u4e2d\u2026\u2026",this.timeout>0&&(this.xhr.timeout=this.timeout),this.xhr.open(this.requestMethod,this.url,!0),this.xhr.responseType="blob",this.xhr.onreadystatechange=()=>{switch(this.xhr.readyState){case 4:switch(this.xhr.status){case 200:case 302:this.content=this.xhr.response,this.downloadCompleted();break;default:0!=this.xhr.status&&this.downloadError(`[${this.url}] \u4e0b\u8f7d\u5931\u8d25\uff0c\u8fd4\u56de\u7684\u72b6\u6001\u7801\u4e3a\uff1a${this.xhr.status}`)}break;case 2:var e=this.xhr.getResponseHeader("Content-Disposition");!e||this.fileName||this.getDataOnly||(this.fileName=this.getFileName(e))}},this.xhr.onprogress=e=>{this.loaded=e.loaded,this.total=e.total,this.percent=(e.loaded/e.total*100).toFixed(2),this.lastTime=+new Date,this.speed=this.loaded/(this.startTime-this.lastTime),this.updateProgress()},this.xhr.onerror=e=>{this.downloadError(e)},this.xhr.ontimeout=()=>{this.downloadError(`[${this.url}] \u4e0b\u8f7d\u8d85\u65f6`)};var e=null;this.postData&&(e=$.param(this.postData)),this.requestMethod==i.n.POST&&this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.xhr.send(e),this.onStart&&this.onStart.call(this)}getFileName(e=""){let t,s=e.split(";"),i={},r="";for(let e=0;e<s.length;e++){let t=s[e].replace(" ","").split("=");2==t.length&&(i[t[0]]=t[1].trim())}if(t=i["filename*"]){let e=t.lastIndexOf("'");r=t.substr(e+1)}else r=i.filename;return r=r.replace(/"/g,""),decodeURI(r)}downloadCompleted(){this.loaded>0&&!this.getDataOnly&&o.a.saveAs(this.content,this.fileName),this.onCompleted&&this.onCompleted.call(this)}downloadError(e){this.onError&&this.onError.call(this,e)}updateProgress(){this.onProgress&&this.onProgress.call(this,this.loaded,this.total,this.speed)}}},3:function(e,t,s){"use strict";s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return p}));var i=s(11),r=s(19),o=s.n(r),n=s(0),a=s(1);s(85);let c="",h=!1;try{let e=chrome.runtime;h=!0,c=e.getManifest().options_ui.page.replace("index.html",""),c&&"/"==c.substr(-1)&&(c=c.substr(0,c.length-1)),c||(c="chrome-extension://"+chrome.runtime.id)}catch(e){h=!1}const l=h?(h?c:"")+"/resource":`http://${window.location.hostname}:8001`;let u={host:l,schemas:l+"/schemas.json",schemaConfig:l+"/schemas/{$schema}/config.json",sites:l+"/sites.json",siteConfig:l+"/sites/{$site}/config.json",clients:l+"/clients.json",clientConfig:l+"/clients/{$client}/config.json",latestReleases:"https://api.github.com/repos/pt-plugins/PT-Plugin-Plus/releases/latest",systemConfig:l+"/systemConfig.json"};const d={debugMode:!1,scriptQueues:[],isExtensionMode:h,cache:{localStorage:new i.a,cacheKey:n.f.cache,contents:{},expires:86400,init(e){d.debugMode&&console.log("cache.init"),this.localStorage.get(this.cacheKey,t=>{if(t){let e=t.expires;e&&new Date>new Date(e)||d.debugMode?this.contents={}:this.contents=t}e&&e()})},get(e){return this.contents?this.contents[o()(e)]:null},set(e,t){this.contents[o()(e)]=t,this.contents.update=(new Date).getTime(),this.contents.expires=(new Date).getTime()+this.expires,this.localStorage.set(this.cacheKey,this.contents)},clear(){this.contents={},this.localStorage.set(this.cacheKey,this.contents)},getLastUpdateTime(){return new Promise((e,t)=>{this.localStorage.get(this.cacheKey,s=>{if(s){let t=s.update;e(t||0)}else t()})})}},addScript(e){d.debugMode&&console.log("addScript",e),this.scriptQueues.push(e)},applyScripts(){let e=this.scriptQueues.shift();e&&this.execScript(e).then(()=>{this.applyScripts()})},execScript(e){return new Promise((t,s)=>{switch(e.type){case"code":this.runScript(e.content),t();break;default:{let i=e.content||e;"http"!==i.substr(0,4)&&("/"!==i.substr(0,1)&&(i="/"+i),i=`${p.host}${i}`);let r=this.cache.get(i);try{r?(this.runScript(r),t()):(console.log("execScript: %s",i),$.ajax({url:i,dataType:"text"}).done(e=>{this.runScript(e),this.cache.set(i,e),t()}).fail((e,t,i)=>{e.responseJSON&&e.responseJSON.code&&e.responseJSON.msg?s(e.responseJSON.msg+" ("+e.responseJSON.code+")"):s(t+", "+i)}))}catch(e){s(e)}}}})},runScript(e,t=window){eval.call(t,e)},applyStyle(e){return new Promise((t,s)=>{let i=$("<style/>").appendTo(document.body);switch(e.type){case"file":{let s=e.content;"http"!==s.substr(0,4)&&("/"!==s.substr(0,1)&&(s="/"+s),s=`${p.host}${s}`);let r=this.cache.get(s);r?(i.html(r),t()):$.get(s,e=>{i.html(e),this.cache.set(s,e),t()},"text");break}default:i.html(e.content),t()}})},getScriptContent(e){let t=`${p.host}/${e}`;return t="http"===e.substr(0,4)?e:t.replace("resource//","resource/"),d.debugMode&&console.log("getScriptContent",t),$.ajax({url:t,dataType:"text"})},createErrorMessage:e=>({type:n.g.error,msg:e,success:!1}),showNotifications(e,t=3e3){a.a.showNotifications(e,t)},getInstallType:()=>new Promise((e,t)=>{chrome&&chrome.management?chrome.management.getSelf(t=>{t.updateUrl&&t.updateUrl.indexOf("pt-plugins/PT-Plugin-Plus")>0?e(n.j.crx):e(t.installType)}):t()})};d.cache.init();const p=u},30:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return InfoParser}));var _interface_common__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),dayjs__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(22),dayjs__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(dayjs__WEBPACK_IMPORTED_MODULE_1__),_service_public__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),dayjs_plugin_customParseFormat__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(169),dayjs_plugin_customParseFormat__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(dayjs_plugin_customParseFormat__WEBPACK_IMPORTED_MODULE_3__),dayjs_plugin_advancedFormat__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(170),dayjs_plugin_advancedFormat__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(dayjs_plugin_advancedFormat__WEBPACK_IMPORTED_MODULE_4__);dayjs__WEBPACK_IMPORTED_MODULE_1___default.a.extend(dayjs_plugin_customParseFormat__WEBPACK_IMPORTED_MODULE_3___default.a),dayjs__WEBPACK_IMPORTED_MODULE_1___default.a.extend(dayjs_plugin_advancedFormat__WEBPACK_IMPORTED_MODULE_4___default.a);class InfoParser{constructor(e){this.service=e}getResult(e,t){let s={};if(e)for(const i in t.fields)if(t.fields.hasOwnProperty(i)){let r=t.fields[i],o=this.getFieldData(e,r,t);null!=o&&(s[i]=o)}return s}debug(...e){this.service?this.service.debug(...e):_service_public__WEBPACK_IMPORTED_MODULE_2__.a.debug(...e)}getFieldData(content,config,rule){let query,selectorIndex=0,selectors=[];if("string"==typeof config.selector)selectors.push(config.selector);else{if(!config.selector||!config.selector.length)return void 0===config.value?null:config.value;selectors=config.selector}selectors.some(selector=>{try{switch(rule.dataType){case _interface_common__WEBPACK_IMPORTED_MODULE_0__.o.JSON:if(query=""==selector?content:"["==selector.substr(0,1)?eval("content"+selector):eval("content."+selector),null!=query)return!0;break;case _interface_common__WEBPACK_IMPORTED_MODULE_0__.o.TEXT:case _interface_common__WEBPACK_IMPORTED_MODULE_0__.o.HTML:default:if(""==selector?query=content:(query=content.find(selector),0==query.length&&(query=content.filter(selector))),query.length>0)return!0}selectorIndex++}catch(e){return this.debug("InfoParser.getFieldData.Error",selector,e.message,e.stack),!0}});let result=null,dateTime=dayjs__WEBPACK_IMPORTED_MODULE_1___default.a,_self=this;if(null!=query)if(config.attribute||config.filters||config.switchFilters){let filters;config.attribute&&rule.dataType!=_interface_common__WEBPACK_IMPORTED_MODULE_0__.o.JSON&&(query=query.attr(config.attribute)),filters=config.switchFilters?config.switchFilters[selectorIndex]||null:config.filters,filters&&filters.every(filter=>{try{query=eval(filter)}catch(e){return this.debug("InfoParser.filter.Error",filter,e.message,e.stack),query=null,!1}return!0}),result=query}else switch(rule.dataType){case _interface_common__WEBPACK_IMPORTED_MODULE_0__.o.JSON:result=query;break;default:result=query.text().trim()}return result}getTotalSize(e){let t=0;return e.forEach(e=>{let s=e.match(/^(\d*\.?\d+)(.*[^ZEPTGMK])?([ZEPTGMK](B|iB)?)$/i);if(!s)return;let i=parseFloat(s[1]),r=s[3].toLowerCase();switch(!0){case/ki?b/.test(r):t+=i*Math.pow(2,10);break;case/mi?b/.test(r):t+=i*Math.pow(2,20);break;case/gi?b/.test(r):t+=i*Math.pow(2,30);break;case/ti?b?/.test(r):t+=i*Math.pow(2,40);break;case/pi?b?/.test(r):t+=i*Math.pow(2,50);break;case/ei?b?/.test(r):t+=i*Math.pow(2,60);break;case/zi?b?/.test(r):t+=i*Math.pow(2,70)}}),t}formatIMDbId(e){return Number(e)&&(e.length<7&&(e=e.padStart(7,"0")),e="tt"+e),e}}},356:function(e,t){},374:function(e,t,s){"use strict";s.r(t);s(176);var i=s(0),r=s(3),o=s(11);class n{constructor(){this.arrayValues={}}isArray(e){return"[object Array]"==Object.prototype.toString.call(e)}clear(){return new Promise((e,t)=>{try{chrome.storage.sync.clear(),chrome.runtime.lastError?t(chrome.runtime.lastError):e()}catch(e){t(e)}})}_set(e,t,s=0,i,r){let o=t,n=e,a=-1;if(this.isArray(t)){if(0==s)return s=t.length,void this._set(e+"__count",s,0,()=>{this._set(e,t,s,i,r)},r);a=t.length-1,o=t.pop(),n=`${e}_${a}`}chrome.storage.sync.set({[n]:o},()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):a>0?this._set(e,t,s,i,r):i(t)})}_get(e,t=!1,s=0,i,r){if(t)return void this._get(e+"__count",!1,0,t=>{t>0?(this.arrayValues[e]=[],this._get(e,!1,t,i,r)):this._get(e,!1,0,i,r)},t=>{"\u53c2\u6570\u4e0d\u5b58\u5728"==t?this._get(e,!1,0,i,r):r&&r(t)});let o=e;s>0&&(o=`${e}_${s-1}`);try{chrome.storage.sync.get(o,t=>{let n=null;try{if(!t[o])return void r("\u53c2\u6570\u4e0d\u5b58\u5728");n=t[o]}catch(e){return void r(e)}--s<=0?this.arrayValues[e]?(this.arrayValues[e].push(n),i(this.arrayValues[e]),delete this.arrayValues[e]):i(n):(this.arrayValues[e].push(n),this._get(e,!1,s,i,r))})}catch(e){r(e)}}set(e,t){return new Promise((s,i)=>{if(chrome.storage&&chrome.storage.sync)try{this._set(e,t,0,()=>{s(t)},e=>{i(e)})}catch(e){i(e)}else i("chrome.storage \u4e0d\u5b58\u5728")})}get(e){return new Promise((t,s)=>{if(chrome.storage&&chrome.storage.sync)try{this._get(e,!0,0,e=>{t(e)},e=>{s(e)})}catch(e){s(e)}else s("chrome.storage \u4e0d\u5b58\u5728")})}}var a=s(1),c=s(22),h=s.n(c),l=s(29);class u{constructor(e){this.options=e,this.serverURL="",this.serverURL=this.options.address,"/"!==this.serverURL.substr(-1)&&(this.serverURL+="/")}request(e,t=i.n.GET,s){return new Promise((r,o)=>{let n={url:this.serverURL+""+e,method:t,dataType:"json",data:s};t===i.n.POST&&(n.processData=!1,n.contentType=!1),$.ajax(n).done(e=>{r(e)}).fail(e=>{o(e)})})}create(){return new Promise((e,t)=>{this.request("create").then(s=>{s&&s.data?e(s.data):t()}).catch(e=>{t(e)})})}add(e){return new Promise((t,s)=>{this.request(this.options.authCode+"/add",i.n.POST,e).then(e=>{e&&!0===e.data?t(!0):s(!1)}).catch(e=>{s(e)})})}get(e){return new Promise((t,s)=>{let i=`${this.serverURL}${this.options.authCode}/get/${e}`,r=new l.a({url:i,getDataOnly:!0});r.onCompleted=()=>{t(r.content)},r.onError=e=>{console.log(e),s(e)},r.start()})}delete(e){return new Promise((t,s)=>{this.request(`${this.options.authCode}/delete/${e}`,i.n.POST).then(e=>{e&&e.data?t(e.data):s(!1)}).catch(e=>{s(e)})})}list(e={}){return new Promise((t,s)=>{this.request(this.options.authCode+"/list",i.n.GET,e).then(e=>{e&&e.data?t(e.data):s(!1)}).catch(e=>{s(e)})})}ping(){return new Promise((e,t)=>{this.request(this.options.authCode+"/list",i.n.GET,{pageSize:1}).then(()=>{e(!0)}).catch(e=>{t(e)})})}}var d=s(165);class p{constructor(e){this.options=e,this.initServer()}initServer(){this.service=Object(d.createClient)(this.options.address,{username:this.options.loginName,password:this.options.loginPwd,digest:!!this.options.digest||void 0})}list(e={}){return new Promise((t,s)=>{this.service.getDirectoryContents("/",{glob:"*.zip"}).then(s=>{console.log(s);let r=[],o=e.orderMode||i.r.desc;s&&s.length>0&&s.forEach(e=>{r.push({name:e.basename,size:e.size,type:e.type,time:new Date(e.lastmod).getTime()})}),t(r.sort((t,s)=>{let r,n;switch(e.orderBy){case i.q.name:r=t.name,n=s.name;break;case i.q.size:r=t.size,n=s.size;break;default:r=t.time,n=s.time}return o===i.r.desc?1==r.toString().localeCompare(n)?-1:1:r.toString().localeCompare(n)}))}).catch(e=>{s(e)})})}get(e){return new Promise((t,s)=>{this.service.getFileContents("/"+e).then(e=>{t(e)}).catch(e=>{s(e)})})}add(e){return new Promise((t,s)=>{this.service.putFileContents(e.get("name"),e.get("data")).then(e=>{e?t(!0):s(!1)}).catch(e=>{s(e)})})}delete(e){return new Promise((t,s)=>{this.service.deleteFile("/"+e).then(e=>{e?t(e.data):s(!1)}).catch(e=>{s(e)})})}ping(){return new Promise((e,t)=>{this.service.getDirectoryContents("/").then(()=>{e(!0)}).catch(e=>{t(e)})})}}var g=s(86),_=s.n(g),m=s(19),f=s.n(m),v=s(58);class y{createHash(e){const t=e.length,s=[];let i={hash:"",keyMap:[],length:t};for(let r=0;r<32;r++){let r=Math.round(t*Math.random());s.push(e.substr(r,1)),i.keyMap.push(r)}return i.hash=f()(s.join("")),i}createBackupFileBlob(e){return new Promise((t,s)=>{try{const s=new _.a;e.options.system&&delete e.options.system;const r=e.options,o=r.encryptBackupData?r.encryptSecretKey:"";r.encryptSecretKey&&delete e.options.encryptSecretKey;const n=this.encryptData(e.options,o),c=this.encryptData(e.userData,o);s.file("options.json",n),s.file("userdatas.json",c);const h={checkInfo:this.createHash(n+c),version:a.a.getVersion(),time:(new Date).getTime(),encryptMode:o?i.i.AES:""};s.file("manifest.json",JSON.stringify(h)),e.collection&&s.file("collection.json",this.encryptData(e.collection,o)),e.cookies&&s.file("cookies.json",this.encryptData(e.cookies,o)),e.searchResultSnapshot&&s.file("searchResultSnapshot.json",this.encryptData(e.searchResultSnapshot,o)),e.keepUploadTask&&s.file("keepUploadTask.json",this.encryptData(e.keepUploadTask,o)),e.downloadHistory&&s.file("downloadHistory.json",this.encryptData(e.downloadHistory,o)),s.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}).then(e=>{t(e)})}catch(e){s(e)}})}loadZipData(e,t="\u8bf7\u8f93\u5165\u5bc6\u94a5\uff1a",s=""){return new Promise((r,o)=>{_.a.loadAsync(e).then(e=>{let t=[];return t.push(e.file("manifest.json").async("text")),t.push(e.file("options.json").async("text")),t.push(e.file("userdatas.json").async("text")),e.file("collection.json")&&t.push(e.file("collection.json").async("text")),e.file("cookies.json")&&t.push(e.file("cookies.json").async("text")),e.file("searchResultSnapshot.json")&&t.push(e.file("searchResultSnapshot.json").async("text")),e.file("keepUploadTask.json")&&t.push(e.file("keepUploadTask.json").async("text")),e.file("downloadHistory.json")&&t.push(e.file("downloadHistory.json").async("text")),Promise.all(t)}).then(e=>{const n=JSON.parse(e[0]);if(console.log(n),n.encryptMode){if(s&&null===this.decryptData(e[1],s)&&(s=""),!s){let r=window.prompt(t);if(!r)return void o(i.s.needSecretKey);if(s=r,null===this.decryptData(e[1],s))return void o(i.s.errorSecretKey)}}else s="";const c={manifest:n,options:this.decryptData(e[1],s),datas:this.decryptData(e[2],s)};e.length>3&&(c.collection=this.decryptData(e[3],s)),e.length>4&&a.a.checkOptionalPermission("cookies")&&(c.cookies=this.decryptData(e[4],s)),e.length>5&&(c.searchResultSnapshot=this.decryptData(e[5],s)),e.length>6&&(c.keepUploadTask=this.decryptData(e[6],s)),e.length>7&&(c.downloadHistory=this.decryptData(e[7],s)),this.checkData(c.manifest,e[1]+e[2])?r(c):o("error")}).catch(e=>{console.log(e),o(e)})})}checkData(e,t){if(!e)return!1;if(!e.checkInfo)return!1;const s=e.checkInfo;if(t.length!==s.length)return!1;const i=[];try{if(32!==s.keyMap.length)return!1;for(let e=0;e<32;e++){let r=s.keyMap[e];i.push(t.substr(r,1))}if(f()(i.join(""))===s.hash)return!0}catch(e){}return!1}encryptData(e,t=""){return t?this.encrypt(JSON.stringify(e),t):JSON.stringify(e)}decryptData(e,t=""){if(!t)return JSON.parse(e);try{return JSON.parse(this.decrypt(e,t))}catch(e){return null}}encrypt(e,t=""){return v.AES.encrypt(e,t).toString()}decrypt(e,t=""){return v.AES.decrypt(e,t).toString(v.enc.Utf8)}}var b=s(85),E=s(56),P=s.n(E);var D=class{constructor(e){this.service=e,this.name=i.f.default,this.localStorage=new o.a,this.syncStorage=new n,this.favicon=new b.a(this.service),this.schemas=[],this.sites=[],this.clients=[],this.publicSites=[],this.requestCount=0,this.backupFileParser=new y,this.options={exceedSizeUnit:i.t.GiB,sites:[],clients:[],backupServers:[],system:{},allowDropToSend:!0,allowSelectionTextSearch:!0,needConfirmWhenExceedSize:!0,exceedSize:10,search:{rows:50,timeout:3e4,saveKey:!0},connectClientTimeout:3e4,rowsPerPageItems:[10,20,50,100,200,{text:"$vuetify.dataIterator.rowsPerPageAll",value:-1}],searchSolutions:[],navBarIsOpen:!0,showMoiveInfoCardOnSearch:!0,beforeSearchingOptions:{getMovieInformation:!0,maxMovieInformationCount:5,searchModeForItem:i.d.id},showToolbarOnContentPage:!0,downloadFailedRetry:!1,downloadFailedFailedRetryCount:3,downloadFailedFailedRetryInterval:5,batchDownloadInterval:0,enableBackgroundDownload:!1,position:i.m.right,encryptBackupData:!1,allowSaveSnapshot:!0},this.uiOptions={},this.reload()}reload(){r.b.cache.clear(),this.getSystemConfig()}save(e){e&&(this.options=e),this.localStorage.set(this.name,this.cleaningOptions(this.options))}getFavicons(){return new Promise((e,t)=>{let s=[];this.sites.forEach(e=>{s.push(e.activeURL||e.url||"")}),this.options.sites&&this.options.sites.forEach(e=>{s.push(e.activeURL||e.url||"")}),this.favicon.gets(s).then(t=>{t.forEach(e=>{let t=this.options.sites.find(t=>{var s;let i=[t.url].concat(t.cdn,null===(s=t.formerHosts)||void 0===s?void 0:s.map(e=>"//"+e));return t.host==e.host||i.join("").indexOf("//"+e.host)>-1});t&&(t.icon=e.data)}),this.save(),this.service.options=this.options,e(this.options)}).catch(e=>{this.service.debug(e),t(e)})})}getFavicon(e,t=!1){return new Promise((s,i)=>{this.favicon.get(e,t).then(e=>{let t=this.options.sites.find(t=>{var s;let i=[t.url].concat(t.cdn,null===(s=t.formerHosts)||void 0===s?void 0:s.map(e=>"//"+e));return t.host==e.host||i.join("").indexOf("//"+e.host)>-1});t&&(t.icon=e.data,this.save(),this.service.options=this.options),s(e)}).catch(e=>{this.service.debug(e),i(e)})})}cleaningOptions(e){let t=JSON.parse(JSON.stringify(e));return t.sites&&t.sites.forEach(e=>{this.sites.find(t=>t.host==e.host)&&(["categories","selectors","patterns","torrentTagSelectors","icon","activeURL","searchEntryConfig","schema","supportedFeatures","mergeSchemaTagSelectors"].forEach(t=>{let s=e;s[t]&&delete s[t]}),e.searchEntry&&e.searchEntry.forEach((t,s)=>{t.isCustom||(e.searchEntry[s]={name:t.name,enabled:t.enabled})})),a.a.isExtensionMode&&e.icon&&"data:image"===e.icon.substr(0,10)&&delete e.icon}),t.clients&&t.clients.forEach(e=>{["pathDescription","description","warning","scripts","ver","icon"].forEach(t=>{e[t]&&delete e[t]})}),t}read(){return new Promise((e,t)=>{this.localStorage.get(i.f.uiOptions,e=>{if(e){let t=Object.assign({},this.uiOptions);this.uiOptions=Object.assign(t,e)}}),this.loadConfig(e)})}loadConfig(e){this.requestCount>0?setTimeout(()=>{this.loadConfig(e)},100):this.localStorage.get(this.name,t=>{this.resetRunTimeOptions(t),e&&e(this.options)})}resetRunTimeOptions(e){if(e){e.system&&delete e.system;let t=Object.assign({},this.options);this.options=Object.assign(t,e)}this.options.locale||(this.options.locale=navigator.language||"zh-CN"),this.options.system={schemas:this.schemas,sites:this.sites,clients:this.clients,publicSites:this.publicSites},this.upgradeSites(),this.options.sites&&this.options.sites.length&&this.sites.forEach(e=>{let t=this.options.sites.findIndex(t=>t.host===e.host);if(t>-1){let s=Object.assign(Object.assign({},e),this.options.sites[t]);e.categories&&(s.categories=e.categories),e.schema&&(s.schema=e.schema),!e.torrentTagSelectors&&s.torrentTagSelectors?delete s.torrentTagSelectors:s.torrentTagSelectors=e.torrentTagSelectors,!e.patterns&&s.patterns?delete s.patterns:s.patterns=e.patterns,!e.levelRequirements&&s.levelRequirements?delete s.levelRequirements:s.levelRequirements=e.levelRequirements,s.searchEntry&&e.searchEntry?e.searchEntry.forEach(e=>{if(s.searchEntry){let t=s.searchEntry&&s.searchEntry.findIndex(t=>t.name==e.name&&!t.isCustom);null!=t&&t>-1?s.searchEntry[t]=Object.assign(Object.assign({},e),{enabled:s.searchEntry[t].enabled}):s.searchEntry.push(Object.assign({},e))}}):e.searchEntry&&(s.searchEntry=e.searchEntry),e.icon||s.icon||(s.icon=s.url+"/favicon.ico"),this.options.sites[t]=s}}),this.options.sites.forEach(e=>{e.cdn&&e.cdn.length>0?(e.activeURL=e.cdn[0],e.cdn=this.arrayUnique(e.cdn)):e.activeURL=e.url,null==e.priority&&(e.priority=100)}),this.options.clients&&this.options.clients.length&&this.options.clients.forEach((e,t)=>{let s=this.clients.find(t=>t.type===e.type);s&&(this.options.clients[t]=Object.assign(Object.assign({},s),this.options.clients[t]))}),a.a.isExtensionMode&&this.getFavicons(),console.log(this.options)}arrayUnique(e){let t=[],s={};return e.forEach(e=>{s[e]||(t.push(e),s[e]=1)}),t}upgradeSites(){this.sites.forEach(e=>{if(!e.host)return;let t=e.formerHosts,s=e.host;t&&t.length>0&&t.forEach(t=>{let i=this.options.sites.find(e=>e.host===t);i&&(console.log("upgradeSites.site",i,s),i.host=s,i.url=e.url,e.icon||i.icon?i.icon=e.icon:i.icon=i.url+"/favicon.ico"),this.options.searchSolutions&&this.options.searchSolutions.forEach(e=>{e.range.forEach(e=>{e.host==t&&(console.log("upgradeSites.searchSolutions",e.host,s),e.host=s)})}),this.options.clients&&this.options.clients.length>0&&this.options.clients.forEach(e=>{let i=e.paths;if(i)for(const r in i)if(r==t&&i.hasOwnProperty(r)){console.log("upgradeSites.client.paths",e.name,r,s);const t=i[r];i[s]=Object.assign([],t),delete i[r]}})})})}readUIOptions(){return new Promise((e,t)=>{this.localStorage.get(i.f.uiOptions,t=>{if(t){let e=Object.assign({},this.uiOptions);this.uiOptions=Object.assign(e,t)}e(this.uiOptions)})})}saveUIOptions(e){return new Promise((t,s)=>{this.localStorage.set(i.f.uiOptions,e||this.uiOptions),t()})}getSystemConfig(){this.schemas=[],this.sites=[],this.clients=[],this.publicSites=[],this.getContentFromApi(""+r.a.systemConfig).then(e=>{e&&(this.schemas=e.schemas,this.sites=e.sites,this.clients=e.clients,this.publicSites=e.publicSites)})}getSchemas(){this.schemas=[],this.getContentFromApi(""+r.a.schemas).then(e=>{e.length&&e.forEach(e=>{"dir"===e.type&&this.addSchema(r.a.schemaConfig.replace(/\{\$schema\}/g,e.name))})})}addSchema(e){this.getContentFromApi(e).then(e=>{e&&e.name&&this.schemas.push(e)})}getSites(){this.sites=[],this.getContentFromApi(r.a.sites).then(e=>{e.length&&e.forEach(e=>{"dir"===e.type&&this.addSite(r.a.siteConfig.replace(/\{\$site\}/g,e.name))})})}addSite(e){this.getContentFromApi(e).then(e=>{e&&e.name&&this.sites.push(e)})}getClients(){this.clients=[],this.getContentFromApi(r.a.clients).then(e=>{e.length&&e.forEach(e=>{"dir"===e.type&&this.addClient(r.a.clientConfig.replace(/\{\$client\}/g,e.name))})})}addClient(e){this.getContentFromApi(e).then(e=>{e&&e.name&&this.clients.push(e)})}getContentFromApi(e){return a.a.updateBadge(++this.requestCount),new Promise((t,s)=>{let i=r.b.cache.get(e);if(i)return t(i),void a.a.updateBadge(--this.requestCount);$.getJSON(e).done(s=>{r.b.cache.set(e,s),a.a.updateBadge(--this.requestCount),t(s)}).fail(e=>{a.a.updateBadge(--this.requestCount),s&&s(e)})})}backupToGoogle(){return new Promise((e,t)=>{if(chrome.storage&&chrome.storage.sync){let s=this.cleaningOptions(this.options);s.system&&delete s.system;let i=Object.assign([],s.clients),o=Object.assign([],s.sites);delete s.clients,delete s.sites,this.syncStorage.set(this.name,s).then(()=>{this.syncStorage.set(this.name+".clients",i).then(()=>{this.syncStorage.set(this.name+".sites",o).then(()=>{e(this.options)}).catch(e=>{t(r.b.createErrorMessage(e))})}).catch(e=>{t(r.b.createErrorMessage(e))})}).catch(e=>{t(r.b.createErrorMessage(e))})}else t(r.b.createErrorMessage("chrome.storage \u4e0d\u5b58\u5728"))})}restoreFromGoogle(){return new Promise((e,t)=>{chrome.storage&&chrome.storage.sync?this.syncStorage.get(this.name).then(s=>{let i=Object.assign({},this.options.system),o=s;o.system=i,this.syncStorage.get(this.name+".clients").then(s=>{o.clients=s,this.syncStorage.get(this.name+".sites").then(t=>{o.sites=t,this.resetRunTimeOptions(o),this.save(),setTimeout(()=>{e(this.options)},300)}).catch(e=>{t(r.b.createErrorMessage(e))})}).catch(e=>{t(r.b.createErrorMessage(e))})}).catch(e=>{t(r.b.createErrorMessage(e))}):t(r.b.createErrorMessage("chrome.storage \u4e0d\u5b58\u5728"))})}getBackupRawData(){return new Promise((e,t)=>{try{const t=this.service.userData.get("",i.v.all),s=this.cleaningOptions(this.service.options);delete s.system;let r={options:s,userData:t,collection:{items:this.service.collection.items,groups:this.service.collection.groups},cookies:void 0,searchResultSnapshot:this.service.searchResultSnapshot.items,keepUploadTask:this.service.keepUploadTask.items,downloadHistory:void 0};const o=[];o.push(this.service.controller.downloadHistory.load()),this.service.options.allowBackupCookies&&a.a.checkOptionalPermission("cookies")&&o.push(this.getAllSiteCookies()),Promise.all(o).then(t=>{r.downloadHistory=t[0],t.length>1&&(r.cookies=t[1]),e(r)}).catch(()=>{e(r)})}catch(e){t(e)}})}createBackupFile(e){return new Promise((t,s)=>{this.getBackupFileBlob().then(s=>{P.a.saveAs(s,e||this.getNewBackupFileName()),t(!0)}).catch(e=>{s(e)})})}getBackupFileBlob(){return new Promise((e,t)=>{try{this.getBackupRawData().then(t=>{this.backupFileParser.createBackupFileBlob(t).then(t=>{e(t)})}).catch(e=>{t(e)})}catch(e){t(e)}})}getAllSiteCookies(){return new Promise((e,t)=>{a.a.checkPermissions(["cookies"]).then(()=>{const s=this.options.sites;if(s&&s.length>0){const i=[];s.forEach(e=>{i.push(this.getCookiesFromSite(e))}),Promise.all(i).then(t=>{e(t)}).catch(e=>{t(e)})}}).catch(e=>{t(e)})})}getCookiesFromSite(e){return new Promise((t,s)=>{const i=e.activeURL||e.url;chrome.cookies.getAll({url:i},r=>{chrome.runtime.lastError?s(chrome.runtime.lastError.message):(t({host:e.host,url:i,cookies:r}),console.log(r))})})}restoreCookies(e){return new Promise((t,s)=>{let i=[];const r=["name","value","domain","path","secure","httpOnly","expirationDate"];e.forEach(e=>{e.cookies.forEach(t=>{let s=a.a.clone(t);for(const e in s)s.hasOwnProperty(e)&&!r.includes(e)&&delete s[e];s.url=e.url,i.push(this.setCookies(s,e.host))})}),Promise.all(i).then(()=>{t()}).catch(()=>{t()})})}setCookies(e,t){return new Promise((s,i)=>{let r=a.a.getSiteFromHost(t,this.service.options);chrome.cookies.get({url:(r.activeURL||r.url)+"",name:e.name+""},r=>{let o=!1;const n=(new Date).getTime()/1e3;(null===r||r.expirationDate&&r.expirationDate<n)&&(o=!0),o?(e.expirationDate&&e.expirationDate<n&&(e.expirationDate=n+86400),chrome.cookies.set(e,e=>{chrome.runtime.lastError?i(chrome.runtime.lastError.message):(s(e),console.log(e))})):(console.log("\u8df3\u8fc7 %s: %s",t,e.name),s())})})}getNewBackupFileName(){return a.a.getNewBackupFileName()}backupToServer(e){return console.log("backupToServer",e,this.options.backupServers),new Promise((t,s)=>{const r=h()().valueOf(),o=this.getNewBackupFileName();let n=null;this.getBackupFileBlob().then(a=>{const c=new FormData;switch(c.append("name",o),c.append("data",a),e.type){case i.c.OWSS:n=new u(e);break;case i.c.WebDAV:n=new p(e);break;default:s("\u6682\u4e0d\u652f\u6301")}n&&n.add(c).then(e=>{t({time:r,fileName:o})}).catch(e=>{s(e)})}).catch(e=>{s(e)})})}restoreFromServer(e,t){return new Promise((s,r)=>{let o=null;switch(e.type){case i.c.OWSS:o=new u(e);break;case i.c.WebDAV:o=new p(e);break;default:r("\u6682\u4e0d\u652f\u6301")}o&&o.get(t).then(e=>{this.backupFileParser.loadZipData(e,this.service.i18n.t("settings.backup.enterSecretKey"),this.service.options.encryptSecretKey).then(e=>{s(e)}).catch(e=>{r(e)})}).catch(e=>{r(e)})})}getBackupListFromServer(e,t={}){return new Promise((s,r)=>{let o=null;switch(e.type){case i.c.OWSS:o=new u(e);break;case i.c.WebDAV:o=new p(e);break;default:r("\u6682\u4e0d\u652f\u6301")}o&&o.list(t).then(e=>{s(e)}).catch(e=>{r(e)})})}deleteFileFromBackupServer(e,t){return new Promise((s,r)=>{let o=null;switch(e.type){case i.c.OWSS:o=new u(e);break;case i.c.WebDAV:o=new p(e);break;default:r("\u6682\u4e0d\u652f\u6301")}o&&o.delete(t).then(e=>{s(e)}).catch(e=>{r(e)})})}testBackupServerConnectivity(e){return new Promise((t,s)=>{let r=null;switch(e.type){case i.c.OWSS:r=new u(e);break;case i.c.WebDAV:r=new p(e);break;default:s("\u6682\u4e0d\u652f\u6301")}r&&r.ping().then(e=>{t(e)}).catch(e=>{s(e)})})}},w=s(20),S=s(166);class T{constructor(){this.items=[],this.storage=new o.a,this.load()}load(){return new Promise((e,t)=>{this.storage.get(i.f.downloadHistory,t=>{this.items=t||[],e(this.items)})})}add(e,t="",s="",i=!0){let r={data:e,clientId:s,host:t,success:i,time:(new Date).getTime()};if(this.items){-1===this.items.findIndex(t=>t.data.url===e.url)&&(this.items.push(r),this.updateData())}else this.load().then(()=>{this.items.push(r),this.updateData()})}remove(e){return new Promise((t,s)=>{this.load().then(()=>{for(let t=this.items.length-1;t>=0;t--){let s=this.items[t];e.findIndex(e=>e.data.url===s.data.url)>=0&&this.items.splice(t,1)}this.updateData(),t(this.items)})})}clear(){return new Promise((e,t)=>{this.items=[],this.updateData(),e(this.items)})}reset(e){return new Promise((t,s)=>{e&&Array.isArray(e)?(this.items=e,this.updateData(),t(this.items)):s(!1)})}updateData(){this.storage.set(i.f.downloadHistory,this.items)}}var M=s(167),C=s(24),O=s.n(C),I=s(172);class k{constructor(){this.doubanApiURL="https://api.douban.com/v2",this.doubanFrodoApi="https://frodo.douban.com/api/v2",this.douban={frodo:{apiKeys:["054022eaeae0b00e0fc068c0c0a2102a"],entApiKeys:["054022eaeae0b00e0fc068c0c0a2102a"],methods:{movie:{search:this.doubanFrodoApi+"/search?q=$key$&count=$count$&apiKey=$apikey$",imdb:"https://omit.mkrobot.org/movie/infos/$imdbid$",subject:"https://omit.mkrobot.org/movie/infos/douban$id$"}}},common:{apiKeys:["02646d3fb69a52ff072d47bf23cef8fd","0b2bdeda43b5688921839c8ecb20399b","0dad551ec0f84ed02907ff5c42e8ec70","0df993c66c0c636e29ecbb5344252a4a"],entApiKeys:["0dad551ec0f84ed02907ff5c42e8ec70","02646d3fb69a52ff072d47bf23cef8fd"],methods:{movie:{search:this.doubanApiURL+"/movie/search?q=$key$&count=$count$&apikey=$apikey$",imdb:this.doubanApiURL+"/movie/imdb/$imdbid$?apikey=$apikey$",subject:this.doubanApiURL+"/movie/subject/$id$?apikey=$apikey$"}}}},this.omdbApiURL="https://www.omdbapi.com",this.omitApiURL="https://omit.mkrobot.org",this.omdbApiKeys=["e0d3039d","a67d9bce","6be019fc","4ee790e0","d82cb888","d58193b6","15c0aa3f","53acf36d","3a864b75","2892ab46","b507af90","7cf67120","85b2a90c","2896ff0a","aa4b9983","c4e08870","5d5c0049","79a462f2","e4c3fce8","918d70df","e94cb667","eb84d6d7","e192b5a","d62b4cf5","5e6442a3","9b1468c6"],this.doubanApiKeys=["02646d3fb69a52ff072d47bf23cef8fd","0b2bdeda43b5688921839c8ecb20399b","0dad551ec0f84ed02907ff5c42e8ec70","0df993c66c0c636e29ecbb5344252a4a"],this.doubanEntApiKeys=["0dad551ec0f84ed02907ff5c42e8ec70","02646d3fb69a52ff072d47bf23cef8fd"],this.omitApiKeys=["kiqMY6MC"],this.cache={base:{},ratings:{},doubanToIMDb:{},search:{}},this.timeout=3e3,this.doubanApi=this.douban.frodo,this.requsetQueue={}}getInfos(e){return/(douban\d+)/.test(e)?this.getInfoFromDoubanId(e.replace("douban","")):/^(tt\d+)$/.test(e)?this.getInfoFromIMDb(e):new Promise((e,t)=>{t("\u6682\u672a\u5b9e\u73b0")})}isIMDbId(e){return/^(tt\d+)$/.test(e)}getInfoFromIMDb(e){return new Promise((t,s)=>{if(this.isIMDbId(e)){let i=this.cache.base[e];if(i)return void t(i);let r=a.a.replaceKeys(this.doubanApi.methods.movie.imdb,{imdbid:e,apikey:this.getDoubanApiKey()});$.ajax({url:r,timeout:this.timeout}).done(s=>{let i;s&&(i=s.data||s),this.cache.base[e]=i,t(i)}).fail(e=>{s(e)})}else s("error IMDbId")})}getInfoFromDoubanId(e){return new Promise((t,s)=>{if(/^(\d+)$/.test(e)){let i=this.cache.base[e];if(i)return void t(i);let r=a.a.replaceKeys(this.doubanApi.methods.movie.subject,{id:e,apikey:this.getDoubanApiKey()});$.ajax({url:r,timeout:this.timeout}).done(s=>{let i;s&&(i=s.data||s),this.cache.base[e]=i,t(i)}).fail(e=>{s(e)})}else s("error douban id")})}getRatings(e){return new Promise((t,s)=>{if(this.isIMDbId(e)){let i=this.cache.ratings[e];if(i)return void t(i);let r=0;const o=()=>{let i=this.getOmdbApiKey(),n=`${this.omdbApiURL}/?i=${e}&apikey=${i}&tomatoes=true`;$.ajax({url:n,timeout:this.timeout}).done(n=>{if(n&&n.Error)return r++,r>=5?void s(n):(this.removeApiKey("omdb",i),void o());this.cache.ratings[e]=n,t(n)}).fail(e=>{s(e)})};o()}else s("error IMDbId")})}getOmdbApiKey(){return this.omdbApiKeys[Math.floor(Math.random()*this.omdbApiKeys.length)]}getDoubanApiKey(){return this.doubanApi.apiKeys[Math.floor(Math.random()*this.doubanApi.apiKeys.length)]}getDoubanEntApiKey(){return this.doubanApi.entApiKeys[Math.floor(Math.random()*this.doubanApi.entApiKeys.length)]}getIMDbIdFromDouban(e){return new Promise((t,s)=>{let i=this.cache.doubanToIMDb[e];if(i)return void t(i);let r=`${this.omitApiURL}/movie/${e}/douban/imdb`;this.requsetQueue[r]?s():(this.requsetQueue[r]=!0,$.ajax({url:r,timeout:this.timeout}).done(i=>{console.log("getIMDbIdFromDouban",i),i.data?(this.cache.doubanToIMDb[e]=i.data,t(i.data)):s(i)}).fail(e=>{s(e)}).always(()=>{delete this.requsetQueue[r]}))})}queryMovieInfoFromDouban(e,t=5){return this.isIMDbId(e)?this.getInfoFromIMDb(e):new Promise((t,s)=>{let i=this.cache.search[e];if(i)return void t(i);let r=`${this.omitApiURL}/movie/search/${e}`;this.requsetQueue[r]?s():(this.requsetQueue[r]=!0,$.ajax({url:r,timeout:this.timeout}).done(i=>{console.log("queryMovieInfoFromDouban",i),i.data?(this.cache.search[e]=i.data,t(i.data)):s(i)}).fail(e=>{s(e)}).always(()=>{delete this.requsetQueue[r]}))})}appendApiKey(e="",t){let s;switch(e){case"omdb":s=this.omdbApiKeys;break;case"douban":s=this.doubanApiKeys}t.forEach(e=>{e&&!s.includes(e)&&s.push(e)})}removeApiKey(e="",t){let s=[];switch(e){case"omdb":s=this.omdbApiKeys;break;case"douban":s=this.doubanApiKeys}let i=s.findIndex(e=>{if(e===t)return!0});-1!==i&&s.splice(i,1)}verifyOmdbApiKey(e){return new Promise((t,s)=>{let i=`${this.omdbApiURL}/?i=tt0111161&apikey=${e}&tomatoes=true`;$.ajax({url:i,timeout:this.timeout}).done(e=>{e&&e.Error?s(e.Error):t()}).fail(e=>{s(e)})})}verifyDoubanApiKey(e){return new Promise((t,s)=>{let i=`${this.doubanApiURL}/movie/imdb/tt0111161?apikey=${e}`;$.ajax({url:i,timeout:this.timeout}).done(e=>{e&&e.title?t():s(e.Error)}).fail(e=>{s(e)})})}getTopSearches(e=9){return new Promise((t,s)=>{$.ajax({url:`${this.omitApiURL}/movie/top/${e}?apikey=${this.omitApiKeys[0]}`,timeout:this.timeout}).then(e=>{e&&e.data?t(e.data):s()}).catch(e=>{s(e)})})}}var U=s(173),R=s.n(U);class A{constructor(e){this.service=e,this.options={sites:[],clients:[]},this.defaultClientOptions={},this.siteDefaultClients={},this.optionsTabId=0,this.downloadHistory=new T,this.clients={},this.searcher=new M.a(this.service),this.userService=new I.a(this.service),this.movieInfoService=new k,this.clientController=new S.a,this.isInitialized=!1,this.contentPages=[],this.debuggerTabId=0,this.imageBase64Cache={},this.downloadFailedRetriesCache={},this.torrentInfosCache={}}init(e){this.reset(e),this.isInitialized=!0}reset(e){this.options=e,this.clientController.init(e),this.searcher.options=e,this.initDefaultClient(),this.siteDefaultClients={},e.connectClientTimeout&&(this.movieInfoService.timeout=e.connectClientTimeout),this.options.apiKey&&(this.options.apiKey.omdb&&this.options.apiKey.omdb.length>0&&this.movieInfoService.appendApiKey("omdb",this.options.apiKey.omdb),this.options.apiKey.douban&&this.options.apiKey.douban.length>0&&this.movieInfoService.appendApiKey("douban",this.options.apiKey.douban))}getSearchResult(e){return this.searcher.searchTorrent(e.site,e.key,e.payload)}abortSearch(e){return this.searcher.abortSearch(e.site,e.key)}getDownloadHistory(){return this.downloadHistory.load()}saveDownloadHistory(e,t="",s="",i=!0){this.options.saveDownloadHistory&&this.downloadHistory.add(e,t,s,i)}removeDownloadHistory(e){return this.downloadHistory.remove(e)}clearDownloadHistory(){return this.downloadHistory.clear()}resetDownloadHistory(e){return this.downloadHistory.reset(e)}sendTorrentToClient(e){return new Promise((t,s)=>{if(!e.url)return void s({msg:this.service.i18n.t("service.controller.invalidAddress")});let i=w.a.parseURL(e.url).host,r=this.options.clients.find(t=>t.id===e.clientId);r?this.getClient(r).then(r=>{this.doDownload(r,e,i).then(e=>{t(e)}).catch(e=>{s(e)})}):s({msg:this.service.i18n.t("service.controller.invalidDownloadServer")})})}sendTorrentToDefaultClient(e){return new Promise((t,s)=>{let i=w.a.parseURL(e.url).host,r=this.getSiteFromHost(i);i=r.host+"";let o=this.getSiteDefaultPath(r),n=this.siteDefaultClients[i];!e.savePath&&o&&(e.savePath=o),n?this.doDownload(n,e,i).then(e=>{t(e)}).catch(e=>{s(e)}):this.initSiteDefaultClient(i).then(r=>{this.siteDefaultClients[i]=r,this.doDownload(r,e,i).then(e=>{t(e)}).catch(e=>{s(e)})})})}doDownload(e,t,s=""){let r=w.a.parseURL(t.url).host,o=this.getSiteFromHost(r);return console.log("doDownload",e,t,s,o),new Promise((r,n)=>{e.client.call(i.b.addTorrentFromURL,{url:t.url,savePath:void 0!==t.savePath&&t.savePath.includes(",")?t.savePath.split(",")[0]:t.savePath,autoStart:void 0!==t.autoStart&&t.autoStart,category:void 0!==t.savePath&&t.savePath.includes(",")?t.savePath.split(",")[1]:null,imdbId:t.tagIMDb?t.imdbId:null,upLoadLimit:void 0!==o?o.upLoadLimit:null,clientOptions:e.options}).then(o=>{if(this.service.logger.add({module:i.l.background,event:"service.controller.doDownload.finished",msg:this.service.i18n.t("service.controller.downloadFinished",{name:e.options.name,action:i.b.addTorrentFromURL}),data:o}),!t.title&&this.torrentInfosCache[t.url]&&(t.title=this.torrentInfosCache[t.url]),!o||0!==o.code&&!1!==o.success)this.saveDownloadHistory(t,s,e.options.id,!0),this.formatSendResult(o,e.options,t).then(e=>{r(e)}).catch(e=>{n(e)}),this.downloadFailedRetriesCache[t.url]&&delete this.downloadFailedRetriesCache[t.url];else{if(this.downloadFailedRetry(e,t,s,o,r,n))return;switch(o.msg){case"timeout":n({success:!1,msg:this.service.i18n.t("service.controller.downloadTimeout"),status:"error"});break;default:n({success:!1,msg:o.msg,status:"error"})}this.saveDownloadHistory(t,s,e.options.id,!1)}}).catch(o=>{this.downloadFailedRetry(e,t,s,o,r,n)||(this.service.logger.add({module:i.l.background,event:"service.controller.doDownload.error",msg:this.service.i18n.t("service.controller.downloadError",{name:e.options.name,action:i.b.addTorrentFromURL}),data:o}),this.saveDownloadHistory(t,s,e.options.id,!1),n(o))})})}downloadFailedRetry(e,t,s="",r,o,n){if(this.options.downloadFailedRetry){let a=this.options.downloadFailedFailedRetryCount;void 0===a&&(a=0);let c=this.downloadFailedRetriesCache[t.url];if(void 0===c&&(c=0),c<a)return c++,this.service.logger.add({module:i.l.background,event:"service.controller.downloadFailedRetries",msg:this.service.i18n.t("service.controller.downloadError",{name:e.options.name,action:i.b.addTorrentFromURL})+" ("+c+")",data:r}),this.downloadFailedRetriesCache[t.url]=c,this.options.downloadFailedFailedRetryInterval&&this.options.downloadFailedFailedRetryInterval>0?setTimeout(()=>{this.doDownload(e,t,s).then(e=>{o(e)}).catch(e=>{n(e)})},1e3*this.options.downloadFailedFailedRetryInterval):this.doDownload(e,t,s).then(e=>{o(e)}).catch(e=>{n(e)}),!0;delete this.downloadFailedRetriesCache[t.url]}return!1}getSiteFromHost(e){return this.options.sites.find(t=>{let s=[t.url].concat(t.cdn);return t.host==e||s.join("").indexOf(e)>-1})}getSiteDefaultPath(e,t=""){t||(t=e.defaultClientId||this.options.defaultClientId);let s=this.options.clients.find(e=>e.id===t),i="";if(s&&s.paths)for(const t in s.paths)if(e.host===t){i=s.paths[t][0];break}return i}formatSendResult(e,t,s){return new Promise((r,o)=>{let n={type:i.g.success,msg:this.service.i18n.t("service.controller.torrentAdded",{title:s.title})+(s.savePath?this.service.i18n.t("service.controller.torrentSavePath",{path:s.savePath,interpolation:{escapeValue:!1}}):""),success:!0,data:e};switch(t.type){case i.h.transmission:if(null!=e.id)n.msg=this.service.i18n.t("service.controller.transmissionSuccess",{data:e}),s.savePath&&(n.msg+=this.service.i18n.t("service.controller.torrentSavePath",{path:s.savePath,interpolation:{escapeValue:!1}}));else if(e.status)switch(e.status){case"duplicate":n.type=i.g.error,n.success=!1,n.msg=this.service.i18n.t("service.controller.transmissionDuplicate",{name:e.torrent.name,id:e.torrent.id});break;case"error":n.type=i.g.error,n.success=!1,n.msg=this.service.i18n.t("service.controller.transmissionError");break;default:n.msg=e.msg}else n.msg=e}r(n)})}getClient(e){return this.clientController.getClient(e)}initDefaultClient(){if(!this.options.clients)return;let e=this.options.clients.find(e=>e.id===this.options.defaultClientId);e&&this.getClient(e).then(e=>{this.defaultClient=e.client,this.defaultClientOptions=e.options})}initSiteDefaultClient(e){let t=this.options.sites.find(t=>t.host==e),s=this.options.clients.find(e=>e.id===t.defaultClientId);return s?this.getClient(s):new Promise((e,t)=>{e({client:this.defaultClient,options:this.defaultClientOptions})})}copyTextToClipboard(e=""){if(!e)return!1;var t=$("<textarea/>");return t.text(e),$("body").append(t),t.select(),document.execCommand("copy"),t.remove(),!0}getFreeSpace(e){return e.clientId?new Promise((t,s)=>{let r=this.options.clients.find(t=>t.id===e.clientId);r&&this.getClient(r).then(s=>{s.client.call(i.b.getFreeSpace,e).then(e=>{t(e)})})}):this.getDefaultClientFreeSpace(e)}getDefaultClientFreeSpace(e){return new Promise((t,s)=>{this.defaultClient.call(i.b.getFreeSpace,e).then(e=>{t(e)})})}updateOptionsTabId(e){this.optionsTabId=e}searchTorrent(e="",t=""){let s="";e&&(s="search-torrent/"+e),t&&(s+="/"+t),this.openOptions(s)}openOptions(e=""){let t="/";e&&(t+=e),0==this.optionsTabId?this.openURL(t):chrome.tabs.get(this.optionsTabId,e=>{!chrome.runtime.lastError&&e?chrome.tabs.update(e.id,{active:!0,url:"index.html#"+t}):this.openURL(t)})}openURL(e=""){e&&("/"===e.substr(0,1)&&(e="index.html#"+e),chrome.tabs.create({url:e},e=>{this.optionsTabId=e.id}))}getSiteSchema(e){let t={};if("string"==typeof e.schema)t=this.options.system&&this.options.system.schemas&&this.options.system.schemas.find(t=>t.name==e.schema);else{let e=this.options.system&&this.options.system.sites&&this.options.system.sites.find(t=>t.host==e.host);e&&e.schema&&(t=e.schema,t.siteOnly=!0)}return t}replaceKeys(e,t){let s=e;for(const e in t)if(t.hasOwnProperty(e)){const i=t[e];s=s.replace("$"+e+"$",i)}return s}call(e,t){return new Promise((s,i)=>{console.log("contorller.call",e.action),this[e.action](e.data,t).then(e=>{s(e)}).catch(e=>{i(e)})})}addContentPage(e,t){return new Promise((e,s)=>{try{t.tab&&this.contentPages.push(t.tab.id),e()}catch(e){s(e)}})}backupToGoogle(){return this.service.config.backupToGoogle()}restoreFromGoogle(){return this.service.config.restoreFromGoogle()}clearFromGoogle(){return this.service.config.syncStorage.clear()}reloadConfig(){return new Promise((e,t)=>{this.service.config.reload(),e()})}getTorrentDataFromURL(e){return new Promise((t,s)=>{let o="";"string"==typeof e?(o=e,e={url:o,parseTorrent:!1}):o=e.url;let n=this.getSiteOptionsFromURL(o),a=i.n.GET;n&&(a=n.downloadMethod||i.n.GET);let c=new l.a({url:o,getDataOnly:!0,timeout:this.service.options.connectClientTimeout});c.requestMethod=a,c.onCompleted=()=>{console.log("getTorrentDataFromURL.completed",o),c.content&&/octet-stream|x-bittorrent/gi.test(c.content.type)?R.a.remote(c.content,(i,r)=>{i?(console.log("parse.error",i),e.parseTorrent?s(i):t(c.content)):(r&&(this.torrentInfosCache[o]=r.name),e.parseTorrent?t({url:o,torrent:r,content:c.content}):t(c.content))}):s(r.b.createErrorMessage(this.service.i18n.t("service.controller.invalidTorrent",{link:i.x.faq})))},c.onError=e=>{s(r.b.createErrorMessage(e))},c.start()})}getSiteOptionsFromURL(e){let t=new O.a(e).host;return this.options.system&&this.options.system.sites&&this.options.system.sites.find(e=>e.host==t)}getUserInfoForAllSite(){return new Promise((e,t)=>{let s=0,i=0,r=[];this.options.sites.forEach(t=>{t.allowGetUserInfo&&(s++,this.getUserInfo(t).then(o=>{o&&r.push({site:t,user:o}),i++,i>=s&&e(r)}).catch(()=>{i++,i>=s&&e(r)}))}),i==s&&0==i&&t(this.service.i18n.t("service.controller.getUserInfoSiteIsEmpty"))})}getUserInfo(e){return this.userService.getUserInfo(e)}abortGetUserInfo(e){return this.userService.abortGetUserInfo(e)}getBase64FromImageUrl(e){return new Promise((t,s)=>{let i=this.imageBase64Cache[e];if(i)return void t(i);let o=new l.a({url:e,getDataOnly:!0,timeout:this.service.options.connectClientTimeout});o.onCompleted=()=>{if(console.log("getBase64FromImageUrl.completed",e),o.content&&/image/gi.test(o.content.type)){var i=new FileReader;i.onloadend=()=>{this.imageBase64Cache[e]=i.result,t(i.result)},i.readAsDataURL(o.content)}else s(r.b.createErrorMessage(this.service.i18n.t("service.controller.invalidImage")))},o.onError=e=>{s(r.b.createErrorMessage(e))},o.start()})}getUserHistoryData(e){return new Promise((t,s)=>{t(this.service.userData.get(e,i.v.all))})}resetUserDatas(e){return new Promise((t,s)=>{this.service.userData.reset(e),t()})}getMovieInfos(e){return this.movieInfoService.getInfos(e)}getMovieRatings(e){return this.movieInfoService.getRatings(e)}getIMDbIdFromDouban(e){return this.movieInfoService.getIMDbIdFromDouban(e)}queryMovieInfoFromDouban(e){return this.movieInfoService.queryMovieInfoFromDouban(e.key,e.count)}addBrowserDownloads(e){return new Promise((t,s)=>{this.service.checkPermissions(["downloads"]).then(()=>{let s=[];Array.isArray(e)?s=e:s.push(e),s.forEach(e=>{chrome.downloads.download(e,(function(e){console.log(e)}))}),t(s.length)}).catch(()=>{s({success:!1,msg:this.service.i18n.t("service.controller.noPermission")})})})}getCurrentLanguageResource(e){return new Promise((t,s)=>{let i=this.service.options.locale||"en",r=this.service.i18n.i18next.getResourceBundle(i,"translation");r?e&&r[e]?t(r[e]):t(r):s()})}addLanguage(e){return this.service.i18n.add(e)}replaceLanguage(e){return this.service.i18n.replace(e)}backupToServer(e){return this.service.config.backupToServer(e)}getBackupListFromServer(e={}){const t=e.server;return delete e.server,this.service.config.getBackupListFromServer(t,e)}restoreFromServer(e={}){return this.service.config.restoreFromServer(e.server,e.path)}deleteFileFromBackupServer(e={}){return this.service.config.deleteFileFromBackupServer(e.server,e.path)}sendTorrentsInBackground(e=[]){return new Promise((t,s)=>{this.service.downloadQuene.add(e).run(),t(this.service.i18n.t("service.controller.downloadTaskIsCreated",{count:e.length}))})}createBackupFile(e){return this.service.config.createBackupFile(e)}addTorrentToCollection(e){return this.options.defaultCollectionGroupId&&(e.groups=[this.options.defaultCollectionGroupId]),this.service.collection.add(e)}getTorrentCollections(e){return this.service.collection.load(e)}deleteTorrentFromCollention(e){return Array.isArray(e)?this.service.collection.remove(e):this.service.collection.delete(e)}clearTorrentCollention(){return this.service.collection.clear()}getTorrentCollention(e){return this.service.collection.get(e)}getSiteSelectorConfig(e){return new Promise((t,s)=>{const i=this.service.getSiteSelector(e.host,e.name);i?t(i):s(!1)})}resetTorrentCollections(e){return this.service.collection.reset(e)}getTorrentCollectionGroups(){return this.service.collection.getGroups()}addTorrentCollectionGroup(e){return this.service.collection.addGroup(e)}addTorrentCollectionToGroup(e){return this.service.collection.addToGroup(e.item,e.groupId)}updateTorrentCollectionGroup(e){return this.service.collection.updateGroup(e)}removeTorrentCollectionFromGroup(e){return this.service.collection.removeFromGroup(e.item,e.groupId)}removeTorrentCollectionGroup(e){return this.service.collection.removeGroup(e)}updateTorrentCollention(e){return this.service.collection.update(e)}getAllTorrentCollectionLinks(){return new Promise((e,t)=>{const s=this.service.collection.getAllLinks();s?e(s):t(!1)})}restoreCookies(e){return this.service.config.restoreCookies(e)}resetFavicons(){return this.service.config.favicon.clear(),this.service.config.getFavicons()}resetFavicon(e){return this.service.config.getFavicon(e,!0)}getBackupRawData(){return this.service.config.getBackupRawData()}testBackupServerConnectivity(e){return this.service.config.testBackupServerConnectivity(e)}createSearchResultSnapshot(e){return this.service.searchResultSnapshot.add(e)}getSearchResultSnapshot(e){return this.service.searchResultSnapshot.get(e)}loadSearchResultSnapshot(){return this.service.searchResultSnapshot.load()}removeSearchResultSnapshot(e){return this.service.searchResultSnapshot.remove(e)}clearSearchResultSnapshot(){return this.service.searchResultSnapshot.clear()}resetSearchResultSnapshot(e){return this.service.searchResultSnapshot.reset(e)}createKeepUploadTask(e){return this.service.keepUploadTask.add(e)}getKeepUploadTask(e){return this.service.keepUploadTask.get(e)}loadKeepUploadTask(){return this.service.keepUploadTask.load()}removeKeepUploadTask(e){return this.service.keepUploadTask.remove(e)}clearKeepUploadTask(){return this.service.keepUploadTask.clear()}resetKeepUploadTask(e){return this.service.keepUploadTask.reset(e)}updateKeepUploadTask(e){return this.service.keepUploadTask.update(e)}updateDebuggerTabId(e){return new Promise((t,s)=>{this.debuggerTabId=e,this.debuggerPort=chrome.tabs.connect(e,{name:i.l.debugger}),t()})}pushDebugMsg(e){return new Promise((t,s)=>{console.log(e),this.debuggerTabId&&chrome.tabs.get(this.debuggerTabId,t=>{t&&this.debuggerPort&&this.debuggerPort.postMessage({action:i.b.pushDebugMsg,data:e}),chrome.runtime.lastError&&(console.log(chrome.runtime.lastError.message),this.debuggerTabId=0,this.debuggerPort=void 0)}),t()})}getTopSearches(e=9){return this.movieInfoService.getTopSearches(e)}}class L{constructor(){this.maxLength=1e3,this.items=[],this.storage=new o.a,this.configKey=i.f.systemLogs,this.load()}load(){return new Promise((e,t)=>{this.storage.get(this.configKey,t=>{this.items=t||[],e(this.items)})})}add(e){let t=(new Date).getTime(),s=Object.assign({module:"",time:t,id:a.a.getNewId()},e);return this.items?(this.items.length>=this.maxLength&&this.items.splice(0,1),this.items.push(s),this.storage.set(this.configKey,this.items)):this.load().then(()=>{this.items.push(s),this.storage.set(this.configKey,this.items)}),s.id}remove(e){return new Promise((t,s)=>{this.load().then(()=>{for(let t=this.items.length-1;t>=0;t--){let s=this.items[t];e.findIndex(e=>e.id===s.id)>=0&&this.items.splice(t,1)}this.storage.set(this.configKey,this.items),t(this.items)})})}clear(){return new Promise((e,t)=>{this.items=[],this.storage.set(this.configKey,this.items),e(this.items)})}}var K=s(174);class x{constructor(e){this.service=e,this.items=null,this.storage=new o.a,this.configKey=i.f.userDatas,this.load()}load(){return new Promise((e,t)=>{this.storage.get(this.configKey,t=>{console.log("UserData.load",t),this.items=t||{},e(this.items)})})}get(e,t=i.v.latest){if(!this.items)return null;if(!e)return this.items;let s=this.items[e];if(!s)return null;switch(t){case i.v.all:return s;case i.v.today:return s[a.a.getToDay()]}return s[i.v.latest]}update(e,t){let s=e.host;if(!s)return;let r=Object.assign({},t);if(null==this.items)this.load().then(()=>{this.update(e,t)});else{let e=this.items[s],t=a.a.getToDay();e||(e={}),e[t]=r,e[i.v.latest]=r,this.items[s]=e,this.storage.set(this.configKey,this.items).then(()=>{this.service.saveUserData()})}}clear(){return new Promise((e,t)=>{this.items={},this.storage.set(this.configKey,this.items).then(()=>{this.service.saveUserData(),e(this.items)})})}upgrade(){return new Promise((e,t)=>{if(this.service.options&&this.service.options.system&&this.service.options.system.sites){let s=this.service.options.system.sites;this.load().then(i=>{i?(s.forEach(e=>{if(!e.host)return;let t=e.formerHosts,s=e.host;t&&t.length>0&&t.forEach(e=>{for(const t in i)if(t==e&&i.hasOwnProperty(t)){const e=i[t];i[s]=Object.assign({},e),delete i[t]}})}),this.items=i,this.storage.set(this.configKey,i),this.service.saveUserData(),e(i)):t(null)})}else t(null)})}reset(e){this.items=e,this.storage.set(this.configKey,this.items).then(()=>{this.service.saveUserData()})}}class B{constructor(e){this.service=e,this.splitString=" \u2192 ",this.initEvents()}init(){}initEvents(){chrome&&chrome.omnibox&&(chrome.omnibox.onInputChanged.addListener((e,t)=>{if(e&&this.service.options.searchSolutions){let s=[];this.service.options.searchSolutions.forEach(t=>{s.push({content:`${t.name}${this.splitString}${e}`,description:this.service.i18n.t("service.omnibox.search",{solutionName:t.name,text:e})})}),s.length>0&&t(s)}}),chrome.omnibox.onInputEntered.addListener(e=>{let t="",s="",i="";if(-1!=e.indexOf(this.splitString)){if([t,i]=e.split(this.splitString),t&&this.service.options.searchSolutions){let e=this.service.options.searchSolutions.find(e=>e.name==t);e&&(s=e.id)}}else i=e;chrome.tabs.create({url:"index.html#/search-torrent/"+i+(s?"/"+s:"")})}))}}var F=s(13);class q{constructor(e){this.service=e,this.loadedLanguages=[],this.i18next=F.a}init(){return F.a.init({interpolation:{prefix:"{",suffix:"}"}}),this.reset(this.service.options.locale||"en")}reset(e){return new Promise((t,s)=>{if(console.log(F.a.language),F.a.language!==e)return this.loadedLanguages.includes(e)?void F.a.changeLanguage(e).then(()=>{t(e)}):void $.getJSON(`${r.a.host}/i18n/${e}.json`).done(s=>{F.a.addResourceBundle(e,"translation",s.words,!0,!0),this.loadedLanguages.push(e),F.a.changeLanguage(e).then(()=>{t(e)})}).fail(i=>{"en"==e?s(i):this.reset("en").then(()=>{t(e)})});t(e)})}t(e,t){return F.a.t(e,t)}add(e){return new Promise((t,s)=>{e.name&&e.code?this.loadedLanguages.includes(e.code)?s():(F.a.addResourceBundle(e.code,"translation",e.words,!0,!0),this.loadedLanguages.push(e.code),F.a.changeLanguage(e.code).then(()=>{t(e.code)})):s()})}replace(e){return new Promise((t,s)=>{e.name&&e.code?this.loadedLanguages.includes(e.code)&&(F.a.addResourceBundle(e.code,"translation",e.words,!0,!0),F.a.changeLanguage(e.code).then(()=>{t(e.code)})):s()})}}class W{constructor(e){this.service=e,this.queues=[],this.isRunning=!1,this.timer=void 0,this.successCount=0,this.failedCount=0}add(e){return Array.isArray(e)?this.queues.push(...e):this.queues.push(e),this}run(){if(this.isRunning)return this;clearTimeout(this.timer);const e=this.queues.shift();if(e){this.isRunning=!0;const t=1e3*(this.service.options.batchDownloadInterval||0);(e.clientId?this.service.controller.sendTorrentToClient:this.service.controller.sendTorrentToDefaultClient).call(this.service.controller,e).then(()=>{this.successCount++}).catch(e=>{console.log(e),this.failedCount++}).finally(()=>{this.isRunning=!1,t>0?this.timer=window.setTimeout(()=>{this.run()},t):this.run()})}else a.a.showNotifications({message:this.service.i18n.t("service.controller.downloadTaskIsCompleted",{success:this.successCount,failed:this.failedCount})},1e4),this.successCount=0,this.failedCount=0;return this}}class j{constructor(){this.items=[],this.groups=[],this.storage=new o.a,this.movieInfoService=new k,this.configKey=i.f.collection,this.load()}load(e){return new Promise((t,s)=>{this.storage.get(this.configKey,s=>{let i={groups:[],items:[]};Array.isArray(s)?i.items=s:s&&(i=Object.assign(i,s)),this.groups=i.groups||[],this.items=i.items||[];let r=[];e?this.items.forEach(t=>{t.groups&&t.groups.includes(e)&&r.push(t)}):r=this.items,this.updateGroupCount(),t(r)})})}updateGroupCount(){this.groups.forEach(e=>{e.count=0,this.items.forEach(t=>{t.groups&&e.id&&t.groups.includes(e.id)&&(e.count||(e.count=0),e.count++)})})}add(e){return new Promise((t,s)=>{let i=Object.assign({time:(new Date).getTime(),site:null},e),r=Object.assign({},i.movieInfo);i.site&&delete i.site,i.link=a.a.getCleaningURL(i.link),r.imdbId||r.doubanId?this.getMoviceInfo(r.imdbId,r.doubanId).then(e=>{i.movieInfo=e,this.push(i),t(this.items)}).catch(e=>{console.log(e),this.push(i),t(this.items)}):(this.push(i),t(this.items))})}getMoviceInfo(e="",t=""){return new Promise((s,i)=>{let r=e,o=this.movieInfoService.getInfoFromIMDb;t&&(r=t,o=this.movieInfoService.getInfoFromDoubanId),o.call(this.movieInfoService,r).then(t=>{let i={imdbId:e,doubanId:t.id.toString().replace(/(\D)/g,""),image:t.image||(t.images?t.images.small:void 0),title:t.title,link:t.mobile_link||t.share_url,alt_title:t.alt_title||t.original_title,year:t.year};!t.year&&t.attrs&&(i.year=t.attrs.year[0]),s(i)}).catch(e=>{i()})})}push(e){-1===this.items.findIndex(t=>t.link===e.link)&&(this.items.push(e),this.updateGroupCount(),this.storage.set(this.configKey,{groups:this.groups,items:this.items}))}update(e){return new Promise((t,s)=>{this.load().then(()=>{e.link=a.a.getCleaningURL(e.link);let s=this.items.findIndex(t=>t.link===e.link);if(s>=0){this.items[s]=e;let i=Object.assign({},e.movieInfo);if(e.site&&delete e.site,i.imdbId||i.doubanId)return void this.getMoviceInfo(i.imdbId,i.doubanId).then(i=>{e.movieInfo=i,this.items[s]=e,this.updateData(),t(this.items)}).catch(e=>{console.log(e),this.updateData(),t(this.items)})}this.updateData(),t(this.items)})})}updateData(){this.updateGroupCount(),this.storage.set(this.configKey,{groups:this.groups,items:this.items})}delete(e){return this.remove([e])}remove(e){return new Promise((t,s)=>{this.load().then(()=>{for(let t=this.items.length-1;t>=0;t--){let s=this.items[t];e.findIndex(e=>e.link===s.link)>=0&&this.items.splice(t,1)}this.updateGroupCount(),this.storage.set(this.configKey,{groups:this.groups,items:this.items}),t(this.items)})})}clear(){return new Promise((e,t)=>{this.items=[],this.groups=[],this.storage.set(this.configKey,{}),e({})})}get(e){return new Promise((t,s)=>{e=a.a.getCleaningURL(e),this.load().then(()=>{let i=this.items.find(t=>t.link===e);i?t(i):s(!1)})})}reset(e){return new Promise((t,s)=>{e?(Array.isArray(e)?this.items=e:(this.groups=e.groups||this.groups,this.items=e.items||this.items),this.storage.set(this.configKey,{groups:this.groups,items:this.items}),t({groups:this.groups,items:this.items})):s(!1)})}addGroup(e){return new Promise((t,s)=>{let i=Object.assign({id:a.a.getNewId().substr(0,8),update:(new Date).getTime()},e);this.groups.push(i),this.storage.set(this.configKey,{groups:this.groups,items:this.items}),t(this.groups)})}removeGroup(e){return new Promise((t,s)=>{let i=[];Array.isArray(e)?i=e:i.push(e),this.load().then(()=>{for(let e=this.groups.length-1;e>=0;e--){let t=this.groups[e];i.findIndex(e=>e.id===t.id)>=0&&(this.items.forEach(e=>{if(!e.groups)return;let s=e.groups.findIndex(e=>e===t.id);-1!==s&&e.groups.splice(s,1)}),this.groups.splice(e,1))}this.updateGroupCount(),this.storage.set(this.configKey,{groups:this.groups,items:this.items}),t(this.groups)})})}updateGroup(e){return new Promise((t,s)=>{this.load().then(()=>{let s=this.groups.findIndex(t=>t.id===e.id);s>=0&&(this.groups[s]=e),this.storage.set(this.configKey,{groups:this.groups,items:this.items}),t(this.groups)})})}getGroups(){return new Promise((e,t)=>{this.load().then(()=>{e(this.groups)})})}addToGroup(e,t){return new Promise((s,i)=>{e.groups||(e.groups=[]),-1===e.groups.findIndex(e=>e===t)?(e.groups.push(t),this.update(e).then(()=>{s(!0)})):i(!1)})}removeFromGroup(e,t){return new Promise((s,i)=>{if(e.groups){let r=e.groups.findIndex(e=>e===t);-1!==r?(e.groups.splice(r,1),this.update(e).then(()=>{s(!0)})):i(!1)}})}getAllLinks(){let e=[];return this.items.forEach(t=>{e.push(a.a.getCleaningURL(t.link))}),e}}class N{constructor(){this.items=[],this.storage=new o.a,this.configKey=i.f.searchResultSnapshot,this.load()}load(){return new Promise((e,t)=>{this.storage.get(this.configKey,t=>{let s={items:[]};Array.isArray(t)?s.items=t:t&&(s=Object.assign(s,t)),this.items=s.items||[],console.log(t),e(this.items)})})}add(e){return new Promise((t,s)=>{let i=Object.assign({time:(new Date).getTime(),id:a.a.getNewId()},e);this.items.push(i),this.updateData(),t(this.items)})}updateData(){this.storage.set(this.configKey,{items:this.items})}get(e){return new Promise((t,s)=>{this.load().then(()=>{let i=this.items.find(t=>t.id===e);i?t(i):s(!1)})})}delete(e){return this.remove([e])}remove(e){return new Promise((t,s)=>{this.load().then(()=>{for(let t=this.items.length-1;t>=0;t--){let s=this.items[t];e.findIndex(e=>e.id===s.id)>=0&&this.items.splice(t,1)}this.updateData(),t(this.items)})})}clear(){return new Promise((e,t)=>{this.items=[],this.updateData(),e([])})}reset(e){return new Promise((t,s)=>{e&&Array.isArray(e)?(this.items=e,this.updateData(),t(this.items)):s(!1)})}}class G{constructor(){this.items=[],this.storage=new o.a,this.configKey=i.f.keepUploadTask,this.load()}load(){return new Promise((e,t)=>{this.storage.get(this.configKey,t=>{let s={items:[]};Array.isArray(t)?s.items=t:t&&(s=Object.assign(s,t)),this.items=s.items||[],console.log(t),e(this.items)})})}add(e){return new Promise((t,s)=>{let i=Object.assign({time:(new Date).getTime(),id:a.a.getNewId()},e);this.items.push(i),this.updateData(),t(this.items)})}update(e){return new Promise((t,s)=>{this.load().then(()=>{let s=this.items.findIndex(t=>t.id===e.id);s>=0&&(this.items[s]=e),this.updateData(),t(this.items)})})}updateData(){this.storage.set(this.configKey,{items:this.items})}get(e){return new Promise((t,s)=>{this.load().then(()=>{let i=this.items.find(t=>t.id===e);i?t(i):s(!1)})})}delete(e){return this.remove([e])}remove(e){return new Promise((t,s)=>{this.load().then(()=>{for(let t=this.items.length-1;t>=0;t--){let s=this.items[t];e.findIndex(e=>e.id===s.id)>=0&&this.items.splice(t,1)}this.updateData(),t(this.items)})})}clear(){return new Promise((e,t)=>{this.items=[],this.updateData(),e([])})}reset(e){return new Promise((t,s)=>{e&&Array.isArray(e)?(this.items=e,this.updateData(),t(this.items)):s(!1)})}}const H=new class{constructor(e=!1){this.config=new D(this),this.options={sites:[],clients:[]},this.localMode=!1,this.controller=new A(this),this.logger=new L,this.contentMenus=new K.a(this),this.userData=new x(this),this.omniBox=new B(this),this.i18n=new q(this),this.downloadQuene=new W(this),this.collection=new j,this.searchResultSnapshot=new N,this.keepUploadTask=new G,this.reloadCount=0,this.autoRefreshUserDataTimer=0,this.autoRefreshUserDataIsWorking=!1,this.autoRefreshUserDataFailedCount=0,e||this.initBrowserEvent(),this.logger.add({module:i.l.background,event:i.k.init}),this.localMode=e,this.initConfig()}requestMessage(e,t){return this.debug(`${i.k.requestMessage}.${e.action}`),new Promise((s,r)=>{let o;try{switch(e.action){case i.b.readConfig:this.localMode?this.readConfig().then(()=>{s(this.options)}):s(this.options);break;case i.b.saveConfig:e.data.locale&&e.data.locale!=this.options.locale&&this.i18n.reset(e.data.locale),this.config.save(e.data),this.options=e.data,this.controller.isInitialized&&this.controller.reset(this.options),setTimeout(()=>{this.contentMenus.init(this.options)},100),this.resetAutoRefreshUserDataTimer(),s(this.options);break;case i.b.getClearedOptions:s(this.config.cleaningOptions(this.options));break;case i.b.resetRunTimeOptions:this.config.resetRunTimeOptions(e.data),this.options=this.config.options,s(this.options);break;case i.b.copyTextToClipboard:o=this.controller.copyTextToClipboard(e.data),o?s(o):r();break;case i.b.openOptions:this.controller.openOptions(e.data),s(!0);break;case i.b.updateOptionsTabId:this.controller.updateOptionsTabId(e.data),s(!0);break;case i.b.searchTorrent:console.log(e.data),this.controller.searchTorrent(e.data),s(!0);break;case i.b.testClientConnectivity:this.controller.clientController.testClientConnectivity(e.data).then(e=>{s(e)}).catch(t=>{this.logger.add({module:i.l.background,event:""+i.b.testClientConnectivity,msg:this.i18n.t("service.testClientConnectivityFailed",{address:e.data.address}),data:t}),r(t)});break;case i.b.getSystemLogs:this.logger.load().then(e=>{s(e)}).catch(e=>{r(e)});break;case i.b.removeSystemLogs:this.logger.remove(e.data).then(e=>{s(e)}).catch(e=>{r(e)});break;case i.b.clearSystemLogs:this.logger.clear().then(e=>{s(e)}).catch(e=>{r(e)});break;case i.b.writeLog:this.logger.add(e.data),s(!0);break;case i.b.readUIOptions:this.config.readUIOptions().then(e=>{s(e)}).catch(e=>{r(e)});break;case i.b.saveUIOptions:this.config.saveUIOptions(e.data).then(e=>{s(e)}).catch(e=>{r(e)});break;case i.b.changeLanguage:return this.i18n.reset(e.data);default:if(this[e.action])return void this[e.action](e.data,t).then(e=>{s(e)}).catch(e=>{r(e)});this.controller.call(e,t).then(e=>{s(e)}).catch(e=>{r(e)})}}catch(e){r(e)}})}initConfig(){if(this.reloadCount<10&&(0===this.config.sites.length||0===this.config.clients.length))return setTimeout(()=>{this.initConfig()},500),void this.reloadCount++;this.readConfig().then(()=>{this.initI18n()})}initI18n(){this.i18n.init().then(()=>{this.init()}).catch(()=>{console.debug("i18n init error")})}readConfig(){return new Promise((e,t)=>{this.config.read().then(t=>{this.initUserData(),this.options=t,e(t),this.localMode||this.controller.init(this.options)})})}saveConfig(){this.config.save(this.options)}initUserData(){this.options.sites.forEach(e=>{e.user=this.userData.get(e.host)})}resetAutoRefreshUserDataTimer(e=!1){if(clearInterval(this.autoRefreshUserDataTimer),!this.options.autoRefreshUserData)return;this.options.autoRefreshUserDataNextTime=this.getNextTime(0),(new Date).getTime()>=this.options.autoRefreshUserDataNextTime&&(e&&a.a.getToDay()!=a.a.getToDay(this.options.autoRefreshUserDataLastTime)?this.options.autoRefreshUserDataNextTime=(new Date).getTime()+1e4:this.options.autoRefreshUserDataNextTime=this.getNextTime()),this.autoRefreshUserDataFailedCount=0;let t=this.options.autoRefreshUserDataFailedRetryCount||3,s=this.options.autoRefreshUserDataFailedRetryInterval||5;this.autoRefreshUserDataTimer=window.setInterval(()=>{let e=(new Date).getTime();this.options.autoRefreshUserDataNextTime&&e>=this.options.autoRefreshUserDataNextTime&&!this.autoRefreshUserDataIsWorking&&(this.options.autoRefreshUserDataNextTime=this.getNextTime(),this.autoRefreshUserDataIsWorking=!0,this.controller.userService.refreshUserData(this.autoRefreshUserDataFailedCount>0).then(e=>{var r;this.debug("refreshUserData DONE.",e),this.autoRefreshUserDataIsWorking=!1;let o=!1;if(e.some(e=>e?!e.id&&e.msg&&e.msg.status!=i.w.notSupported?(o=!0,!0):void 0:(o=!0,!0)),o?(this.autoRefreshUserDataFailedCount<t?(this.options.autoRefreshUserDataNextTime=(new Date).getTime()+6e4*s,this.debug("\u6570\u636e\u5237\u65b0\u5931\u8d25, \u4e0b\u6b21\u91cd\u8bd5\u65f6\u95f4",new Date(this.options.autoRefreshUserDataNextTime).toLocaleString())):this.debug("\u6570\u636e\u5237\u65b0\u5931\u8d25, \u91cd\u8bd5\u6b21\u6570\u5df2\u8d85\u9650\u5236"),this.autoRefreshUserDataFailedCount++):(this.debug("\u6570\u636e\u5237\u65b0\u5b8c\u6210"),this.autoRefreshUserDataFailedCount=0),this.options.autoBackupData&&(!o||this.autoRefreshUserDataFailedCount>=t)){let{autoBackupDataServerId:e}=this.options;console.log("\u4e0a\u4f20\u7528\u6237\u6570\u636e\u5230 -> "+e);let t=null===(r=this.options.backupServers)||void 0===r?void 0:r.filter(t=>t.id===e)[0];t?(console.log("\u5f00\u59cb\u4e0a\u4f20\u7528\u6237\u6570\u636e\u5230 -> "+t.name),this.controller.backupToServer(t).then(e=>console.log("\u7528\u6237\u6570\u636e\u4e0a\u4f20\u5b8c\u6210 -> "+t.name,e)).catch(e=>console.log("\u7528\u6237\u6570\u636e\u4e0a\u4f20\u5931\u8d25 -> "+t.name,e))):console.log("\u672a\u627e\u5230\u5907\u4efd\u670d\u52a1\u5668 -> "+e,this.options.backupServers)}}))},1e3)}getNextTime(e=1){let t=a.a.getToDay(),s=new Date(`${t} ${this.options.autoRefreshUserDataHours}:${this.options.autoRefreshUserDataMinutes}:00`);return new Date(s.setDate(s.getDate()+e)).getTime()}saveUserData(){this.initUserData(),this.config.save(this.options)}init(){this.localMode||(this.contentMenus.init(this.options),this.resetAutoRefreshUserDataTimer(!0))}debug(...e){e.forEach(e=>{this.controller.pushDebugMsg(e)})}writeLog(e){this.logger.add(e)}writeErrorLog(e){this.logger.add({module:i.l.background,event:"\u4e00\u822c\u9519\u8bef",msg:"string"==typeof e?e:JSON.stringify(e)})}initBrowserEvent(){void 0!==window.chrome&&chrome.runtime&&(console.log("service.initBrowserEvent"),chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener((e,t,s)=>(this.requestMessage(e,t).then(e=>{s&&s({resolve:e})}).catch(e=>{s&&s({reject:e})}),!0)),chrome.runtime.onInstalled.addListener(e=>{console.log("chrome.runtime.onInstalled",e),"update"==e.reason&&this.upgrade()}))}upgrade(){setTimeout(()=>{this.userData.upgrade()},1e3)}getSiteParser(e,t){let s=this.options.system&&this.options.system.sites&&this.options.system.sites.find(t=>t.host===e);if(!s)return"";let i=s.parser&&s.parser[t];if(!i){let e=this.options.system&&this.options.system.schemas&&this.options.system.schemas.find(e=>e.name===s.schema);i=e.parser&&e.parser[t]}return i}getSiteSelector(e,t){let s="string"==typeof e?e:e.host,i=this.clone(this.options.system),r=i.sites.concat(this.options.sites).find(e=>e.host===s);if(!r){if("string"==typeof e)return null;r=e}let o=r.selectors&&r.selectors[t],n=i.schemas.find(e=>null!=r&&e.name===r.schema);if(o){if(!0===o.disabled)return null;n&&n.selectors&&n.selectors[t]&&!0===o.merge&&(o.fields=Object.assign(n.selectors[t].fields,o.fields),o=Object.assign(n.selectors[t],o))}else n&&n.selectors&&(o=n.selectors[t]);return o}clone(e){return a.a.clone(e)}checkPermissions(e){return a.a.checkPermissions(e)}requestPermissions(e){return a.a.requestPermissions(e)}};Object.assign(window,{PTServiceFilters:w.a,PTBackgroundService:H,i18n:H.i18n})},85:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s(20),r=s(29);const o="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";class n{constructor(e){this.service=e,this.cache={},this.loadCache()}loadCache(){let e=window.localStorage.getItem("Favicon-Cache");e&&(this.cache=JSON.parse(e)||{})}saveCache(){window.localStorage.setItem("Favicon-Cache",JSON.stringify(this.cache))}clear(){this.cache={},this.saveCache()}reset(){let e=JSON.parse(JSON.stringify(this.cache));this.cache={};let t=[];for(const s in e)if(e.hasOwnProperty(s)){let i=e[s];t.push(i.origin)}return this.gets(t)}gets(e){return new Promise((t,s)=>{let i=[];e.forEach(e=>{i.push(this.get(e))}),Promise.all(i).then(e=>{t(e)}).catch(e=>{s(e)})})}get(e,t=!1){return new Promise((s,r)=>{let o=i.a.parseURL(e),n=this.cache[o.host];if(n&&!t)return s(n);this.cacheFavicon(o.origin,o.host).then(e=>{s(e)}).catch(e=>{r(e)})})}cacheFavicon(e,t){return new Promise((s,i)=>{this.download(e+"/favicon.ico").then(r=>{r&&r.size>0?this.transformBlob(r,"base64").then(t=>{s(this.set(e,t))}).catch(e=>{i(e)}):this.cacheFromIndex(e,t).then(e=>{s(e)}).catch(e=>{i(e)})}).catch(()=>{this.cacheFromIndex(e,t).then(e=>{s(e)}).catch(e=>{i(e)})})})}set(e,t){let s=i.a.parseURL(e),r={origin:s.origin,host:s.host,data:t};return this.cache[s.host]=r,this.saveCache(),r}cacheFromIndex(e,t){return new Promise((t,s)=>{this.download(e).then(r=>{r&&/text/gi.test(r.type)?this.transformBlob(r,"text").then(r=>{try{const n=(new DOMParser).parseFromString(r,"text/html");let a=$(n).find("head").find("link[rel*=icon]:first");if(a&&a.length>0){let r=i.a.parseURL(e),n=a.attr("href")+"";"//"===n.substr(0,2)?n=`${r.protocol}:${n}`:"http"!==n.substr(0,4)&&(n=n.startsWith("/")?`${r.origin}${n}`:`${r.origin}/${n}`),this.download(n).then(i=>{i&&/image/gi.test(i.type)?this.transformBlob(i,"base64").then(s=>{t(this.set(e,s))}).catch(e=>{this.debug(e),s(e)}):t(this.set(e,o))}).catch(()=>{t(this.set(e,o))})}else t(this.set(e,o))}catch(s){console.log(s),this.debug(s),t(this.set(e,o))}}).catch(e=>{this.debug(e),s(e)}):s()}).catch(()=>{t(this.set(e,o))})})}transformBlob(e,t){return new Promise((s,i)=>{const r=new FileReader;switch(r.addEventListener("loadend",()=>{r.result?s(r.result):i()}),t){case"text":r.readAsText(e);break;case"base64":r.readAsDataURL(e)}})}download(e){return new Promise((t,s)=>{let i=new r.a({url:e,getDataOnly:!0,timeout:5e3});i.onCompleted=()=>{i.content?t(i.content):s()},i.onError=e=>{console.log("Favicon.download.error",e),this.debug(e),s(e)},i.start()})}debug(...e){this.service&&this.service.debug(...e)}}}});