import{V as f,h as c,P as h,E as u,b as p,n as g}from"./index-CFTjSAoW.js";class v{constructor(){}replacePathKey(t,e){if(!t)return t;const n=new Date;return this.replaceKeys(t,{"site.name":e.name,"site.host":e.host,YYYY:n.getFullYear(),MM:("0"+(n.getMonth()+1).toString()).substr(-2),DD:("0"+n.getDate().toString()).substr(-2)})}getSavePath(t,e){if(!t)return;let n=t,l="<...>";if(n&&n.indexOf(l)>=0){let s=window.prompt(`当前为自定义路径：${n} 
请输入路径中 ${l} 部分的内容: `);if(s===null)return!1;n=n.replace(l,s)}return this.replacePathKey(n,e)}replaceKeys(t,e){let n=t;for(const l in e)if(e.hasOwnProperty(l)){const s=e[l];n=n.replace("$"+l+"$",s)}return n}}const d=new p,S=f.extend({props:{flat:Boolean,icon:Boolean,small:Boolean,mini:Boolean,color:String,iconText:{type:String,default:"cloud_download"},downloadOptions:{type:[Object,Array],default:()=>({host:String,url:String})},getOptionsOnly:Boolean,label:String,title:String,payload:[Object,Array,String,Number]},data(){return{options:this.$store.state.options,contentMenus:[],pathHandler:new v,loading:!1,site:{},haveSuccess:!1,haveError:!1,allContentMenus:[]}},methods:{getSiteContentMenus(a){let t=[],e=[];if(this.contentMenus&&this.contentMenus.length>0)return this.contentMenus;function n(l,s){l.forEach(i=>{t.push({client:s,path:i,host:a})})}return this.options.clients.forEach(l=>{if(e.push({client:l,path:"",host:a}),l.paths){for(const i in l.paths){let o=l.paths[i];a===i&&n(o,l)}let s=l.paths[c.allSite];s&&(t.length>0&&t.push({}),n(s,l))}}),t.length>0&&e.splice(0,0,{}),t=t.concat(e),this.contentMenus=t,t},getSiteFromHost(a){return this.options.sites.find(t=>{let e=t.cdn||[];return t.url&&e.push(t.url),t.host==a||e.join("").indexOf(a)>-1})},showSiteContentMenus(a){if(Array.isArray(this.downloadOptions)){this.showAllContentMenus(a);return}let t=this.downloadOptions,e=t.host;if(!e&&t.site&&(e=t.site.host),!e)return;this.site=t.site||this.getSiteFromHost(e);let n=this.getSiteContentMenus(e),l=[];n.forEach(s=>{if(s.client&&s.client.name){let i=this.$vuetify.breakpoint.xs?s.client.name:this.$t("searchTorrent.downloadTo",{path:`${s.client.name} -> ${s.client.address}`});s.path&&(i+=` ->${this.pathHandler.replacePathKey(s.path,this.site)}`),l.push({title:i,fn:()=>{if(t.url){console.log(t,s);const r={url:this.processURLWithPrefix("m-teamdetail",t.site,t.url),title:t.title,savePath:s.path,autoStart:s.client.autoStart,tagIMDb:s.client.tagIMDb,link:t.link,clientId:s.client.id,imdbId:t.imdbId};if(this.getOptionsOnly){r.savePath=this.pathHandler.getSavePath(r.savePath,this.site),this.$emit("itemClick",{payload:this.payload,downloadOptions:Object.assign({clientName:s.client.name},r)});return}this.sendToClient(r)}}})}else l.push({})}),h.showContextMenu(l,a)},processURLWithPrefix(a,t,e){if(e&&e.startsWith(a)){const n=e.substring(a.length);return h.resolveMTDownloadURL(n,t)}else return e},showAllContentMenus(a){let t=[],e=[],n=this;function l(s){let i=n.$t("searchTorrent.downloadTo",{path:`${s.client.name} -> ${s.client.address}`}).toString();s.path&&(i+=` -> ${s.path}`),e.push({title:i,fn:()=>{n.sendTorrentsInBackground(s)}})}this.allContentMenus.length==0?(this.options.clients.forEach(s=>{t.push({client:s,path:""})}),t.forEach(s=>{if(s.client&&s.client.name){if(l(s),s.client.paths){let i=s.client.paths[c.allSite];i&&i.forEach(o=>{if(o.indexOf("$site.name$")==-1&&o.indexOf("$site.host$")==-1&&o.indexOf("<...>")==-1){let r=h.clone(s);r.path=o,l(r)}})}}else e.push({})}),this.allContentMenus=e):e=this.allContentMenus,h.showContextMenu(e,a)},sendTorrentsInBackground(a){let t=[];this.downloadOptions.forEach(e=>{t.push({title:e.title,url:e.url,clientId:a.client.id,savePath:a.path,autoStart:a.client.autoStart,tagIMDb:a.client.tagIMDb,link:e.link,imdbId:e.imdbId})}),this.loading=!0,d.sendRequest(u.sendTorrentsInBackground,null,t).then(e=>{console.log("命令执行完成",e),this.haveSuccess=!0,this.$emit("success",e)}).catch(e=>{console.log(e),this.haveError=!0,this.$emit("error",e.msg||e)}).finally(()=>{this.loading=!1,setTimeout(()=>{this.clearStatus()},5e3)})},sendToClient(a){this.clearStatus();let t=this.pathHandler.getSavePath(a.savePath,this.site);t!==!1&&(this.loading=!0,a.savePath=t,d.sendRequest(u.sendTorrentToClient,null,a).then(e=>{console.log("命令执行完成",e),e.type=="success"?(this.haveSuccess=!0,this.$emit("success",e.msg)):(this.haveError=!0,this.$emit("error",e.msg))}).catch(e=>{console.log(e),this.haveError=!0,this.$emit("error",e.msg||e)}).finally(()=>{this.loading=!1,setTimeout(()=>{this.clearStatus()},5e3)}))},clearStatus(){this.haveSuccess=!1,this.haveError=!1}}});var m=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("v-btn",{class:[t.mini?"btn-mini":""],attrs:{flat:t.flat,icon:t.icon,small:t.small,loading:t.loading,title:t.title||t.$t("searchTorrent.sendToClientTip"),color:t.color},on:{click:function(n){return n.stopPropagation(),t.showSiteContentMenus.apply(null,arguments)}}},[t.haveSuccess?e("v-icon",{attrs:{color:"success",small:""}},[t._v("done")]):t.haveError?e("v-icon",{attrs:{color:"red",small:""}},[t._v("close")]):e("v-icon",{attrs:{small:""}},[t._v(t._s(t.iconText))]),t.label?e("span",{staticClass:"ml-2"},[t._v(t._s(t.label))]):t._e()],1)},_=[],M=g(S,m,_,!1,null,null,null,null);const $=M.exports;export{$ as D,v as P};
