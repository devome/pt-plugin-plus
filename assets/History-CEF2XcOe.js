import{V as r,E as a,b as n,n as c}from"./index-C9rdr-_b.js";import{D as d}from"./DownloadTo-DVBt1JPv.js";const o=new n,h=r.extend({components:{DownloadTo:d},data(){return{selected:[],selectedItem:{},pagination:{rowsPerPage:10,sortBy:"time",descending:!0},items:[],dialogRemoveConfirm:!1,options:this.$store.state.options,errorMsg:"",haveError:!1,haveSuccess:!1,successMsg:"",siteCache:{},filterKey:"",filteredItems:[],filterStatus:"all",selectedClient:{address:""},clientItems:[]}},watch:{selectedClient(){this.resetItems()},filterStatus(){this.resetItems()}},methods:{clear(){confirm(this.$t("history.clearConfirm").toString())&&o.sendRequest(a.clearDownloadHistory).then(i=>{this.getDownloadHistory()})},resetItems(){let i="";this.selectedClient&&this.selectedClient.id&&(i=this.selectedClient.id),i==""&&this.filterStatus=="all"?this.getDownloadHistory():(this.filteredItems=[],this.items.forEach(t=>{let e=t.clientId||t.data.clientId;if((this.filterStatus=="fail"&&t.success===!1||this.filterStatus=="success"&&t.success!==!1||this.filterStatus=="all")&&(e==i||i=="")){let s=this.siteCache[t.host];s||(s=this.options.sites.find(l=>l.host===t.host),this.siteCache[t.host]=s),t.site=s,this.filteredItems.push(t)}}))},removeSelected(){this.selected&&this.selected.length>0&&confirm(this.$t("common.removeSelectedConfirm",{count:this.selected.length}).toString())&&this.remove(this.selected)},remove(i){i||(i=[this.selectedItem]),o.sendRequest(a.removeDownloadHistory,null,i).then(t=>{this.getDownloadHistory()}),this.dialogRemoveConfirm=!1},removeConfirm(i){this.selectedItem=i,this.dialogRemoveConfirm=!0},getDownloadHistory(){o.sendRequest(a.getDownloadHistory).then(i=>{console.log("downloadHistory",i),this.items=[],this.filteredItems=[],i.forEach(t=>{let e=this.siteCache[t.host];e||(e=this.options.sites.find(s=>s.host===t.host),this.siteCache[t.host]=e),t.site=e,this.filteredItems.push(t),this.items.push(t)})})},getClientName(i){let t=this.options.clients.find(e=>e.id===i);return t?t.name:""},download(i){let t=null,e=0;Array.isArray(i)?(t=i.pop(),e=i.length):t=i,console.log(t),this.haveSuccess=!0,this.successMsg=this.$t("history.seedingTorrent").toString();let s=Object.assign({},t.data);s.clientId||(s.clientId=t.clientId),o.sendRequest(a.sendTorrentToClient,null,s).then(l=>{console.log("命令执行完成",l),l.success?(this.haveSuccess=!0,this.successMsg=l.msg):(this.haveError=!0,this.errorMsg=l.msg),e>0&&setTimeout(()=>{this.download(i)},500)}).catch(l=>{l.success?(this.haveSuccess=!0,this.successMsg=l.msg):(this.haveError=!0,this.errorMsg=l.msg),e>0&&setTimeout(()=>{this.download(i)},500)})},downloadSelected(){this.selected&&this.selected.length>0&&confirm(this.$t("history.downloadSelectedConfirm",{count:this.selected.length}).toString())&&this.download(this.selected)},onError(i){this.errorMsg=i},onSuccess(i){this.successMsg=i}},created(){this.$store.state.options.clients&&this.$store.state.options.clients.length>0&&(this.clientItems=this.$store.state.options.clients),this.getDownloadHistory()},computed:{headers(){return[{text:"№",align:"left",sortable:!1,value:"title",width:30},{text:this.$t("history.headers.site"),align:"center",value:"data.host",width:"140px"},{text:this.$t("history.headers.title"),align:"left",value:"data.title"},{text:this.$t("history.headers.status"),align:"left",value:"data.success"},{text:this.$t("history.headers.time"),align:"left",value:"time"},{text:this.$t("history.headers.action"),value:"name",sortable:!1}]}}});var v=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"history"},[e("v-alert",{attrs:{value:!0,type:"info"}},[t._v(t._s(t.$t("history.title")))]),e("v-card",[e("v-card-title",[e("v-btn",{attrs:{color:"error",disabled:t.selected.length==0},on:{click:t.removeSelected}},[e("v-icon",{staticClass:"mr-2"},[t._v("remove")]),t._v(" "+t._s(t.$t("history.remove"))+" ")],1),e("v-btn",{attrs:{color:"error",disabled:t.items.length==0},on:{click:t.clear}},[e("v-icon",{staticClass:"mr-2"},[t._v("clear")]),t._v(" "+t._s(t.$t("history.clear"))+" ")],1),e("v-divider",{staticClass:"mx-3 mt-0",attrs:{vertical:""}}),e("v-btn",{attrs:{color:"success",disabled:t.selected.length==0},on:{click:t.downloadSelected}},[e("v-icon",{staticClass:"mr-2"},[t._v("save_alt")]),t._v(" "+t._s(t.$t("history.download"))+" ")],1),e("v-divider",{staticClass:"mx-3 mt-0",attrs:{vertical:""}}),e("v-autocomplete",{staticStyle:{"max-width":"500px"},attrs:{items:t.clientItems,label:t.$t("history.filterServer"),"menu-props":{maxHeight:"auto"},hint:t.selectedClient.address,"return-object":"","persistent-hint":"","item-text":"name","item-value":"id"},scopedSlots:t._u([{key:"selection",fn:function({item:s}){return[e("span",[t._v(t._s(s.name))])]}},{key:"item",fn:function(s){return[e("v-list-tile-content",[e("v-list-tile-title",{domProps:{innerHTML:t._s(s.item.name)}}),e("v-list-tile-sub-title",{domProps:{innerHTML:t._s(s.item.address)}})],1),e("v-list-tile-action-text",[t._v(t._s(s.item.type))])]}}]),model:{value:t.selectedClient,callback:function(s){t.selectedClient=s},expression:"selectedClient"}}),e("v-radio-group",{staticClass:"ml-5",attrs:{row:""},model:{value:t.filterStatus,callback:function(s){t.filterStatus=s},expression:"filterStatus"}},[e("v-radio",{attrs:{label:t.$t("history.success"),color:"success",value:"success"}}),e("v-radio",{attrs:{label:t.$t("history.fail"),color:"fail",value:"fail"}}),e("v-radio",{attrs:{label:t.$t("history.all"),color:"info",value:"all"}})],1),e("v-spacer"),e("v-text-field",{staticClass:"search",attrs:{"append-icon":"search",label:"Search","single-line":"","hide-details":""},model:{value:t.filterKey,callback:function(s){t.filterKey=s},expression:"filterKey"}})],1),e("v-data-table",{staticClass:"elevation-1",attrs:{search:t.filterKey,headers:t.headers,items:t.filteredItems,pagination:t.pagination,"item-key":"data.url","select-all":""},on:{"update:pagination":function(s){t.pagination=s}},scopedSlots:t._u([{key:"items",fn:function(s){return[e("td",{staticStyle:{width:"20px"}},[e("v-checkbox",{attrs:{primary:"","hide-details":""},model:{value:s.selected,callback:function(l){t.$set(s,"selected",l)},expression:"props.selected"}})],1),e("td",[t._v(t._s(s.index+1))]),e("td",{staticStyle:{"text-align":"center"}},[s.item.site?e("div",[e("v-avatar",{attrs:{size:"18"}},[e("img",{attrs:{src:s.item.site.icon}})]),e("br"),e("span",{staticClass:"captionText"},[t._v(t._s(s.item.site.name))])],1):t._e()]),e("td",[s.item.data.link?e("a",{attrs:{href:s.item.data.link,target:"_blank",title:s.item.data.title,rel:"noopener noreferrer nofollow"}},[t._v(t._s(s.item.data.title||s.item.data.link))]):e("span",{attrs:{title:s.item.data.url}},[t._v(t._s(s.item.data.title||s.item.data.url))]),e("br"),e("span",{staticClass:"sub-title"},[t._v("[ "+t._s(t.getClientName(s.item.data.clientId||s.item.clientId))+" ] -> "+t._s(s.item.data.savePath||t.$t("history.defaultPath")))])]),e("td",[s.item.success===!1?e("v-icon",{attrs:{color:"error",title:t.$t("history.fail")}},[t._v("close")]):e("v-icon",{attrs:{color:"success",title:t.$t("history.success")}},[t._v("done")])],1),e("td",[t._v(t._s(t._f("formatDate")(s.item.time)))]),e("td",[e("v-btn",{attrs:{icon:"",flat:"",small:"",title:t.$t("history.download")},on:{click:function(l){return t.download(s.item)}}},[e("v-icon",{attrs:{small:""}},[t._v("save_alt")])],1),e("DownloadTo",{staticClass:"mx-0",attrs:{downloadOptions:{host:s.item.host,url:s.item.data.url},flat:"",icon:"",small:""},on:{error:t.onError,success:t.onSuccess}}),e("v-btn",{attrs:{icon:"",flat:"",small:"",color:"error",title:t.$t("common.remove")},on:{click:function(l){return t.removeConfirm(s.item)}}},[e("v-icon",{attrs:{small:""}},[t._v("delete")])],1)],1)]}}]),model:{value:t.selected,callback:function(s){t.selected=s},expression:"selected"}})],1),e("v-dialog",{attrs:{width:"300"},model:{value:t.dialogRemoveConfirm,callback:function(s){t.dialogRemoveConfirm=s},expression:"dialogRemoveConfirm"}},[e("v-card",[e("v-card-title",{staticClass:"headline red lighten-2"},[t._v(t._s(t.$t("history.removeConfirmTitle")))]),e("v-card-text",[t._v(t._s(t.$t("history.removeConfirm")))]),e("v-divider"),e("v-card-actions",[e("v-spacer"),e("v-btn",{attrs:{flat:"",color:"info"},on:{click:function(s){t.dialogRemoveConfirm=!1}}},[e("v-icon",[t._v("cancel")]),e("span",{staticClass:"ml-1"},[t._v(t._s(t.$t("history.cancel")))])],1),e("v-btn",{attrs:{color:"error",flat:""},on:{click:function(s){return t.remove(null)}}},[e("v-icon",[t._v("check_circle_outline")]),e("span",{staticClass:"ml-1"},[t._v(t._s(t.$t("history.ok")))])],1)],1)],1)],1),e("v-snackbar",{attrs:{top:"",timeout:3e3,color:"error"},model:{value:t.haveError,callback:function(s){t.haveError=s},expression:"haveError"}},[t._v(t._s(t.errorMsg))]),e("v-snackbar",{attrs:{bottom:"",timeout:3e3,color:"success"},model:{value:t.haveSuccess,callback:function(s){t.haveSuccess=s},expression:"haveSuccess"}},[t._v(t._s(t.successMsg))])],1)},m=[],u=c(h,v,m,!1,null,"ac42268f",null,null);const g=u.exports;export{g as default};
